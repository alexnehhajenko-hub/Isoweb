<!doctype html><html lang="ru"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ —Ç—Ä—É–± ‚Ä¢ 3D</title>
<style>
  html,body{margin:0;height:100%;background:#0b0b0b;color:#eee;font-family:system-ui,Arial}
  #ui{position:fixed;inset:10px auto auto 10px;display:flex;gap:8px;z-index:10;flex-wrap:wrap}
  .btn{background:#1f1f1f;border:1px solid #333;color:#fff;border-radius:12px;padding:10px 14px;font-weight:600}
  .btn:active{transform:scale(.98)}
  #status{position:fixed;left:10px;bottom:10px;background:rgba(0,0,0,.55);
          border:1px solid #333;border-radius:8px;padding:8px 10px;font-size:13px}
  #file{display:none}
  canvas{display:block}
</style>
</head><body>
<div id="ui">
  <button id="lineBtn" class="btn">–õ–∏–Ω–∏—è</button>
  <button id="undoBtn" class="btn">–ù–∞–∑–∞–¥</button>
  <label class="btn" for="file">üì∑ –§–æ—Ç–æ</label>
  <button id="clearBg" class="btn">üßπ –£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω</button>
  <button id="centerBtn" class="btn">üéØ –¶–µ–Ω—Ç—Ä</button>
</div>
<input id="file" type="file" accept="image/*"/>
<div id="status">–ì–æ—Ç–æ–≤</div>
<script src="https://unpkg.com/three@0.160.1/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.160.1/examples/js/controls/OrbitControls.js"></script>
<script>
(() => {
  // ---------- –±–∞–∑–æ–≤–∞—è —Å—Ü–µ–Ω–∞ ----------
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b0b0b);

  const camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.01, 1000);
  camera.position.set(0, 0, 4);

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(devicePixelRatio);
  renderer.setSize(innerWidth, innerHeight);
  document.body.appendChild(renderer.domElement);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = .08;
  controls.screenSpacePanning = true; // —á—Ç–æ–± –ø–∞–Ω–æ—Ä–∞–º–∏—Ç—å –±–µ–∑ ¬´–ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞–Ω–∏–π¬ª

  // –º—è–≥–∫–∏–π —Å–≤–µ—Ç, —á—Ç–æ–±—ã —Ç—Ä—É–±—ã —Å–º–æ—Ç—Ä–µ–ª–∏—Å—å –æ–±—ä—ë–º–Ω–æ
  const amb = new THREE.AmbientLight(0xffffff, .9);
  scene.add(amb);
  const dir = new THREE.DirectionalLight(0xffffff, .6);
  dir.position.set(1,2,2);
  scene.add(dir);

  // –≥—Ä—É–ø–ø–∞ —Å —Ñ–æ–Ω–æ–º –∏ —Ç—Ä—É–±–∞–º–∏
  const world = new THREE.Group();
  scene.add(world);

  // ---------- –ø–ª–æ—Å–∫–æ—Å—Ç—å —Å —Ñ–æ—Ç–æ (—Ñ–æ–Ω –≤–Ω—É—Ç—Ä–∏ —Å—Ü–µ–Ω—ã) ----------
  let photoMesh = null;
  const loader = new THREE.TextureLoader();
  function setPhotoFromURL(url){
    loader.load(url, (tex)=>{
      tex.colorSpace = THREE.SRGBColorSpace;
      addPhotoPlane(tex.image.naturalWidth||tex.image.width, tex.image.naturalHeight||tex.image.height, tex);
    }, undefined, ()=> setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'));
  }

  function addPhotoPlane(imgW, imgH, texture){
    // —É–¥–∞–ª–∏–º —Å—Ç–∞—Ä–æ–µ —Ñ–æ—Ç–æ
    if(photoMesh){ world.remove(photoMesh); photoMesh.geometry.dispose(); }
    // —Å—á–∏—Ç–∞–µ–º –∞—Å–ø–µ–∫—Ç
    const aspect = imgW / imgH;
    // —Ä–∞–∑–º–µ—Ä –ø–ª–æ—Å–∫–æ—Å—Ç–∏ –≤ –º–∏—Ä–æ–≤—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∞ —Ü–µ–ª–∏–∫–æ–º –≤–ª–∞–∑–∏–ª–∞ –≤ —ç–∫—Ä–∞–Ω
    const baseH = 3;            // ¬´–≤—ã—Å–æ—Ç–∞¬ª —Ñ–æ—Ç–æ –≤ –º–∏—Ä–æ–≤—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö
    const baseW = baseH * aspect;
    const geom = new THREE.PlaneGeometry(baseW, baseH);
    const mat  = new THREE.MeshBasicMaterial({map:texture, transparent:true});
    photoMesh = new THREE.Mesh(geom, mat);
    photoMesh.position.set(0,0,0);       // —Ñ–æ—Ç–æ –≤ –Ω—É–ª–µ
    world.add(photoMesh);

    // –ø–æ—Å—Ç–∞–≤–∏–º –∫–∞–º–µ—Ä—É —Å–ø–µ—Ä–µ–¥–∏ –∏ —á—É—Ç—å –¥–∞–ª—å—à–µ
    camera.position.set(0,0, Math.max(baseW,baseH)*1.2);
    camera.lookAt(0,0,0);
    controls.target.set(0,0,0);
    controls.update();

    // —Å–µ—Ç–∫–∞ –ø–æ–≤–µ—Ä—Ö —Ñ–æ—Ç–æ (–æ—á–µ–Ω—å –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è)
    addOrUpdateGrid(Math.max(baseW, baseH));
  }

  // ---------- —Å–µ—Ç–∫–∞ ----------
  let grid=null;
  function addOrUpdateGrid(size){
    if(grid){ world.remove(grid); grid.geometry.dispose(); }
    const div = 20;
    grid = new THREE.GridHelper(size*1.4, div, 0x4466ff, 0x4466ff);
    grid.rotation.x = Math.PI/2;     // —Å–¥–µ–ª–∞—Ç—å –µ—ë ¬´–ø–ª–æ—Å–∫–æ–π¬ª –ø–æ–≤–µ—Ä—Ö —Ñ–æ—Ç–æ
    grid.material.opacity = .12;
    grid.material.transparent = true;
    grid.position.z = 0.001;         // –Ω–∞ –≤–æ–ª–æ—Å–æ–∫ –±–ª–∏–∂–µ –∫ –∫–∞–º–µ—Ä–µ, —á—Ç–æ–±—ã –Ω–µ –º–µ—Ä—Ü–∞–ª–æ
    world.add(grid);
  }

  // ---------- —Ä–∏—Å–æ–≤–∞–Ω–∏–µ —Ç—Ä—É–± ----------
  const pipesGroup = new THREE.Group();
  world.add(pipesGroup);
  const points = [];
  let drawMode = false;
  let diameterMM = 40;
  const R = () => (diameterMM/1000)/2 || 0.02; // —Ä–∞–¥–∏—É—Å –≤ ¬´–º–µ—Ç—Ä–∞—Ö¬ª —Å—Ü–µ–Ω—ã (–≥—Ä—É–±–æ)

  function addPipeSegment(a,b){
    const path = new THREE.LineCurve3(a,b);
    const geo = new THREE.TubeGeometry(path, 1, R(), 20, false);
    const mat = new THREE.MeshStandardMaterial({color:0x2d6cff, roughness:.35, metalness:.05});
    const tube = new THREE.Mesh(geo, mat);
    pipesGroup.add(tube);

    // ¬´–ø–æ–ª—É–æ—Ç–≤–æ–¥—ã¬ª –Ω–∞ –∫–æ–Ω—Ü–∞—Ö (–Ω–µ–±–æ–ª—å—à–∏–µ —Å—Ñ–µ—Ä–∏—á–µ—Å–∫–∏–µ –∑–∞–≥–ª—É—à–∫–∏)
    const capG = new THREE.SphereGeometry(R(), 16, 16);
    const cap1 = new THREE.Mesh(capG, mat); cap1.position.copy(a); pipesGroup.add(cap1);
    const cap2 = new THREE.Mesh(capG, mat); cap2.position.copy(b); pipesGroup.add(cap2);
  }

  // –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —ç–∫—Ä–∞–Ω–∞ –≤ —Ç–æ—á–∫—É –Ω–∞ –ø–ª–æ—Å–∫–æ—Å—Ç–∏ —Ñ–æ—Ç–æ (z‚âà0)
  const ray = new THREE.Raycaster();
  const ndc = new THREE.Vector2();
  function screenToWorld(x,y){
    ndc.x =  (x / innerWidth ) * 2 - 1;
    ndc.y = -(y / innerHeight) * 2 + 1;
    ray.setFromCamera(ndc, camera);
    if(photoMesh){
      const plane = new THREE.Plane(new THREE.Vector3(0,0,1), 0); // –ø–ª–æ—Å–∫–æ—Å—Ç—å Z=0
      const out = new THREE.Vector3();
      ray.ray.intersectPlane(plane, out);
      return out;
    }
    return null;
  }

  function onPointerDown(e){
    if(!drawMode) return;
    const touch = e.touches ? e.touches[0] : e;
    const p = screenToWorld(touch.clientX, touch.clientY);
    if(!p) return;
    points.push(p.clone());
    if(points.length>=2){
      const a = points[points.length-2];
      const b = points[points.length-1];
      addPipeSegment(a,b);
    }
    setStatus('–¢–æ—á–∫–∞: '+p.x.toFixed(2)+', '+p.y.toFixed(2));
  }

  renderer.domElement.addEventListener('pointerdown', onPointerDown);

  // ---------- –∫–Ω–æ–ø–∫–∏ ----------
  const file = document.getElementById('file');
  file.addEventListener('change', e=>{
    const f = e.target.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    setPhotoFromURL(url);
    setStatus('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
  });

  document.getElementById('clearBg').onclick = ()=>{
    if(photoMesh){ world.remove(photoMesh); photoMesh.geometry.dispose(); photoMesh=null; }
    setStatus('–§–æ–Ω —É–¥–∞–ª—ë–Ω');
  };

  document.getElementById('centerBtn').onclick = ()=>{
    controls.target.set(0,0,0);
    camera.position.set(0,0, camera.position.length());
    controls.update();
    setStatus('–ö–∞–º–µ—Ä–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É');
  };

  document.getElementById('lineBtn').onclick = ()=>{
    drawMode = !drawMode;
    document.getElementById('lineBtn').textContent = drawMode ? '–õ–∏–Ω–∏—è (–≤–∫–ª)' : '–õ–∏–Ω–∏—è';
    setStatus(drawMode? '–†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è: –í–ö–õ' : '–†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è: –í–´–ö–õ');
  };

  document.getElementById('undoBtn').onclick = ()=>{
    // —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç (—Ç—Ä—É–±—É + 2 –∑–∞–≥–ª—É—à–∫–∏)
    const removeN = 3;
    for(let i=0;i<removeN && pipesGroup.children.length;i++){
      const m = pipesGroup.children.pop();
      m.geometry?.dispose?.(); m.material?.dispose?.();
    }
    points.pop();
    setStatus('–®–∞–≥ –æ—Ç–º–µ–Ω—ë–Ω');
  };

  // ---------- —Ä–µ–Ω–¥–µ—Ä ----------
  function animate(){
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene,camera);
  }
  animate();

  // ---------- –ø–æ–º–æ—â–Ω–∏–∫–∏ ----------
  function setStatus(t){ document.getElementById('status').textContent = t; }

  // –Ω–∞—á–∞–ª—å–Ω–æ–µ –º—è–≥–∫–æ–µ —Ñ–æ—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏–µ (–µ—Å–ª–∏ —Å—Ä–∞–∑—É –∑–∞–ª–∏–≤–∞—é—Ç url)
  setStatus('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ (–∫–Ω–æ–ø–∫–∞ ¬´–§–æ—Ç–æ¬ª), –∑–∞—Ç–µ–º –∂–º–∏—Ç–µ ¬´–õ–∏–Ω–∏—è¬ª –∏ —Å—Ç–∞–≤—å—Ç–µ —Ç–æ—á–∫–∏.');
  // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥—Ä—É–∑–∏–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ–æ–Ω, –µ—Å–ª–∏ –±—ã–ª (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
})();
</script>
</body></html>