<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace v816</title>
<style>
  :root{--violet:#8000ff; --violet2:#7618ff}
  html,body{margin:0;height:100%;background:#f2f3f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  canvas{display:block;width:100vw;height:100vh;background:#fff;touch-action:none;user-select:none}

  .hud{position:fixed;top:8px;left:8px;right:8px;z-index:1000;display:flex;gap:8px}
  .hud button{height:40px;border:0;border-radius:12px;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff;font-weight:800;padding:0 12px}

  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#1f1f2e;color:#fff;padding:6px 10px;border-radius:10px;opacity:0;transition:.25s;z-index:1100}
  .toast.show{opacity:1}

  .panel-wrap{position:fixed;inset:0;z-index:1050;display:none}
  .panel-wrap.open{display:block}
  .panel-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.2)}
  .panel{position:absolute;top:60px;right:8px;background:#fff;border:1px solid #e7e3f7;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:12px;width:min(92vw,340px);max-height:80vh;overflow:auto}
  .panel h4{margin:6px 0 8px 0;font-size:15px}
  .row{display:flex;align-items:center;gap:8px;margin:8px 0}
  .row label{min-width:120px;font-size:13px;color:#555}
  .row input[type="range"],.row input[type="color"]{flex:1}
  .close{position:absolute;top:6px;right:8px;line-height:1;border:none;background:transparent;font-size:20px;color:#666}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="hud">
    <button id="btnLine">Линия</button>
    <button id="btnHand">Рука</button>
    <button id="btnUndo">↩</button>
    <button id="btnValve">Вентиль</button>
    <button id="btnValve2">Клапан</button>
    <button id="btnPump">Насос</button>
    <button id="btnPhoto">Фото</button>
    <button id="btnExport">PNG</button>
    <button id="btnSettings">⚙</button>
  </div>

  <input id="fileGallery" type="file" accept="image/*" hidden />

  <div id="toast" class="toast"></div>

  <div id="panelWrap" class="panel-wrap">
    <div id="panelBackdrop" class="panel-backdrop"></div>
    <div class="panel">
      <button id="panelClose" class="close">×</button>
      <h4>Линия</h4>
      <div class="row"><label>Толщина</label><input id="lineWidth" type="range" min="2" max="24" value="6"></div>
      <div class="row"><label>Цвет</label><input id="lineColor" type="color" value="#8000ff"></div>
      <h4>Сетка</h4>
      <div class="row"><label>Показать 3D</label><input id="gridOn" type="checkbox" checked></div>
    </div>
  </div>

<script>
(function(){
  const DPR=Math.min(2,window.devicePixelRatio||1);
  const cv=document.getElementById('cv');
  const ctx=cv.getContext('2d');
  const toastEl=document.getElementById('toast');
  const $=id=>document.getElementById(id);

  let mode='hand';
  let firstPt=null;
  const segs=[];
  const comps=[];
  let lineWidth=6;
  let lineColor='#8000ff';
  let gridOn=true;

  const photo={img:null,w:0,h:0,cx:0,cy:0,s:1};

  function fit(){cv.width=innerWidth*DPR;cv.height=innerHeight*DPR;draw();}
  window.onresize=fit;fit();

  function toast(t){toastEl.textContent=t;toastEl.classList.add('show');setTimeout(()=>toastEl.classList.remove('show'),1200);}

  function screenToWorld(x,y){return{x:(x-photo.cx)/photo.s,y:(y-photo.cy)/photo.s};}
  function worldToScreen(x,y){return{x:photo.cx+x*photo.s,y:photo.cy+y*photo.s};}

  function draw(){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.fillStyle="#fff";ctx.fillRect(0,0,cv.width,cv.height);
    if(photo.img){ctx.drawImage(photo.img,photo.cx-photo.w/2*photo.s,photo.cy-photo.h/2*photo.s,photo.w*photo.s,photo.h*photo.s);}
    if(gridOn) drawGrid();

    ctx.lineCap='round';ctx.lineJoin='round';
    for(const s of segs){
      ctx.strokeStyle=lineColor;ctx.lineWidth=lineWidth;ctx.beginPath();
      const A=worldToScreen(s.a.x,s.a.y),B=worldToScreen(s.b.x,s.b.y);
      ctx.moveTo(A.x,A.y);ctx.lineTo(B.x,B.y);ctx.stroke();
    }

    for(const c of comps){drawComp(c);}
  }

  function drawGrid(){
    ctx.strokeStyle='rgba(0,0,0,0.1)';
    for(let x=0;x<cv.width;x+=100){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,cv.height);ctx.stroke();}
    for(let y=0;y<cv.height;y+=100){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(cv.width,y);ctx.stroke();}
  }

  function drawComp(c){
    const p=worldToScreen(c.x,c.y);
    ctx.save();ctx.translate(p.x,p.y);
    ctx.strokeStyle="#000";ctx.fillStyle="#fff";ctx.lineWidth=2;
    if(c.type==='valve'){
      ctx.strokeRect(-12,-6,24,12);
      ctx.beginPath();ctx.moveTo(-8,-4);ctx.lineTo(0,4);ctx.lineTo(8,-4);ctx.stroke();
      ctx.beginPath();ctx.moveTo(-8,4);ctx.lineTo(0,-4);ctx.lineTo(8,4);ctx.stroke();
      ctx.beginPath();ctx.moveTo(-4,-12);ctx.lineTo(4,-12);ctx.lineTo(0,-18);ctx.closePath();ctx.fill();ctx.stroke();
      ctx.fillText("Вентиль", -16,20);
    }
    if(c.type==='check'){
      ctx.strokeRect(-16,-6,32,12);
      ctx.beginPath();ctx.moveTo(-6,-4);ctx.lineTo(0,0);ctx.lineTo(-6,4);ctx.closePath();ctx.fill();ctx.stroke();
      ctx.beginPath();ctx.moveTo(6,-4);ctx.lineTo(0,0);ctx.lineTo(6,4);ctx.closePath();ctx.fill();ctx.stroke();
      ctx.fillText("Клапан", -16,20);
    }
    if(c.type==='pump'){
      ctx.beginPath();ctx.arc(0,0,14,0,Math.PI*2);ctx.fill();ctx.stroke();
      ctx.fillStyle="#000";ctx.fillText("Насос",-18,28);
    }
    ctx.restore();
  }

  cv.addEventListener('click',e=>{
    const p=screenToWorld(e.clientX*DPR,e.clientY*DPR);
    if(mode==='line'){
      if(!firstPt){firstPt=p;toast('Вторая точка');}
      else{segs.push({a:firstPt,b:p});firstPt=null;mode='hand';draw();}
    }else if(mode==='valve'||mode==='check'||mode==='pump'){
      comps.push({type:mode,x:p.x,y:p.y});mode='hand';draw();
    }
  });

  $('btnLine').onclick=()=>{mode='line';firstPt=null;toast('Линия');};
  $('btnHand').onclick=()=>{mode='hand';};
  $('btnUndo').onclick=()=>{if(segs.length)segs.pop();else if(comps.length)comps.pop();draw();};
  $('btnValve').onclick=()=>{mode='valve';toast('Поставь вентиль');};
  $('btnValve2').onclick=()=>{mode='check';toast('Поставь клапан');};
  $('btnPump').onclick=()=>{mode='pump';toast('Поставь насос');};
  $('btnPhoto').onclick=()=>$('fileGallery').click();
  $('fileGallery').onchange=e=>{
    const file=e.target.files[0];if(!file)return;
    const url=URL.createObjectURL(file);const img=new Image();
    img.onload=()=>{photo.img=img;photo.w=img.width;photo.h=img.height;photo.s=DPR*0.5;photo.cx=cv.width/2;photo.cy=cv.height/2;draw();};
    img.src=url;
  };
  $('btnExport').onclick=()=>{const url=cv.toDataURL('image/png');const a=document.createElement('a');a.href=url;a.download='ProTrace.png';a.click();};

  const wrap=$('panelWrap');
  $('btnSettings').onclick=()=>{wrap.classList.add('open');};
  $('panelClose').onclick=()=>{wrap.classList.remove('open');};
  $('panelBackdrop').onclick=()=>{wrap.classList.remove('open');};

  $('lineWidth').oninput=e=>{lineWidth=+e.target.value;draw();};
  $('lineColor').oninput=e=>{lineColor=e.target.value;draw();};
  $('gridOn').onchange=e=>{gridOn=e.target.checked;draw();};

  draw();
})();
</script>
</body>
</html>