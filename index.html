<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Pipe Draw</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#eee}
  .top{
    position:fixed;top:0;left:0;right:0;z-index:10;
    display:flex;gap:8px;justify-content:center;padding:8px;
    background:#fff;border-bottom:1px solid #ccc
  }
  .btn{padding:6px 12px;border:1px solid #ccc;border-radius:8px;background:#f7f7f7}
  .btn.on{background:#dce6ff;border-color:#88aaff}
  input[type=file]{display:none}
  .stage{position:fixed;inset:48px 0 0 0}
  canvas{width:100%;height:100%;display:block;background:#fff}
  .status{position:fixed;left:8px;bottom:8px;padding:6px 10px;
    background:rgba(0,0,0,.6);color:#fff;border-radius:6px;font-size:13px}
</style>
</head>
<body>
<div class="top">
  <button class="btn" id="lineBtn">Линия</button>
  <button class="btn" id="undoBtn">Назад</button>
  <label class="btn" for="photoInput">Фото</label>
  <input id="photoInput" type="file" accept="image/*"/>
  <button class="btn" id="centerBtn">Центр</button>
</div>
<div class="stage"><canvas id="cv"></canvas></div>
<div class="status" id="status">Готов.</div>

<script>
(()=>{
  const cv=document.getElementById('cv'), ctx=cv.getContext('2d');
  const status=document.getElementById('status');
  const lineBtn=document.getElementById('lineBtn');
  const undoBtn=document.getElementById('undoBtn');
  const centerBtn=document.getElementById('centerBtn');
  const photoInput=document.getElementById('photoInput');

  let view={x:0,y:0,scale:1}; // трансформация сцены
  let pipes=[];
  let drawing=false,startPt=null;
  let bgImg=null;

  function resize(){
    const dpr=window.devicePixelRatio||1;
    cv.width=cv.clientWidth*dpr;
    cv.height=cv.clientHeight*dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
    redraw();
  }
  window.addEventListener('resize',resize);
  resize();

  function worldToScreen(p){
    return {x:p.x*view.scale+view.x, y:p.y*view.scale+view.y};
  }
  function screenToWorld(p){
    return {x:(p.x-view.x)/view.scale, y:(p.y-view.y)/view.scale};
  }

  function redraw(){
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.save();
    ctx.translate(view.x,view.y);
    ctx.scale(view.scale,view.scale);

    if(bgImg) ctx.drawImage(bgImg,-bgImg.width/2,-bgImg.height/2);

    ctx.lineCap="round"; ctx.strokeStyle="#2970ff"; ctx.lineWidth=8/view.scale;
    for(const seg of pipes){
      ctx.beginPath(); ctx.moveTo(seg.a.x,seg.a.y); ctx.lineTo(seg.b.x,seg.b.y); ctx.stroke();
    }
    ctx.restore();
  }

  // жесты
  let drag=false,last={x:0,y:0};
  let pinch=false, startDist=0,startScale=1,startCenter={x:0,y:0},startView={x:0,y:0};

  function getTouches(e){
    const r=cv.getBoundingClientRect();
    return [...e.touches].map(t=>({x:t.clientX-r.left,y:t.clientY-r.top}));
  }

  cv.addEventListener("touchstart",e=>{
    if(e.touches.length===2){
      pinch=true;
      const [p1,p2]=getTouches(e);
      startDist=Math.hypot(p2.x-p1.x,p2.y-p1.y);
      startScale=view.scale;
      startCenter={x:(p1.x+p2.x)/2,y:(p1.y+p2.y)/2};
      startView={...view};
    }else if(e.touches.length===1){drag=true; last=getTouches(e)[0];}
  });
  cv.addEventListener("touchmove",e=>{
    if(pinch && e.touches.length===2){
      e.preventDefault();
      const [p1,p2]=getTouches(e);
      const dist=Math.hypot(p2.x-p1.x,p2.y-p1.y);
      let s=(dist/startDist)*startScale;
      const worldBefore=screenToWorld(startCenter);
      view.scale=s;
      const screenAfter=worldToScreen(worldBefore);
      view.x+=startCenter.x-screenAfter.x;
      view.y+=startCenter.y-screenAfter.y;
      redraw();
    }else if(drag && e.touches.length===1){
      e.preventDefault();
      const p=getTouches(e)[0];
      view.x+=p.x-last.x; view.y+=p.y-last.y;
      last=p; redraw();
    }
  },{passive:false});
  cv.addEventListener("touchend",e=>{
    if(e.touches.length<2)pinch=false;
    if(e.touches.length===0)drag=false;
  });

  // рисование
  cv.addEventListener("click",e=>{
    if(!drawing)return;
    const r=cv.getBoundingClientRect();
    const sp={x:e.clientX-r.left,y:e.clientY-r.top};
    const wp=screenToWorld(sp);
    if(!startPt){
      startPt=wp; status.textContent="Точка A поставлена.";
    }else{
      pipes.push({a:startPt,b:wp});
      startPt=null; drawing=false; lineBtn.classList.remove("on");
      status.textContent="Линия готова.";
      redraw();
    }
  });

  // UI
  lineBtn.onclick=()=>{drawing=!drawing;lineBtn.classList.toggle("on",drawing)};
  undoBtn.onclick=()=>{pipes.pop(); redraw()};
  centerBtn.onclick=()=>{view={x:cv.clientWidth/2,y:cv.clientHeight/2,scale:1}; redraw()};
  photoInput.onchange=e=>{
    const f=e.target.files[0]; if(!f)return;
    const img=new Image(); img.onload=()=>{bgImg=img; redraw()};
    img.src=URL.createObjectURL(f);
  };

  // центр при старте
  view.x=cv.clientWidth/2; view.y=cv.clientHeight/2;
})();
</script>
</body>
</html>