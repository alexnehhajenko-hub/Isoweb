<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace — grid boot with CDN fallback</title>
<style>
  html,body{margin:0;height:100%;background:#111;overflow:hidden}
  #cv{position:fixed;inset:0;width:100vw;height:100vh;display:block;touch-action:none;background:#141414}
  .status{position:fixed;left:8px;bottom:8px;background:rgba(0,0,0,.7);color:#fff;padding:6px 8px;border-radius:8px;font:13px system-ui;max-width:92vw}
</style>
</head>
<body>
  <canvas id="cv"></canvas>
  <div id="status" class="status">Статус: загрузка…</div>

<script>
/* ===== helpers ===== */
const statusEl=document.getElementById('status');
const say=(t)=>statusEl.textContent=t;
const loadScript=(src)=>new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.crossOrigin='anonymous';s.onload=()=>res(src);s.onerror=()=>rej(new Error('fail '+src));document.head.appendChild(s);});

/* ===== fallback: простая 2D-сетка, если WebGL-библиотеки не загрузились ===== */
function start2DGrid(){
  const cv=document.getElementById('cv'); const ctx=cv.getContext('2d');
  function fit(){ cv.width=innerWidth; cv.height=innerHeight; draw(); }
  function draw(){
    ctx.fillStyle='#141414'; ctx.fillRect(0,0,cv.width,cv.height);
    const step=24, off=0.5;
    ctx.strokeStyle='#2a2a2a'; ctx.lineWidth=1;
    ctx.beginPath();
    for(let x=0;x<=cv.width;x+=step){ ctx.moveTo(x+off,0);ctx.lineTo(x+off,cv.height); }
    for(let y=0;y<=cv.height;y+=step){ ctx.moveTo(0,y+off);ctx.lineTo(cv.width,y+off); }
    ctx.stroke();
  }
  addEventListener('resize',fit,{passive:true}); fit();
  say('⚠️ Three.js недоступен — показана 2D-сетка. Интернет/CDN?');
}

/* ===== main boot ===== */
(async ()=>{
  try{
    // 1) сначала jsDelivr
    await loadScript("https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js");
    await loadScript("https://cdn.jsdelivr.net/npm/three@0.160.1/examples/js/controls/OrbitControls.js");
  }catch(e1){
    // 2) пробуем unpkg
    try{
      await loadScript("https://unpkg.com/three@0.160.1/build/three.min.js");
      await loadScript("https://unpkg.com/three@0.160.1/examples/js/controls/OrbitControls.js");
    }catch(e2){
      // 3) оба CDN упали — рисуем 2D
      start2DGrid();
      return;
    }
  }

  if(!window.THREE || !THREE.OrbitControls){ start2DGrid(); return; }

  // ===== минимальная 3D-сцена =====
  const cv=document.getElementById('cv');
  const renderer=new THREE.WebGLRenderer({canvas:cv, antialias:true});
  renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
  renderer.setSize(innerWidth, innerHeight, false);

  const scene=new THREE.Scene(); scene.background=new THREE.Color(0x141414);
  const camera=new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.01, 300);
  camera.position.set(3,2.4,3);

  const controls=new THREE.OrbitControls(camera, cv);
  controls.enableDamping=true; controls.dampingFactor=0.08; controls.target.set(0,0,0);

  scene.add(new THREE.AmbientLight(0xffffff,0.9));
  const dl=new THREE.DirectionalLight(0xffffff,0.7); dl.position.set(2,3,1); scene.add(dl);

  const GRID_STEP=0.2;
  const grid=new THREE.GridHelper(20, 20/GRID_STEP, 0x333333, 0x2f2f2f);
  grid.material.transparent=true; grid.material.opacity=0.95; scene.add(grid);

  function onResize(){ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight, false); }
  addEventListener('resize', onResize, {passive:true});

  (function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); })();
  say('✅ 3D-сетка работает. Пальцами — зум/вращение.');
})();
</script>
</body>
</html>