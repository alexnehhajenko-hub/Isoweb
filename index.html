<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace ‚Äî mini-ok</title>
<style>
  html,body{margin:0;height:100%;background:#f2f3f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  #cv{position:fixed;inset:0;display:block;width:100vw;height:100vh;background:#fff;touch-action:none;-webkit-user-select:none;user-select:none}
  .bar{position:fixed;left:8px;top:8px;z-index:10;display:flex;gap:8px}
  .btn{height:44px;padding:0 14px;border:0;border-radius:12px;background:linear-gradient(180deg,#7c5bff,#6b1dff);color:#fff;font-weight:800}
  .status{position:fixed;left:8px;bottom:8px;background:rgba(0,0,0,.7);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;z-index:11;max-width:92vw}
</style>
</head>
<body>
  <canvas id="cv"></canvas>
  <div class="bar">
    <button id="b1" class="btn">üìê –õ–∏–Ω–∏—è</button>
    <button id="b2" class="btn">–ö—Ä–∞–Ω</button>
    <button id="b3" class="btn">‚Ü© –ù–∞–∑–∞–¥</button>
  </div>
  <div id="st" class="status">–°—Ç–∞—Ç—É—Å: –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

<script>
(()=>{"use strict";
const DPR=Math.max(1,devicePixelRatio||1),cv=document.getElementById('cv'),ctx=cv.getContext('2d',{alpha:false}),st=document.getElementById('st');
window.addEventListener('error',e=>{st.textContent='–°—Ç–∞—Ç—É—Å: –û—à–∏–±–∫–∞ ‚Äî '+(e.message||'unknown');});
function fit(){cv.width=Math.round(innerWidth*DPR);cv.height=Math.round(innerHeight*DPR);need();}
addEventListener('resize',fit,{passive:true});

const segs=[],comps=[],stack=[];let mode='line',first=null,preview=null;const P=10;
function need(){requestAnimationFrame(()=>{ctx.setTransform(1,0,0,1,0,0);ctx.fillStyle='#fff';ctx.fillRect(0,0,cv.width,cv.height);
  ctx.lineCap='round';
  for(const s of segs){ctx.strokeStyle='#1f6bff';ctx.lineWidth=P;ctx.beginPath();ctx.moveTo(s.a.x,s.a.y);ctx.lineTo(s.b.x,s.b.y);ctx.stroke();}
  for(const c of comps){const s=segs[c.i];if(!s)continue;const ax=s.b.x-s.a.x,ay=s.b.y-s.a.y,len=Math.hypot(ax,ay)||1,nx=ax/len,ny=ay/len,x=s.a.x+nx*len*c.t,y=s.a.y+ny*len*c.t;
    ctx.fillStyle='#6b1dff';ctx.strokeStyle='#2b145f';ctx.lineWidth=2;ctx.beginPath();ctx.arc(x,y,P*2,0,7);ctx.fill();ctx.stroke();
    ctx.fillStyle='#000';ctx.font='700 11px system-ui';ctx.fillText('BALL',x+8,y-8);}
  if(first&&preview){ctx.setLineDash([12,8]);ctx.strokeStyle='#1f6bff';ctx.lineWidth=P-2;ctx.beginPath();ctx.moveTo(first.x,first.y);ctx.lineTo(preview.x,preview.y);ctx.stroke();ctx.setLineDash([]);}
});}
function pos(e){const r=cv.getBoundingClientRect();return{x:(e.clientX-r.left)*(cv.width/r.width),y:(e.clientY-r.top)*(cv.height/r.height)}}
function nearSeg(x,y){let bi=-1,bd=1e9,bt=0;for(let i=0;i<segs.length;i++){const s=segs[i],A=s.a,B=s.b,vx=B.x-A.x,vy=B.y-A.y,l2=vx*vx+vy*vy;if(!l2)continue;const t=Math.max(0,Math.min(1,((x-A.x)*vx+(y-A.y)*vy)/l2)),px=A.x+vx*t,py=A.y+vy*t,d=Math.hypot(px-x,py-y);if(d<bd){bd=d;bi=i;bt=t}}return(bi!==-1&&bd<=28*DPR)?{i:bi,t:bt}:null}
cv.addEventListener('pointerdown',e=>{e.preventDefault();const p=pos(e);
  if(mode==='line'){ if(!first){ first=p; preview=null; st.textContent='–°—Ç–∞—Ç—É—Å: –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞'; need(); }
    else{ segs.push({a:first,b:p}); stack.push('seg'); first=null; preview=null; st.textContent='–°—Ç–∞—Ç—É—Å: —Å–µ–≥–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω'; need(); } }
  else{ const n=nearSeg(p.x,p.y); if(n){ comps.push(n); stack.push('comp'); st.textContent='–°—Ç–∞—Ç—É—Å: –∫—Ä–∞–Ω –ø–æ—Å—Ç–∞–≤–ª–µ–Ω'; need(); } else st.textContent='–°—Ç–∞—Ç—É—Å: —Ç–∫–Ω–∏ –ø–æ –ª–∏–Ω–∏–∏'; }
},{passive:false});
cv.addEventListener('pointermove',e=>{ if(mode==='line'&&first){ preview=pos(e); need(); } },{passive:false});
document.getElementById('b1').onclick=()=>{mode='line';first=null;preview=null;st.textContent='–°—Ç–∞—Ç—É—Å: —Ä–µ–∂–∏–º –õ–∏–Ω–∏—è';};
document.getElementById('b2').onclick=()=>{mode='place';st.textContent='–°—Ç–∞—Ç—É—Å: —Ä–µ–∂–∏–º –ö—Ä–∞–Ω ‚Äî —Ç–∫–Ω–∏ –ø–æ –ª–∏–Ω–∏–∏';};
document.getElementById('b3').onclick=()=>{ if(first){first=null;preview=null;need();st.textContent='–°—Ç–∞—Ç—É—Å: —Ç–æ—á–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞';return}
  const t=stack.pop(); if(!t){st.textContent='–°—Ç–∞—Ç—É—Å: –Ω–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å';return} if(t==='seg') segs.pop(); else comps.pop(); need(); st.textContent='–°—Ç–∞—Ç—É—Å: –æ—Ç–º–µ–Ω–µ–Ω–æ'; };
fit(); need(); st.textContent='–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–æ (mini-ok)';})();
</script>
</body>
</html>