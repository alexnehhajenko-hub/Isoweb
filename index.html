<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Isoweb 3D ‚Äî –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</title>
<style>
  html,body{margin:0;height:100%;background:#0e0e0f;font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif;overflow:hidden}
  #status{position:fixed;left:10px;bottom:10px;z-index:10;background:#000a;color:#9fff9f;padding:8px 10px;border-radius:8px;font-size:12px;max-width:90vw;white-space:pre-wrap}
  #menu{position:fixed;left:10px;top:10px;z-index:10;display:flex;gap:8px}
  button{height:40px;padding:0 12px;border:0;border-radius:10px;background:#2b2d34;color:#fff;font-weight:700}
  input[type=file]{display:none}
  canvas{display:block;width:100vw;height:100vh}
</style>
</head>
<body>
  <div id="menu">
    <label><button id="btnPhoto">üì∑ –§–æ—Ç–æ</button><input id="filePhoto" type="file" accept="image/*" capture="environment"></label>
    <button id="btnClear">üßπ –£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω</button>
    <button id="btnCenter">üéØ –¶–µ–Ω—Ç—Ä</button>
  </div>
  <div id="status">–°—Ç–∞—Ç—É—Å: —Å—Ç–∞—Ä—Ç‚Ä¶</div>

<script>
(function(){
  const status = document.getElementById('status');
  const log = (t)=>status.textContent = '–°—Ç–∞—Ç—É—Å: ' + t;

  function addScript(src){
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src = src + (src.includes('?')?'&':'?') + 'v=' + Date.now(); // –∞–Ω—Ç–∏–∫—ç—à
      s.onload = ()=>resolve(src);
      s.onerror = ()=>reject(new Error('fail '+src));
      document.head.appendChild(s);
    });
  }

  async function loadLibs(){
    try{
      log('–≥—Ä—É–∂—É three.js —Å jsDelivr‚Ä¶');
      await addScript('https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js');
    }catch{
      log('jsDelivr three –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –ø—Ä–æ–±—É—é unpkg‚Ä¶');
      await addScript('https://unpkg.com/three@0.160.1/build/three.min.js');
    }
    if(typeof THREE==='undefined'){ throw new Error('THREE –Ω–µ –ø–æ—è–≤–∏–ª—Å—è'); }
    log('three.js –æ–∫. –ì—Ä—É–∂—É OrbitControls‚Ä¶');

    try{
      await addScript('https://cdn.jsdelivr.net/npm/three@0.160.1/examples/js/controls/OrbitControls.js');
    }catch{
      log('jsDelivr OrbitControls –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –ø—Ä–æ–±—É—é unpkg‚Ä¶');
      await addScript('https://unpkg.com/three@0.160.1/examples/js/controls/OrbitControls.js');
    }
    if(!THREE.OrbitControls){ throw new Error('OrbitControls –Ω–µ –ø–æ—è–≤–∏–ª—Å—è'); }
    log('OrbitControls –æ–∫. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é —Å—Ü–µ–Ω—É‚Ä¶');
  }

  let scene, camera, renderer, controls;

  function initScene(){
    const DPR = Math.min(2, Math.max(1, window.devicePixelRatio||1));
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0e0e0f);

    camera = new THREE.PerspectiveCamera(60, 1, 0.1, 2000);
    camera.position.set(12,10,14);

    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(DPR);
    renderer.setSize(innerWidth, innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.HemisphereLight(0xffffff, 0x222233, 0.8));
    const dl = new THREE.DirectionalLight(0xffffff, 0.6); dl.position.set(10,15,8); scene.add(dl);

    const grid = new THREE.GridHelper(100,100,0x3a3a3f,0x1f1f22);
    grid.material.opacity=.6; grid.material.transparent=true;
    scene.add(grid);
    scene.add(new THREE.AxesHelper(2.5));

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.dampingFactor = 0.08; controls.target.set(0,0,0);

    addEventListener('resize', ()=>{
      camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    }, {passive:true});

    // –§–æ—Ç–æ-—Ñ–æ–Ω
    const file = document.getElementById('filePhoto');
    const btnP = document.getElementById('btnPhoto');
    const btnC = document.getElementById('btnClear');
    const btnR = document.getElementById('btnCenter');

    btnP.onclick = ()=> file.click();
    file.onchange = (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ev=>{
        const tex = new THREE.TextureLoader().load(ev.target.result, ()=>{
          if(THREE.SRGBColorSpace) tex.colorSpace = THREE.SRGBColorSpace;
          scene.background = tex;
          log('—Ñ–æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚úÖ');
        }, undefined, ()=>log('–æ—à–∏–±–∫–∞ —Ñ–æ—Ç–æ'));
      };
      reader.readAsDataURL(f);
      e.target.value = '';
    };
    btnC.onclick = ()=>{ scene.background = new THREE.Color(0x0e0e0f); log('—Ñ–æ–Ω —É–¥–∞–ª—ë–Ω'); };
    btnR.onclick = ()=>{ controls.target.set(0,0,0); camera.position.set(12,10,14); controls.update(); log('–∫–∞–º–µ—Ä–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É'); };

    (function loop(){ controls.update(); renderer.render(scene,camera); requestAnimationFrame(loop); })();
    log('3D –∑–∞–≥—Ä—É–∂–µ–Ω–æ ‚úÖ');
  }

  (async function start(){
    try{
      await loadLibs();
      initScene();
    }catch(err){
      console.error(err);
      log('–æ—à–∏–±–∫–∞: '+err.message+'\n–ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –æ—Ç–∫—Ä—ã—Ç—å –≤ –¥—Ä—É–≥–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.');
    }
  })();
})();
</script>
</body>
</html>