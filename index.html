<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <title>Трассировка труб</title>
  <style>
    :root { --uiH: 44px; }
    html,body{margin:0;height:100%;background:#f0f0f0;font-family:system-ui,Arial}
    /* верхняя панель */
    #ui{
      position:fixed; inset:0 0 auto 0; height:var(--uiH);
      display:flex; justify-content:center; gap:8px; align-items:center;
      z-index:10; background:transparent; pointer-events:auto;
    }
    button{
      background:#6a5acd; color:#fff; border:0; border-radius:10px;
      padding:6px 12px; font-size:14px; white-space:nowrap;
    }
    button:active{opacity:.85}
    /* контейнер холста */
    #wrap{
      position:fixed; inset:var(--uiH) 0 0 0; /* ниже панели */
      display:flex; justify-content:center; align-items:center;
      padding:6px;
    }
    canvas{
      width:95vw; height:calc(95vh - var(--uiH));
      border:1px solid #cfcfcf; background:#fff; border-radius:6px;
      touch-action:none; /* отключаем жесты браузера на холсте */
    }
    /* панель настроек */
    #panel{
      position:fixed; right:10px; top:calc(var(--uiH) + 10px);
      background:#fff; border:1px solid #ddd; border-radius:10px;
      box-shadow:0 6px 16px rgba(0,0,0,.08); padding:10px 12px; z-index:15;
      display:none; min-width:220px;
    }
    #panel label{font-size:13px; color:#333; display:block; margin:8px 0 4px}
    #status{
      position:fixed; left:10px; bottom:10px; z-index:20;
      background:rgba(0,0,0,.7); color:#fff; padding:6px 10px;
      border-radius:10px; font-size:13px
    }
  </style>
</head>
<body>
  <div id="ui">
    <button id="lineBtn">Линия</button>
    <button id="undoBtn">Назад</button>
    <button id="centerBtn">Центр</button>
    <button id="saveBtn">Сохранить</button>
    <button id="settingsBtn">Настройки</button>
  </div>

  <div id="wrap">
    <canvas id="cv"></canvas>
  </div>

  <div id="panel">
    <label>Толщина трубы</label>
    <input id="wRange" type="range" min="2" max="40" value="10">
    <label style="margin-top:10px">Фото (фон)</label>
    <input id="bgInput" type="file" accept="image/*">
  </div>

  <div id="status">Режим: ожидание</div>

<script>
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d', { alpha: false });

function fitCanvas(){
  // соответствие CSS-размеров реальным пикселям
  const r = window.devicePixelRatio || 1;
  const cssW = cv.clientWidth, cssH = cv.clientHeight;
  cv.width = Math.round(cssW * r);
  cv.height = Math.round(cssH * r);
  ctx.setTransform(r,0,0,r,0,0);
}
fitCanvas(); addEventListener('resize', fitCanvas);

const pipes = [];
let pipeW = +document.getElementById('wRange').value;
let bgImg = null;

function draw(){
  // фон
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,cv.width,cv.height);
  // картинка
  if(bgImg){
    ctx.drawImage(bgImg, 0,0, cv.width, cv.height);
  }
  // трубы
  ctx.strokeStyle = '#2970ff';
  ctx.lineWidth = pipeW;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  for(const p of pipes){
    ctx.beginPath(); ctx.moveTo(p.x1,p.y1); ctx.lineTo(p.x2,p.y2); ctx.stroke();
  }
  // предпросмотр текущей линии
  if(tempLine){
    ctx.beginPath(); ctx.moveTo(tempLine.x1,tempLine.y1); ctx.lineTo(tempLine.x2,tempLine.y2);
    ctx.stroke();
  }
}
draw();

/* --- режим рисования в 3 шага --- */
let mode = 'idle'; // idle | line
let firstPoint = null; // {x,y}
let tempLine = null;

const statusEl = document.getElementById('status');
function setStatus(t){ statusEl.textContent = t; }

document.getElementById('lineBtn').onclick = ()=>{
  mode = 'line'; firstPoint = null; tempLine = null;
  setStatus('Режим: линия. Тапни первую точку');
};

document.getElementById('undoBtn').onclick = ()=>{
  pipes.pop(); tempLine=null; draw();
  setStatus('Отменено. Трубы: ' + pipes.length);
};

document.getElementById('centerBtn').onclick = ()=>{
  // пока просто перерисовка (к центрированию вернёмся, когда добавим панорамирование)
  draw(); setStatus('Центр');
};

document.getElementById('saveBtn').onclick = ()=>{
  const a = document.createElement('a');
  a.download = 'pipes.png'; a.href = cv.toDataURL('image/png'); a.click();
  setStatus('Сохранено PNG');
};

const panel = document.getElementById('panel');
document.getElementById('settingsBtn').onclick = ()=>{
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
};

document.getElementById('wRange').oninput = (e)=>{
  pipeW = +e.target.value; draw();
};

document.getElementById('bgInput').onchange = (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const img = new Image(); img.onload = ()=>{ bgImg = img; draw(); };
  img.src = URL.createObjectURL(f);
};

/* --- мобильные pointer-события --- */
cv.style.touchAction = 'none'; // отключаем скролл/зум браузера поверх холста
cv.addEventListener('pointerdown', pointerTap);
cv.addEventListener('pointermove', pointerMove);
cv.addEventListener('pointerup', pointerUp);
cv.addEventListener('pointercancel', ()=>{ tempLine=null; });

function canvasXY(e){
  const r = cv.getBoundingClientRect();
  return { x: e.clientX - r.left, y: e.clientY - r.top };
}

function pointerTap(e){
  if(mode !== 'line') return;
  const {x,y} = canvasXY(e);
  if(!firstPoint){
    firstPoint = {x,y};
    tempLine = {x1:x, y1:y, x2:x, y2:y};
    setStatus('Первая точка есть. Тапни вторую.');
  }else{
    pipes.push({x1:firstPoint.x, y1:firstPoint.y, x2:x, y2:y});
    firstPoint = null; tempLine = null;
    setStatus('Линия готова. Для новой — «Линия».');
    draw();
  }
}

function pointerMove(e){
  if(firstPoint){
    const {x,y} = canvasXY(e);
    tempLine = {x1:firstPoint.x, y1:firstPoint.y, x2:x, y2:y};
    draw();
  }
}

function pointerUp(){ /* без действий */ }

/* — полностью убираем double-tap zoom — */
document.addEventListener('dblclick', (e)=>e.preventDefault(), {passive:false});
</script>
</body>
</html>