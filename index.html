<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Pro Trace — только тапами</title>
<style>
  html,body{margin:0;height:100%;background:#0f1115;color:#eef2f7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  #wrap{position:fixed;inset:0;overflow:hidden;background:#0f1115}
  #c{position:absolute;inset:0;touch-action:none}
  .bar{position:fixed;left:10px;top:10px;display:flex;gap:8px;z-index:10}
  .btn{background:#1c1f26;border:1px solid #2e3340;color:#eef2f7;padding:10px 14px;border-radius:12px;font-weight:600}
  .btn.active{outline:2px solid #6aa6ff}
  #gear{position:fixed;right:10px;top:10px;z-index:11}
  #panel{position:fixed;right:10px;top:58px;width:300px;max-width:92vw;background:rgba(24,26,33,.95);
         border:1px solid #2e3340;border-radius:14px;padding:12px;box-shadow:0 14px 36px rgba(0,0,0,.35);display:none;z-index:12}
  #panel h3{margin:0 0 8px}
  #panel .row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:10px 0}
  #panel input[type=range]{width:180px}
  #status{position:fixed;left:10px;bottom:10px;background:rgba(0,0,0,.6);padding:8px 12px;border-radius:10px;border:1px solid #2e3340;font-size:14px}
  #file{display:none}
</style>
</head>
<body>
  <div id="wrap">
    <canvas id="c"></canvas>
  </div>

  <div class="bar">
    <button id="btnLine" class="btn">Линия</button>
    <button id="btnUndo" class="btn">Назад</button>
    <button id="btnPhoto" class="btn">Фото</button>
    <button id="btnCenter" class="btn">Центр</button>
    <button id="btnSave" class="btn">Сохранить</button>
  </div>
  <button id="gear" class="btn" title="Параметры">⚙</button>
  <div id="panel">
    <h3>Параметры</h3>
    <div class="row"><span>Ø, мм</span><input id="diam" type="range" min="10" max="200" value="40"><b id="dVal">40</b></div>
    <div class="row"><span>Сетка</span><input id="grid" type="range" min="10" max="120" value="40"><b id="gVal">40</b></div>
    <div class="row"><label style="display:flex;gap:8px;align-items:center"><input id="snap" type="checkbox" checked> Магнит 0/45/90°</label></div>
  </div>

  <input id="file" type="file" accept="image/*"/>

  <div id="status">Готов: Линия → 1-й тап → 2-й тап</div>

<script>
(()=>{
// ===== состояние
const state = {
  // трансформация (для фото, сетки и труб — всё вместе)
  scale: 1, ox: 0, oy: 0,
  minScale: .2, maxScale: 6,
  // фон
  img: null, iw: 0, ih: 0, // размеры исходного изображения
  // рисование
  pipe: 40, grid: 40, snap: true,
  segments: [],            // {a:{x,y}, b:{x,y}}
  drawing: false,
  firstPt: null,
  // распознавание «тапа»
  tap: {downX:0,downY:0, downT:0, moved:false}
};

// ===== ссылки
const cvs = document.getElementById('c'); const ctx = cvs.getContext('2d');
const btnLine = document.getElementById('btnLine');
const btnUndo = document.getElementById('btnUndo');
const btnPhoto= document.getElementById('btnPhoto');
const btnCenter=document.getElementById('btnCenter');
const btnSave = document.getElementById('btnSave');
const gear    = document.getElementById('gear');
const panel   = document.getElementById('panel');
const fileInp = document.getElementById('file');
const diamInp = document.getElementById('diam'); const dVal = document.getElementById('dVal');
const gridInp = document.getElementById('grid'); const gVal = document.getElementById('gVal');
const snapInp = document.getElementById('snap');
const statusEl= document.getElementById('status');

// ===== утилиты
const setStatus = t => statusEl.textContent = 'Статус: ' + t;
function resize(){
  const dpr = Math.max(1, devicePixelRatio||1);
  const w = innerWidth, h = innerHeight;
  cvs.width = Math.round(w*dpr); cvs.height = Math.round(h*dpr);
  cvs.style.width = w+'px'; cvs.style.height = h+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
  draw();
}
addEventListener('resize', resize, {passive:true});

// экраны↔мир
const toWorld = (x,y)=>({ x:(x - state.ox)/state.scale, y:(y - state.oy)/state.scale });
const toScreen= (x,y)=>({ x:x*state.scale + state.ox,   y:y*state.scale + state.oy   });

// магнит 0/45/90
function snapTo(base, p){
  if(!state.snap || !base) return p;
  const dx=p.x-base.x, dy=p.y-base.y;
  const ang=Math.atan2(dy,dx), len=Math.hypot(dx,dy);
  const step=Math.PI/4, s=Math.round(ang/step)*step;
  return {x: base.x + Math.cos(s)*len, y: base.y + Math.sin(s)*len};
}

// ===== рендер
function drawBG(){
  if(!state.img) return;
  const p = toScreen(0,0);
  ctx.drawImage(state.img, p.x, p.y, state.iw*state.scale, state.ih*state.scale);
}
function drawGrid(){
  const step = state.grid*state.scale;
  if(step<8) return;
  ctx.save();
  ctx.strokeStyle='rgba(255,255,255,.12)'; ctx.lineWidth=1;
  const x0 = ((state.ox%step)+step)%step, y0 = ((state.oy%step)+step)%step;
  for(let x=x0; x<cvs.width; x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,cvs.height); ctx.stroke(); }
  for(let y=y0; y<cvs.height;y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(cvs.width,y); ctx.stroke(); }
  ctx.restore();
}
function drawPipes(){
  ctx.lineCap='round'; ctx.lineJoin='round';
  const w = Math.max(2, state.pipe * state.scale * 0.45);
  for(const s of state.segments){
    const a=toScreen(s.a.x,s.a.y), b=toScreen(s.b.x,s.b.y);
    // тень
    ctx.strokeStyle='rgba(0,0,0,.28)'; ctx.lineWidth=w+4;
    ctx.beginPath(); ctx.moveTo(a.x+1.5,a.y+1.5); ctx.lineTo(b.x+1.5,b.y+1.5); ctx.stroke();
    // труба
    ctx.strokeStyle='#4da3ff'; ctx.lineWidth=w;
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
    // торцы
    ctx.fillStyle='#4da3ff'; const r=w/2;
    ctx.beginPath(); ctx.arc(a.x,a.y,r,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(b.x,b.y,r,0,Math.PI*2); ctx.fill();
  }
  // первая точка — красная метка
  if(state.drawing && state.firstPt){
    const s = toScreen(state.firstPt.x,state.firstPt.y);
    ctx.fillStyle='#ff6666'; ctx.beginPath(); ctx.arc(s.x,s.y,6,0,Math.PI*2); ctx.fill();
  }
}
function draw(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  drawBG();
  drawGrid();
  drawPipes();
}

// ===== зум/пан (ТОЛЬКО двумя пальцами, чтобы не мешать тапам)
let pinch=null;
function pinchBegin(p1,p2){
  pinch={ d:Math.hypot(p2.x-p1.x,p2.y-p1.y),
          cx:(p1.x+p2.x)/2, cy:(p1.y+p2.y)/2,
          ox:state.ox, oy:state.oy, sc:state.scale };
}
function pinchMove(p1,p2){
  if(!pinch) return;
  const d=Math.hypot(p2.x-p1.x,p2.y-p1.y);
  let s = Math.min(state.maxScale, Math.max(state.minScale, pinch.sc * (d/pinch.d)));
  const wx = (pinch.cx - pinch.ox)/pinch.sc;
  const wy = (pinch.cy - pinch.oy)/pinch.sc;
  state.scale = s;
  state.ox = pinch.cx - wx*s;
  state.oy = pinch.cy - wy*s;
  draw();
}
function pinchEnd(){ pinch=null; }

// ===== только ТАПЫ для линии
const TAP_MOVE = 12;    // px
const TAP_TIME = 350;   // ms

cvs.addEventListener('pointerdown', e=>{
  cvs.setPointerCapture(e.pointerId);
  if(e.pointerType==='touch' && e.isPrimary===false) return; // второй палец — игнор здесь
  state.tap.downX = e.clientX; state.tap.downY = e.clientY; state.tap.downT = performance.now(); state.tap.moved = false;
}, {passive:false});

cvs.addEventListener('pointermove', e=>{
  // если два пальца — это зум/пан
  // на pointer API трудно отследить количество, поэтому поддержим touch события отдельно
  if(Math.hypot(e.clientX - state.tap.downX, e.clientY - state.tap.downY) > TAP_MOVE){
    state.tap.moved = true;
  }
}, {passive:false});

cvs.addEventListener('pointerup', e=>{
  const dt = performance.now() - state.tap.downT;
  const moved = state.tap.moved;
  const isTap = dt <= TAP_TIME && !moved;

  if(isTap){
    const w = toWorld(e.clientX, e.clientY);
    if(state.drawing===false){
      // не в режиме — игнор (нужно нажать «Линия»)
      return;
    }
    if(!state.firstPt){
      state.firstPt = w;
      setStatus('1-я точка есть. Ткни вторую.');
      draw();
    }else{
      const end = snapTo(state.firstPt, w);
      state.segments.push({a:{...state.firstPt}, b:{...end}});
      state.firstPt = null;
      state.drawing = false;
      btnLine.classList.remove('active');
      setStatus('Линия готова. Для новой снова нажми «Линия».');
      draw();
    }
  }
}, {passive:false});

// поддержка жестов два пальца для зума/пана через touch
let touchCache = new Map();
cvs.addEventListener('touchstart', e=>{
  for(const t of e.changedTouches) touchCache.set(t.identifier, {x:t.clientX,y:t.clientY});
  if(touchCache.size===2){
    const [a,b] = [...touchCache.values()];
    pinchBegin(a,b);
  }
}, {passive:false});
cvs.addEventListener('touchmove', e=>{
  for(const t of e.changedTouches) touchCache.set(t.identifier,{x:t.clientX,y:t.clientY});
  if(touchCache.size===2){
    const [a,b] = [...touchCache.values()];
    pinchMove(a,b); e.preventDefault();
  }
}, {passive:false});
cvs.addEventListener('touchend', e=>{
  for(const t of e.changedTouches) touchCache.delete(t.identifier);
  if(touchCache.size<2) pinchEnd();
}, {passive:false});
cvs.addEventListener('touchcancel', e=>{
  for(const t of e.changedTouches) touchCache.delete(t.identifier);
  pinchEnd();
}, {passive:false});

// ===== кнопки
btnLine.onclick = ()=>{
  state.drawing = !state.drawing;
  state.firstPt = null;
  btnLine.classList.toggle('active', state.drawing);
  setStatus(state.drawing ? 'Режим ЛИНИЯ: ткни 1-ю точку' : 'Готов');
};
btnUndo.onclick = ()=>{
  if(state.firstPt){ state.firstPt=null; setStatus('Старт снят'); draw(); return; }
  state.segments.pop(); draw(); setStatus('Отменено');
};
btnCenter.onclick = ()=>{
  // вписать изображение/сцену
  if(state.img){
    const k = Math.min(innerWidth/state.iw, innerHeight/state.ih)*0.95;
    state.scale = Math.min(state.maxScale, Math.max(state.minScale, k));
    state.ox = (innerWidth - state.iw*state.scale)/2;
    state.oy = (innerHeight- state.ih*state.scale)/2;
  }else{
    state.scale=1; state.ox=innerWidth/2; state.oy=innerHeight/2;
  }
  draw(); setStatus('По центру');
};
btnSave.onclick = ()=>{
  const off = document.createElement('canvas');
  off.width = cvs.width; off.height = cvs.height;
  const octx = off.getContext('2d');
  // без DPR т.к. уже учтён в cvs
  // Скопируем текущий кадр
  octx.drawImage(cvs,0,0);
  const a = document.createElement('a');
  a.href = off.toDataURL('image/png'); a.download='trace.png'; a.click();
};
btnPhoto.onclick = ()=> fileInp.click();
fileInp.onchange = e=>{
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  const img = new Image();
  img.onload = ()=>{
    state.img = img; state.iw = img.naturalWidth; state.ih = img.naturalHeight;
    // вписать
    const k = Math.min(innerWidth/state.iw, innerHeight/state.ih)*0.95;
    state.scale = Math.min(state.maxScale, Math.max(state.minScale, k));
    state.ox = (innerWidth - state.iw*state.scale)/2;
    state.oy = (innerHeight- state.ih*state.scale)/2;
    draw(); setStatus('Фото загружено');
  };
  img.src = url;
};

gear.onclick = ()=>{
  panel.style.display = panel.style.display==='none' ? 'block' : 'none';
};
document.addEventListener('pointerdown', e=>{
  if(panel.style.display!=='none' && !panel.contains(e.target) && e.target!==gear){
    panel.style.display='none';
  }
});

diamInp.oninput = ()=>{ state.pipe = +diamInp.value; dVal.textContent=diamInp.value; draw(); };
gridInp.oninput = ()=>{ state.grid = +gridInp.value; gVal.textContent=gridInp.value; draw(); };
snapInp.onchange = ()=>{ state.snap = snapInp.checked; };

// старт
resize();
setStatus('Готов: Линия → 1-й тап → 2-й тап. Пинч-зум и пан — двумя пальцами.');
})();
</script>
</body>
</html>