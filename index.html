<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace ‚Äî tap-tap –ª–∏–Ω–∏–∏ (v740)</title>
<style>
  :root{--violet:#8000ff; --violet2:#6b1dff; --border:#e7e3f7}
  html,body{margin:0;height:100%;background:#f2f3f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  canvas{display:block;width:100vw;height:100vh;background:#fff;touch-action:none;user-select:none;-webkit-user-select:none}

  .bar{position:fixed;left:8px;right:8px;top:8px;z-index:1000;display:flex;gap:8px;flex-wrap:wrap}
  .btn{height:42px;padding:0 14px;border:0;border-radius:12px;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff;font-weight:800}
  .btn.ghost{background:linear-gradient(180deg,#8c8c8c,#6a6a6a)}

  .pop{position:fixed;top:56px;right:8px;z-index:1001;background:#fff;border:1px solid var(--border);
       border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:10px;display:none;width:min(92vw,360px)}
  .pop.show{display:block}
  .row{display:flex;align-items:center;gap:10px;margin:8px 0}
  .row label{min-width:170px;font-size:13px;color:#555}
  .row input[type="range"]{flex:1;appearance:none;height:6px;border-radius:999px;background:#eee}
  .row input[type="range"]::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:var(--violet)}
  .row .val{width:44px;text-align:right;font-size:12px;color:#666}

  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#1f1f2e;color:#fff;padding:10px 12px;border-radius:12px;opacity:0;transition:.25s;z-index:1100;pointer-events:none}
  .toast.show{opacity:1}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="bar">
    <button id="btnLine" class="btn">üìê –õ–∏–Ω–∏—è</button>
    <button id="btnHand" class="btn ghost">üñê –†—É–∫–∞</button>
    <label class="btn ghost" style="position:relative">üì∑ –ö–∞–º–µ—Ä–∞
      <input id="fileCam" type="file" accept="image/*" capture="environment" style="position:absolute;inset:0;opacity:0">
    </label>
    <label class="btn ghost" style="position:relative">üìÇ –ì–∞–ª–µ—Ä–µ—è
      <input id="fileGal" type="file" accept="image/*" style="position:absolute;inset:0;opacity:0">
    </label>
    <button id="btnUndo" class="btn ghost">‚Ü© –ù–∞–∑–∞–¥</button>
    <button id="btnExport" class="btn ghost">‚§ì PNG</button>
    <button id="btnThickness" class="btn ghost">‚öô –¢–æ–ª—â–∏–Ω–∞</button>
  </div>

  <div id="thPop" class="pop" role="dialog" aria-modal="true" aria-label="–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏">
    <div class="row">
      <label>–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏ (px)</label>
      <input id="linePx" type="range" min="2" max="24" value="10">
      <span id="linePxVal" class="val">10</span>
    </div>
    <p style="margin:8px 0 0;font-size:12px;color:#666">–¢–æ—á–∫–∏ —Å—Ç–∞–≤—è—Ç—Å—è <b>—Ç–∞–ø-—Ç–∞–ø</b>. –ó—É–º/–ø–∞–Ω ‚Äî <b>–¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏</b>.</p>
  </div>

  <div id="toast" class="toast"></div>

<script>
(()=>{
  const toast=(t,ms=1500)=>{const el=document.getElementById('toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),ms);};
  window.addEventListener('error',ev=>{console.error(ev.error||ev.message);toast('–û—à–∏–±–∫–∞: '+(ev?.message||'unknown'));});
  window.addEventListener('unhandledrejection',ev=>{console.error(ev.reason);toast('–û—à–∏–±–∫–∞: '+(ev?.reason?.message||'promise'));});

  const DPR = Math.max(1, window.devicePixelRatio||1);
  const cv=document.getElementById('cv');
  const ctx=cv.getContext('2d',{alpha:false});

  function getCanvasPointXY(clientX, clientY){
    const r=cv.getBoundingClientRect();
    return {
      sx:(clientX - r.left) * (cv.width  / r.width),
      sy:(clientY - r.top ) * (cv.height / r.height)
    };
  }

  const view={scale:1,tx:0,ty:0};
  let bg=null,bw=0,bh=0;
  const segs=[]; 
  let mode='hand';
  let first=null, prev=null; // –ø–µ—Ä–≤–∞—è –∏ –ø—Ä–µ–≤—å—é
  const params={ linePx:10 };

  function fit(){
    cv.width=Math.round(innerWidth*DPR);
    cv.height=Math.round(innerHeight*DPR);
    if(bg && view.scale===1 && view.tx===0 && view.ty===0){
      const k=Math.min(cv.width/bw, cv.height/bh);
      view.scale=k; view.tx=(cv.width-bw*k)/2; view.ty=(cv.height-bh*k)/2;
    }
    need();
  }
  addEventListener('resize',fit);

  const s2w=(sx,sy)=>({x:(sx-view.tx)/view.scale, y:(sy-view.ty)/view.scale});
  const w2s=(x,y)=>({x:x*view.scale+view.tx, y:y*view.scale+view.ty});

  function draw(){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,cv.width,cv.height);
    if(bg){ ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty); ctx.drawImage(bg,0,0,bw,bh); }

    ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);

    // —Å–µ–≥–º–µ–Ω—Ç—ã
    for(const s of segs){
      ctx.strokeStyle='#5b00bf'; ctx.globalAlpha=.7; ctx.lineWidth=(params.linePx+2)/view.scale;
      ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
      ctx.strokeStyle='#8000ff'; ctx.globalAlpha=1; ctx.lineWidth=(params.linePx)/view.scale;
      ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
    }

    // –º–∞—Ä–∫–µ—Ä –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–∏
    if(first){
      const p=w2s(first.x,first.y); ctx.setTransform(1,0,0,1,0,0);
      ctx.fillStyle='#ff3b30'; ctx.strokeStyle='#ffffff'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(p.x,p.y,7,0,Math.PI*2); ctx.fill(); ctx.stroke();
      ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);
    }

    // –ø—Ä–µ–≤—å—é
    if(first && prev){
      ctx.setLineDash([12/view.scale,8/view.scale]);
      ctx.strokeStyle='#16a34a'; ctx.lineWidth=Math.max(3,params.linePx-2)/view.scale;
      ctx.beginPath(); ctx.moveTo(first.x,first.y); ctx.lineTo(prev.x,prev.y); ctx.stroke();
      ctx.setLineDash([]);
      const p=w2s(prev.x,prev.y); ctx.setTransform(1,0,0,1,0,0);
      ctx.fillStyle='#16a34a'; ctx.beginPath(); ctx.arc(p.x,p.y,6,0,Math.PI*2); ctx.fill();
    }
  }
  let raf=0,dirty=false; const need=()=>{dirty=true;if(!raf){raf=requestAnimationFrame(()=>{raf=0;if(dirty){dirty=false;draw();}})}};

  // ====== –ñ–ï–°–¢–´ (—Ç–∞—á) ======
  let touches=new Map();
  let prevCenter=null, prevDist=null;

  // –¥–µ—Ç–µ–∫—Ç–æ—Ä ¬´—Ç–∞–ø–∞¬ª: –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ—á—Ç–∏ –±–µ–∑ –¥–≤–∏–∂–µ–Ω–∏—è
  const TAP_MAX_TIME=300;     // –º—Å
  const TAP_MAX_MOVE=14*DPR;  // –ø–∏–∫—Å–µ–ª–µ–π —ç–∫—Ä–∞–Ω–∞
  const downs=new Map();      // id -> {t0,sx,sy}

  const touchCount=()=>touches.size;
  const centroid=()=>{
    const arr=[...touches.values()]; if(!arr.length) return null;
    let sx=0,sy=0; for(const t of arr){ sx+=t.sx; sy+=t.sy; } return {sx:sx/arr.length, sy:sy/arr.length};
  };
  const distance2=(a,b)=>Math.hypot(a.sx-b.sx, a.sy-b.sy);

  cv.addEventListener('touchstart', e=>{
    e.preventDefault();
    const now=performance.now();
    for(const t of e.changedTouches){
      const {sx,sy}=getCanvasPointXY(t.clientX,t.clientY);
      touches.set(t.identifier,{sx,sy});
      downs.set(t.identifier,{t0:now,sx,sy});
    }
    if(touchCount()===2){
      const arr=[...touches.values()];
      prevCenter=centroid(); prevDist=distance2(arr[0],arr[1]);
    }
    // –í–ê–ñ–ù–û: –ø–µ—Ä–≤—É—é —Ç–æ—á–∫—É —Ç–µ–ø–µ—Ä—å —Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ –Ω–∞ ¬´—Ç–∞–ø¬ª –≤ touchend, –∞ –Ω–µ –Ω–∞ touchstart.
  }, {passive:false});

  cv.addEventListener('touchmove', e=>{
    e.preventDefault();
    for(const t of e.changedTouches){
      if(!touches.has(t.identifier)) continue;
      const {sx,sy}=getCanvasPointXY(t.clientX,t.clientY);
      touches.set(t.identifier,{sx,sy});
    }

    // pinch (–º–∞—Å—à—Ç–∞–±+–ø–∞–Ω) –¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏
    if(touchCount()===2){
      const arr=[...touches.values()];
      const nowCenter=centroid();
      const nowDist=distance2(arr[0],arr[1]);
      if(prevCenter && prevDist){
        const k = nowDist>0 && prevDist>0 ? (nowDist/prevDist) : 1;
        view.tx = prevCenter.sx - k*(prevCenter.sx - view.tx);
        view.ty = prevCenter.sy - k*(prevCenter.sy - view.ty);
        view.scale = Math.max(0.2, Math.min(8, view.scale*k));
        view.tx += (nowCenter.sx - prevCenter.sx);
        view.ty += (nowCenter.sy - prevCenter.sy);
        need();
      }
      prevCenter=nowCenter; prevDist=nowDist;
      return;
    }

    // –æ–¥–Ω–æ –∫–∞—Å–∞–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –ø—Ä–µ–≤—å—é, –µ—Å–ª–∏ –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞ —É–∂–µ –µ—Å—Ç—å
    if(touchCount()===1){
      const only=[...touches.values()][0];
      if(mode==='line' && first){
        prev = s2w(only.sx, only.sy);
        need();
      }
    }
  }, {passive:false});

  cv.addEventListener('touchend', e=>{
    e.preventDefault();
    const now=performance.now();

    for(const t of e.changedTouches){
      const down=downs.get(t.identifier);
      const {sx,sy}=getCanvasPointXY(t.clientX,t.clientY);
      const isTap = !!down && (now - down.t0 <= TAP_MAX_TIME) && (Math.hypot(sx-down.sx, sy-down.sy) <= TAP_MAX_MOVE);

      if(isTap && mode==='line'){
        const W = s2w(sx,sy);
        if(!first){
          // –ø–µ—Ä–≤—ã–π –¢–ê–ü ‚Äî —Å—Ç–∞–≤–∏–º –ø–µ—Ä–≤—É—é —Ç–æ—á–∫—É
          first = W; prev=null; need();
        }else{
          // –≤—Ç–æ—Ä–æ–π –¢–ê–ü ‚Äî —Ä–∏—Å—É–µ–º —Å–µ–≥–º–µ–Ω—Ç –∏ –í–û–ó–í–†–ê–©–ê–ï–ú–°–Ø –≤ ¬´–†—É–∫—É¬ª
          segs.push({a:first,b:W});
          first=null; prev=null; need();
          mode='hand';
          toast('–°–µ–≥–º–µ–Ω—Ç –≥–æ—Ç–æ–≤. –î–ª—è –Ω–æ–≤–æ–π –ª–∏–Ω–∏–∏ –æ–ø—è—Ç—å –Ω–∞–∂–º–∏ ¬´–õ–∏–Ω–∏—è¬ª.');
        }
      }

      // —É–±–æ—Ä–∫–∞ —Å–ª–µ–¥–æ–≤
      downs.delete(t.identifier);
      touches.delete(t.identifier);
    }

    if(touchCount()<2){ prevCenter=null; prevDist=null; }
  }, {passive:false});

  cv.addEventListener('touchcancel', e=>{
    e.preventDefault();
    for(const t of e.changedTouches){ downs.delete(t.identifier); touches.delete(t.identifier); }
    if(touchCount()<2){ prevCenter=null; prevDist=null; }
  }, {passive:false});

  // ===== –ú–´–®–¨ (desktop) =====
  const hasTouch='ontouchstart' in window;
  if(!hasTouch){
    cv.addEventListener('wheel', e=>{
      e.preventDefault();
      const {sx,sy}=getCanvasPointXY(e.clientX,e.clientY);
      const k=e.deltaY<0?1.12:0.9;
      view.tx = sx - k*(sx - view.tx);
      view.ty = sy - k*(sy - view.ty);
      view.scale = Math.max(0.2, Math.min(8, view.scale*k));
      need();
    }, {passive:false});

    let down=false, downPos=null, downTime=0;
    const MOUSE_TAP_MOVE=6*DPR, MOUSE_TAP_TIME=400;
    cv.addEventListener('mousedown', e=>{
      down=true; downTime=performance.now();
      const {sx,sy}=getCanvasPointXY(e.clientX,e.clientY); downPos={sx,sy};
    });
    cv.addEventListener('mousemove', e=>{
      if(!down || !first || mode!=='line') return;
      const {sx,sy}=getCanvasPointXY(e.clientX,e.clientY); prev=s2w(sx,sy); need();
    });
    addEventListener('mouseup', e=>{
      if(!down) return; down=false;
      const {sx,sy}=getCanvasPointXY(e.clientX,e.clientY);
      const isTap = (performance.now()-downTime<=MOUSE_TAP_TIME) && (Math.hypot(sx-downPos.sx, sy-downPos.sy)<=MOUSE_TAP_MOVE);
      if(isTap && mode==='line'){
        const W=s2w(sx,sy);
        if(!first){ first=W; prev=null; need(); }
        else{ segs.push({a:first,b:W}); first=null; prev=null; need(); mode='hand'; toast('–°–µ–≥–º–µ–Ω—Ç –≥–æ—Ç–æ–≤. –ù–∞–∂–º–∏ ¬´–õ–∏–Ω–∏—è¬ª –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ.'); }
      }
    });
  }

  // ===== –ö–ù–û–ü–ö–ò =====
  const $=id=>document.getElementById(id);
  $('btnLine').onclick=()=>{mode='line'; first=null; prev=null; toast('–†–µ–∂–∏–º: –ª–∏–Ω–∏—è (—Ç–∞–ø-—Ç–∞–ø)');};
  $('btnHand').onclick=()=>{mode='hand'; first=null; prev=null; toast('–†–µ–∂–∏–º: —Ä—É–∫–∞ (–ø–∞–Ω/–∑—É–º ‚Äî 2 –ø–∞–ª—å—Ü–∞)');};
  $('btnUndo').onclick=()=>{ if(first){first=null;prev=null;} else segs.pop(); need(); };
  $('btnExport').onclick=()=>{ const url=cv.toDataURL('image/png',0.95); const a=document.createElement('a'); a.href=url; a.download='ProTrace.png'; a.click(); };

  const loadImageFile=f=>{
    if(!f) return;
    const img=new Image(); img.onload=()=>{
      const maxSide=Math.max(img.naturalWidth,img.naturalHeight);
      let w=img.naturalWidth,h=img.naturalHeight;
      if(maxSide>2200){ const sc=2200/maxSide; w=Math.round(w*sc); h=Math.round(h*sc); }
      const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d',{alpha:false}).drawImage(img,0,0,w,h);
      bg=c; bw=w; bh=h;
      const k=Math.min(cv.width/bw, cv.height/bh); view.scale=k; view.tx=(cv.width-bw*k)/2; view.ty=(cv.height-bh*k)/2;
      need(); toast('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
    };
    img.src=URL.createObjectURL(f);
  };
  $('fileCam').onchange=e=>loadImageFile(e.target.files?.[0]);
  $('fileGal').onchange=e=>loadImageFile(e.target.files?.[0]);

  const thPop=document.getElementById('thPop');
  const lineRange=document.getElementById('linePx');
  const lineVal=document.getElementById('linePxVal');
  function togglePop(){ thPop.classList.toggle('show'); if(thPop.classList.contains('show')){document.addEventListener('pointerdown',closeIfOutside,{once:true});} }
  function closeIfOutside(ev){ if(thPop.contains(ev.target)||ev.target.id==='btnThickness'){ document.addEventListener('pointerdown',closeIfOutside,{once:true}); return; } thPop.classList.remove('show'); }
  document.getElementById('btnThickness').onclick=()=>togglePop();
  lineRange.oninput=e=>{ params.linePx=+e.target.value; lineVal.textContent=e.target.value; need(); };
  lineRange.onchange=()=>{ thPop.classList.remove('show'); };

  // —Å—Ç–∞—Ä—Ç
  fit();
  toast('üìê –õ–∏–Ω–∏—è: –¢–ê–ü ‚Üí –¢–ê–ü. –ü–æ—Å–ª–µ —Å–µ–≥–º–µ–Ω—Ç–∞ —Ä–µ–∂–∏–º –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ ¬´–†—É–∫—É¬ª.');
})();
</script>
</body>
</html>