<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace ‚Äî —Ç—Ä—É–±—ã –ø–æ–≤–µ—Ä—Ö —Ñ–æ—Ç–æ</title>
<style>
  :root{--bg:#0f0f11;--panel:#1c1c20;--txt:#eaeaea;--vio:#6b1dff}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  #cv{position:fixed;inset:0;display:block;width:100vw;height:100vh;touch-action:none;-webkit-user-select:none;user-select:none}
  .bar{position:fixed;left:12px;top:12px;z-index:10;display:flex;gap:10px;flex-wrap:wrap}
  .btn{height:44px;padding:0 14px;border:0;border-radius:12px;background:#2a2a31;color:#fff;font-weight:700;box-shadow:0 2px 10px rgba(0,0,0,.15)}
  .btn.primary{background:linear-gradient(180deg,#7c5bff,#6b1dff)}
  .btn:active{transform:translateY(1px)}
  .status{position:fixed;left:12px;bottom:12px;background:rgba(0,0,0,.7);color:#9ef99e;padding:6px 8px;border-radius:8px;font:12px/1.2 ui-monospace,Menlo,Consolas,monospace;z-index:11}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="bar">
    <button id="btnPhoto" class="btn">üì∑ –§–æ—Ç–æ</button>
    <button id="btnClearBg" class="btn">üßπ –£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω</button>
    <button id="btnCenter" class="btn">üéØ –¶–µ–Ω—Ç—Ä</button>

    <button id="btnLine" class="btn primary">üìê –õ–∏–Ω–∏—è</button>
    <button id="btnUndo" class="btn">‚Ü© –ù–∞–∑–∞–¥</button>
  </div>

  <div id="status" class="status">–°—Ç–∞—Ç—É—Å: –∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  <input id="file" type="file" accept="image/*" hidden />

<script>
(()=>{"use strict";

// === Canvas & DPR ===========================================================
const DPR = Math.min(2, Math.max(1, window.devicePixelRatio||1));
const cv  = document.getElementById('cv');
const ctx = cv.getContext('2d',{alpha:false});
function fit(){
  // –†–µ—Ç–∏–Ω–∞-—Ä–∞–∑–º–µ—Ä —Ö–æ–ª—Å—Ç–∞
  cv.width  = Math.round(innerWidth  * DPR);
  cv.height = Math.round(innerHeight * DPR);
  need();
}
addEventListener('resize', fit, {passive:true});

// === View (–ø–∞–Ω/–∑—É–º) =========================================================
const view = {tx:0, ty:0, scale:1};
const clampScale = s => Math.max(0.25, Math.min(6, s));
function w2s(x,y){ return { x:x*view.scale + view.tx, y:y*view.scale + view.ty }; }
function s2w(sx,sy){ return { x:(sx-view.tx)/view.scale, y:(sy-view.ty)/view.scale }; }

// –ü–æ–º–æ—â–Ω–∏–∫: –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–∫–∞–∑–∞—Ç–µ–ª—è –≤ –ü–ò–ö–°–ï–õ–Ø–• –•–û–õ–°–¢–ê (—É—á—ë—Ç DPR!)
function canvasXY(e){
  const r = cv.getBoundingClientRect();
  return {
    sx: (e.clientX - r.left) * (cv.width  / r.width),
    sy: (e.clientY - r.top ) * (cv.height / r.height),
  };
}

// === –î–∞–Ω–Ω—ã–µ =================================================================
const segs = [];            // —Ç—Ä—É–±—ã (–æ—Ç—Ä–µ–∑–∫–∏) –≤ –º–∏—Ä–æ–≤—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
let tool = 'idle';          // idle | awaitFirst | awaitSecond
let first = null, preview=null;
let pipeW = 6 * DPR;        // –±–∞–∑–æ–≤–∞—è ¬´—Ç–æ–ª—â–∏–Ω–∞ —Ç—Ä—É–±—ã¬ª –≤ –ø–∏–∫—Å–µ–ª—è—Ö —Ö–æ–ª—Å—Ç–∞

// –§–æ–Ω-—Ñ–æ—Ç–æ
let bgImg = null;           // HTMLImageElement
let bgPos = {x:0,y:0,w:0,h:0}; // –∫—É–¥–∞ —Ä–∏—Å—É–µ–º —Ñ–æ—Ç–æ (–≤ —ç–∫—Ä–∞–Ω–Ω—ã—Ö –ø–∏–∫—Å–µ–ª—è—Ö)

// === UI =====================================================================
const $ = id => document.getElementById(id);
const statusEl = $('status');
function setStatus(msg){ statusEl.textContent = `–°—Ç–∞—Ç—É—Å: ${msg}`; }

$('btnLine').onclick = ()=>{
  tool='awaitFirst'; first=null; preview=null;
  setStatus('–†–µ–∂–∏–º –õ–∏–Ω–∏—è: —Ç–∫–Ω–∏ –ø–µ—Ä–≤—É—é —Ç–æ—á–∫—É');
};
$('btnUndo').onclick = ()=>{
  if (tool==='awaitSecond' && first){ first=null; preview=null; tool='idle'; need(); setStatus('–°–µ–≥–º–µ–Ω—Ç –æ—Ç–º–µ–Ω—ë–Ω'); return; }
  if (segs.length){ segs.pop(); need(); setStatus('–û—Ç–º–µ–Ω–∏–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç'); } else setStatus('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å');
};

$('btnPhoto').onclick = ()=> $('file').click();
$('btnClearBg').onclick = ()=>{ bgImg=null; need(); setStatus('–§–æ–Ω –æ—á–∏—â–µ–Ω'); };
$('btnCenter').onclick = ()=>{ view.tx=0; view.ty=0; view.scale=1; need(); setStatus('–¶–µ–Ω—Ç—Ä'); };

$('file').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const img=new Image(); img.onload=()=>{
    bgImg=img;
    // —Ä–∞—Å—Ç—è–Ω–µ–º –ø–æ –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (cover)
    const cw=cv.width, ch=cv.height;
    const rImg=img.width/img.height, rCv=cw/ch;
    if(rImg>rCv){ // –∫–∞—Ä—Ç–∏–Ω–∫–∞ —à–∏—Ä–µ: –ø–æ–¥–≥–æ–Ω—è–µ–º –ø–æ –≤—ã—Å–æ—Ç–µ
      const h=ch, w=h*rImg, x=(cw-w)/2, y=0;
      bgPos={x,y,w,h};
    }else{        // –≤—ã—à–µ: –ø–æ–¥–≥–æ–Ω—è–µ–º –ø–æ —à–∏—Ä–∏–Ω–µ
      const w=cw, h=w/rImg, x=0, y=(ch-h)/2;
      bgPos={x,y,w,h};
    }
    need(); setStatus('–§–æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
  };
  img.src = URL.createObjectURL(f);
});

// === –†–∏—Å–æ–≤–∞–Ω–∏–µ ==============================================================
// —Ç—Ä—É–±–∞ = —á–µ—Ç—ã—Ä—ë—Ö—É–≥–æ–ª—å–Ω–∏–∫ (–¥–≤–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏)
function drawPipe(a,b,w){
  const dx=b.x-a.x, dy=b.y-a.y;
  const len=Math.hypot(dx,dy)||1;
  const ox= -dy/len*w/2, oy= dx/len*w/2;
  const A = w2s(a.x,a.y), B = w2s(b.x,b.y); // –≤ —ç–∫—Ä–∞–Ω
  ctx.fillStyle = '#2a72ff';
  ctx.beginPath();
  ctx.moveTo(A.x+ox, A.y+oy);
  ctx.lineTo(B.x+ox, B.y+oy);
  ctx.lineTo(B.x-ox, B.y-oy);
  ctx.lineTo(A.x-ox, A.y-oy);
  ctx.closePath();
  ctx.fill();
}

function redraw(){
  // —Ñ–æ–Ω
  ctx.setTransform(1,0,0,1,0,0);
  ctx.fillStyle = '#111'; ctx.fillRect(0,0,cv.width,cv.height);
  if(bgImg){ ctx.drawImage(bgImg, bgPos.x, bgPos.y, bgPos.w, bgPos.h); }

  // —Å–µ–≥–º–µ–Ω—Ç—ã
  for(const s of segs) drawPipe(s.a,s.b, pipeW);

  // –ø—Ä–µ–≤—å—é
  if(tool==='awaitSecond' && first && preview){
    ctx.globalAlpha = 0.75;
    drawPipe(first, preview, pipeW);
    ctx.globalAlpha = 1;
  }

  // –º–∞—Ä–∫–µ—Ä –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–∏
  if(first){
    const p=w2s(first.x,first.y);
    ctx.fillStyle='#ff3b30';
    ctx.beginPath(); ctx.arc(p.x,p.y,4*DPR,0,Math.PI*2); ctx.fill();
  }
}
let raf=0,dirty=false;
function need(){ dirty=true; if(!raf){ raf=requestAnimationFrame(()=>{raf=0; if(dirty){dirty=false; redraw();}}); }}

// === –í–≤–æ–¥: –∫–ª–∏–∫–∏ ============================================================
cv.addEventListener('pointerdown', e=>{
  e.preventDefault();
  const {sx,sy} = canvasXY(e);            // ‚Üê –ü–†–ê–í–ò–õ–¨–ù–û: —É—á–∏—Ç—ã–≤–∞–µ–º DPR –∏ —Ä–µ–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ö–æ–ª—Å—Ç–∞
  if(tool==='awaitFirst'){
    first = s2w(sx,sy);
    preview=null;
    tool='awaitSecond';
    setStatus('–ü–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞ –µ—Å—Ç—å ‚Äî —Ç–∫–Ω–∏ –≤—Ç–æ—Ä—É—é');
    need();
    return;
  }
  if(tool==='awaitSecond'){
    preview = s2w(sx,sy);
    segs.push({a:first,b:preview});
    first=null; preview=null; tool='idle';
    setStatus('–°–µ–≥–º–µ–Ω—Ç –≥–æ—Ç–æ–≤. –î–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–Ω–æ–≤–∞ –Ω–∞–∂–º–∏ ¬´–õ–∏–Ω–∏—è¬ª.');
    need();
    return;
  }
},{passive:false});

// –ö–æ–ª—ë—Å–∏–∫–æ/–ø–∏–Ω—á –≤ –±—É–¥—É—â–µ–º, –ø–æ–∫–∞ ‚Äî —Ü–µ–Ω—Ç—Ä –∫–Ω–æ–ø–∫–æ–π

// === Go =====================================================================
fit(); need(); setStatus('–ì–æ—Ç–æ–≤–æ: –Ω–∞–∂–º–∏ ¬´–õ–∏–Ω–∏—è¬ª ‚Üí 1-—è —Ç–æ—á–∫–∞ ‚Üí 2-—è —Ç–æ—á–∫–∞. –¢—Ä—É–±—ã —Ä–∏—Å—É—é—Ç—Å—è –ø–æ –í–°–ï–ú–£ —ç–∫—Ä–∞–Ω—É.');
})();
</script>
</body>
</html>