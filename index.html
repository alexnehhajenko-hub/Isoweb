<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>3D Трассировка труб</title>
  <style>
    body, html { margin:0; padding:0; overflow:hidden; background:#111; }
    #ui { position:fixed; top:10px; left:10px; display:flex; gap:10px; z-index:10; }
    button { padding:8px 12px; border:none; border-radius:8px; background:#444; color:white; font-size:14px; }
    #settings { position:fixed; top:50px; left:10px; background:#fff; padding:10px; border-radius:8px; display:none; z-index:20; }
    #settings label { display:block; margin:6px 0; font-size:14px; }
    input[type=range] { width:120px; }
    #bgInput { display:none; }
  </style>
</head>
<body>
  <div id="ui">
    <button id="lineBtn">Линия</button>
    <button id="undoBtn">Назад</button>
    <button id="photoBtn">Фото</button>
    <button id="centerBtn">Центр</button>
    <button id="settingsBtn">⚙️</button>
  </div>

  <div id="settings">
    <label>Ø, мм <input type="range" id="diameter" min="10" max="100" value="40"></label>
    <label>Сетка <input type="range" id="grid" min="10" max="100" value="40"></label>
    <label><input type="checkbox" id="isometry" checked> Изометрия</label>
    <button onclick="toggleSettings()">Закрыть ✖</button>
  </div>

  <input type="file" id="bgInput" accept="image/*">

  <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/examples/js/controls/OrbitControls.js"></script>
  <script>
    let scene = new THREE.Scene();
    let camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 2000);
    camera.position.set(200,200,200);

    let renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(innerWidth, innerHeight);
    document.body.appendChild(renderer.domElement);

    let controls = new THREE.OrbitControls(camera, renderer.domElement);

    // Сетка
    let grid = new THREE.GridHelper(1000, 25);
    scene.add(grid);

    // Свет
    let light = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
    scene.add(light);

    // Группа для труб
    let pipes = new THREE.Group();
    scene.add(pipes);

    // Фон (фото)
    let bgMesh = null;

    document.getElementById('photoBtn').onclick = () => {
      document.getElementById('bgInput').click();
    };
    document.getElementById('bgInput').onchange = e => {
      let file = e.target.files[0];
      let reader = new FileReader();
      reader.onload = function(ev) {
        let tex = new THREE.TextureLoader().load(ev.target.result);
        if (bgMesh) scene.remove(bgMesh);
        let geo = new THREE.PlaneGeometry(2000, 2000);
        let mat = new THREE.MeshBasicMaterial({map: tex, side: THREE.DoubleSide});
        bgMesh = new THREE.Mesh(geo, mat);
        bgMesh.position.z = -10;
        scene.add(bgMesh);
      };
      reader.readAsDataURL(file);
    };

    // Логика рисования труб
    let drawing = false;
    let lastPoint = null;
    let pipeDiameter = 40;

    document.getElementById('lineBtn').onclick = () => { drawing = true; };
    document.getElementById('undoBtn').onclick = () => {
      pipes.remove(pipes.children[pipes.children.length-1]);
    };
    document.getElementById('centerBtn').onclick = () => {
      controls.target.set(0,0,0);
      camera.position.set(200,200,200);
    };

    renderer.domElement.addEventListener('click', e => {
      if (!drawing) return;
      let mouse = new THREE.Vector2(
        (e.clientX / innerWidth) * 2 - 1,
        -(e.clientY / innerHeight) * 2 + 1
      );
      let ray = new THREE.Raycaster();
      ray.setFromCamera(mouse, camera);
      let plane = new THREE.Plane(new THREE.Vector3(0,0,1), 0);
      let point = new THREE.Vector3();
      ray.ray.intersectPlane(plane, point);

      if (lastPoint) {
        let dir = new THREE.Vector3().subVectors(point, lastPoint);
        let length = dir.length();
        let geo = new THREE.CylinderGeometry(pipeDiameter/20, pipeDiameter/20, length, 16);
        let mat = new THREE.MeshStandardMaterial({color:0x0077ff});
        let cyl = new THREE.Mesh(geo, mat);
        cyl.position.copy(lastPoint).add(dir.multiplyScalar(0.5));
        cyl.lookAt(point);
        pipes.add(cyl);

        // Отвод (сфера на стыке)
        let sphGeo = new THREE.SphereGeometry(pipeDiameter/20, 16, 16);
        let sph = new THREE.Mesh(sphGeo, mat);
        sph.position.copy(point);
        pipes.add(sph);
      }
      lastPoint = point.clone();
    });

    // Настройки
    document.getElementById('diameter').oninput = e => { pipeDiameter = e.target.value; };
    function toggleSettings(){
      let st = document.getElementById('settings');
      st.style.display = (st.style.display=="none")?"block":"none";
    }
    document.getElementById('settingsBtn').onclick = toggleSettings;

    // Рендер
    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', ()=>{
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });
  </script>
</body>
</html>