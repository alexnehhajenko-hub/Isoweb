<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace ‚Äî pinch + 3D Grid (v720)</title>
<style>
  :root{--violet:#8000ff; --violet2:#6b1dff; --border:#e7e3f7}
  html,body{margin:0;height:100%;background:#f2f3f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  canvas{display:block;width:100vw;height:100vh;background:#fff;touch-action:none;user-select:none;-webkit-user-select:none}

  .bar{position:fixed;left:8px;right:8px;top:8px;z-index:1000;display:flex;gap:8px;flex-wrap:wrap}
  .btn{height:42px;padding:0 14px;border:0;border-radius:12px;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff;font-weight:800}
  .btn.ghost{background:linear-gradient(180deg,#8c8c8c,#6a6a6a)}

  /* –ü–æ–ø–æ–≤–µ—Ä—ã */
  .pop{position:fixed;top:56px;right:8px;z-index:1001;background:#fff;border:1px solid var(--border);
       border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:10px;display:none;width:min(92vw,360px)}
  .pop.show{display:block}
  .row{display:flex;align-items:center;gap:10px;margin:8px 0}
  .row label{min-width:170px;font-size:13px;color:#555}
  .row input[type="range"]{flex:1;appearance:none;height:6px;border-radius:999px;background:#eee}
  .row input[type="range"]::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:var(--violet)}
  .row .val{width:44px;text-align:right;font-size:12px;color:#666}
  .row .switch{display:flex;align-items:center;gap:8px}

  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#1f1f2e;color:#fff;padding:10px 12px;border-radius:12px;opacity:0;transition:.25s;z-index:1100;pointer-events:none}
  .toast.show{opacity:1}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="bar">
    <button id="btnLine" class="btn">üìê –õ–∏–Ω–∏—è</button>
    <button id="btnHand" class="btn ghost">üñê –†—É–∫–∞</button>
    <label class="btn ghost" style="position:relative">üì∑ –ö–∞–º–µ—Ä–∞
      <input id="fileCam" type="file" accept="image/*" capture="environment" style="position:absolute;inset:0;opacity:0">
    </label>
    <label class="btn ghost" style="position:relative">üìÇ –ì–∞–ª–µ—Ä–µ—è
      <input id="fileGal" type="file" accept="image/*" style="position:absolute;inset:0;opacity:0">
    </label>
    <button id="btnUndo" class="btn ghost">‚Ü© –ù–∞–∑–∞–¥</button>
    <button id="btnExport" class="btn ghost">‚§ì PNG</button>
    <button id="btnThickness" class="btn ghost">‚öô –¢–æ–ª—â–∏–Ω–∞</button>
    <button id="btnGrid" class="btn ghost"># –°–µ—Ç–∫–∞ 3D</button>
  </div>

  <!-- –ü–æ–ø–æ–≤–µ—Ä —Ç–æ–ª—â–∏–Ω—ã -->
  <div id="thPop" class="pop" role="dialog" aria-modal="true" aria-label="–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏">
    <div class="row">
      <label>–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏ (px)</label>
      <input id="linePx" type="range" min="2" max="24" value="10">
      <span id="linePxVal" class="val">10</span>
    </div>
    <p style="margin:8px 0 0;font-size:12px;color:#666">–ú–∞—Å—à—Ç–∞–± –∏ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ: <b>–¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏</b>.</p>
  </div>

  <!-- –ü–æ–ø–æ–≤–µ—Ä —Å–µ—Ç–∫–∏ -->
  <div id="gridPop" class="pop" role="dialog" aria-modal="true" aria-label="–°–µ—Ç–∫–∞ 3D">
    <div class="row">
      <div class="switch">
        <input id="gridOn" type="checkbox" checked>
        <label for="gridOn">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–µ—Ç–∫—É</label>
      </div>
    </div>
    <div class="row">
      <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å</label>
      <input id="gridAlpha" type="range" min="0" max="100" value="25">
      <span id="gridAlphaVal" class="val">25%</span>
    </div>
    <div class="row">
      <label>–®–∞–≥ (px)</label>
      <input id="gridStep" type="range" min="80" max="480" value="200">
      <span id="gridStepVal" class="val">200</span>
    </div>
    <div class="row">
      <label>–£–≥–æ–ª (¬∞)</label>
      <input id="gridAngle" type="range" min="-90" max="90" value="30">
      <span id="gridAngleVal" class="val">30</span>
    </div>
    <p style="margin:4px 0 0;font-size:12px;color:#666">–¢—Ä–∏ —Å–µ–º–µ–π—Å—Ç–≤–∞: <b>0¬∞/90¬∞</b> –∏ <b>¬±—É–≥–æ–ª</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä 30¬∞/150¬∞) ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∏–∑–æ–º–µ—Ç—Ä–∏—è.</p>
  </div>

  <div id="toast" class="toast"></div>

<script>
(()=>{
  const toast=(t,ms=1800)=>{const el=document.getElementById('toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),ms);};

  const DPR = Math.max(1, window.devicePixelRatio||1);
  const cv=document.getElementById('cv');
  const ctx=cv.getContext('2d',{alpha:false});

  // –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
  function getCanvasPointXY(clientX, clientY){
    const r=cv.getBoundingClientRect();
    return {
      sx:(clientX - r.left) * (cv.width  / r.width),
      sy:(clientY - r.top ) * (cv.height / r.height)
    };
  }

  // —Å—Ü–µ–Ω–∞
  const view={scale:1,tx:0,ty:0};
  let bg=null,bw=0,bh=0;
  const segs=[]; let mode='hand'; let first=null, prev=null;
  const params={ linePx:10 };

  // —Å–µ—Ç–∫–∞
  const grid={ on:true, alpha:0.25, step:200, angleDeg:30 };

  function fit(){
    cv.width=Math.round(innerWidth*DPR);
    cv.height=Math.round(innerHeight*DPR);
    if(bg && view.scale===1 && view.tx===0 && view.ty===0){
      const k=Math.min(cv.width/bw, cv.height/bh);
      view.scale=k; view.tx=(cv.width-bw*k)/2; view.ty=(cv.height-bh*k)/2;
    }
    need();
  }
  addEventListener('resize',fit);

  const s2w=(sx,sy)=>({x:(sx-view.tx)/view.scale, y:(sy-view.ty)/view.scale});
  const w2s=(x,y)=>({x:x*view.scale+view.tx, y:y*view.scale+view.ty});

  function drawGrid(){
    if(!grid.on || grid.alpha<=0) return;
    ctx.save();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.globalAlpha=grid.alpha;

    // —Ä–∏—Å—É–µ–º –≤ —ç–∫—Ä–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö, –Ω–æ —à–∞–≥ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ scale ‚Üí –≤–∏–∑—É–∞–ª—å–Ω–æ —à–∞–≥ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π
    const step = grid.step;
    const angles = [0, 90, grid.angleDeg, 180-grid.angleDeg]; // 0/90 –∏ ¬±—É–≥–æ–ª

    // –≥—Ä–∞–Ω–∏—Ü—ã —Å –∑–∞–ø–∞—Å–æ–º
    const W=cv.width, H=cv.height, M=1000;

    angles.forEach((deg,i)=>{
      const rad = deg * Math.PI/180;
      const vx = Math.cos(rad), vy = Math.sin(rad);
      // –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä
      const px = -vy, py = vx;

      // —Å–º–µ—â–µ–Ω–∏–µ –ª–∏–Ω–∏–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ: —Ö–æ—Ç–∏–º —à–∞–≥ –≤ px, –Ω–µ –∑–∞–≤–∏—Å—è—â–∏–π –æ—Ç –∑—É–º–∞.
      // –Ω–æ —É –Ω–∞—Å –º–∏—Ä->—ç–∫—Ä–∞–Ω: x*scale+tx, –ø–æ—ç—Ç–æ–º—É —à–∞–≥ —ç–∫—Ä–∞–Ω–∞ == step, —Å–¥–≤–∏–≥–∞–µ–º –ø–æ –ø–µ—Ä–ø. –≤ —ç–∫—Ä–∞–Ω–µ
      // –ø—Ä–æ–≥–æ–Ω–∏–º k –æ—Ç -N..N:
      const N = Math.ceil((Math.max(W,H)+2*M)/step);
      for(let k=-N;k<=N;k++){
        const ox = W/2 + px*k*step;
        const oy = H/2 + py*k*step;

        // —Ç–æ—á–∫–∏ –¥–∞–ª–µ–∫–æ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏, —á—Ç–æ–±—ã –ª–∏–Ω–∏—è –∑–∞–∫—Ä—ã–ª–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        const A = {x: ox - vx*20000, y: oy - vy*20000};
        const B = {x: ox + vx*20000, y: oy + vy*20000};

        ctx.strokeStyle = (k%3===0)? '#b7bcc8' : '#cfd3dc';
        ctx.lineWidth = (k%3===0)? 1.6 : 1.0;
        ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();
      }
    });

    ctx.restore(); ctx.globalAlpha=1;
  }

  function draw(){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,cv.width,cv.height);

    // —Ñ–æ–Ω-—Ñ–æ—Ç–æ
    if(bg){ ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty); ctx.drawImage(bg,0,0,bw,bh); }

    // —Å–µ—Ç–∫–∞ –ø–æ–≤–µ—Ä—Ö —Ñ–æ—Ç–æ, –ø–æ–¥ –ª–∏–Ω–∏—è–º–∏
    drawGrid();

    // –º–∏—Ä –¥–ª—è –ª–∏–Ω–∏–π
    ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);

    for(const s of segs){
      ctx.strokeStyle='#5b00bf'; ctx.globalAlpha=.7; ctx.lineWidth=(params.linePx+2)/view.scale;
      ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
      ctx.strokeStyle='#8000ff'; ctx.globalAlpha=1; ctx.lineWidth=(params.linePx)/view.scale;
      ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
    }

    if(first && prev){
      ctx.setLineDash([12/view.scale,8/view.scale]);
      ctx.strokeStyle='#16a34a'; ctx.lineWidth=Math.max(3,params.linePx-2)/view.scale;
      ctx.beginPath(); ctx.moveTo(first.x,first.y); ctx.lineTo(prev.x,prev.y); ctx.stroke();
      ctx.setLineDash([]);
      const p=w2s(prev.x,prev.y); ctx.setTransform(1,0,0,1,0,0);
      ctx.fillStyle='#16a34a'; ctx.beginPath(); ctx.arc(p.x,p.y,6,0,Math.PI*2); ctx.fill();
    }
  }
  let raf=0,dirty=false; const need=()=>{dirty=true;if(!raf){raf=requestAnimationFrame(()=>{raf=0;if(dirty){dirty=false;draw();}})}};

  // ------- —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –∂–µ—Å—Ç—ã: Pointer + Touch (fallback) -------
  const hasPointer = 'PointerEvent' in window;
  const pts = new Map(); let lastPan=null;

  function handlePinch(){
    const arr=[...pts.values()];
    if(arr.length!==2) return false;
    const p0=arr[0], p1=arr[1];

    if(!p0.prev||!p1.prev){ p0.prev={...p0}; p1.prev={...p1}; return true; }

    const d0=Math.hypot(p0.prev.sx-p1.prev.sx,p0.prev.sy-p1.prev.sy);
    const d1=Math.hypot(p0.sx-p1.sx,p0.sy-p1.sy);
    if(d0>0){
      const k=d1/d0; const cx=(p0.sx+p1.sx)/2, cy=(p0.sy+p1.sy)/2;
      view.tx = cx - k*(cx - view.tx);
      view.ty = cy - k*(cy - view.ty);
      view.scale = Math.max(0.2, Math.min(8, view.scale*k));
      need();
    }
    p0.prev={...p0}; p1.prev={...p1};
    return true;
  }

  function startPoint(id,sx,sy){ pts.set(id,{sx,sy}); }
  function movePoint(id,sx,sy){
    const cur={sx,sy}; const prevPt=pts.get(id); pts.set(id,cur);
    if(pts.size===2){ handlePinch(); return; }

    if(mode==='hand'){
      if(!lastPan) lastPan={x:sx,y:sy};
      view.tx += sx-lastPan.x; view.ty += sy-lastPan.y; lastPan={x:sx,y:sy}; need();
    }
    if(mode==='line' && first){ prev = s2w(sx,sy); need(); }
  }
  function endPoint(id){ pts.delete(id); lastPan=null; }

  if(hasPointer){
    cv.addEventListener('pointerdown',e=>{ const {sx,sy}=getCanvasPointXY(e.clientX,e.clientY); startPoint(e.pointerId,sx,sy);
      if(pts.size===2) return;
      if(mode==='line'){ const w=s2w(sx,sy); if(!first){ first=w; prev=null; need(); } else { segs.push({a:first,b:w}); first=null; prev=null; mode='hand'; need(); } }
    },{passive:false});

    cv.addEventListener('pointermove',e=>{ if(!pts.has(e.pointerId)) return; const {sx,sy}=getCanvasPointXY(e.clientX,e.clientY); movePoint(e.pointerId,sx,sy); },{passive:false});
    cv.addEventListener('pointerup',e=>{ endPoint(e.pointerId); });
    cv.addEventListener('pointercancel',e=>{ endPoint(e.pointerId); });
  }else{
    // Touch fallback
    cv.addEventListener('touchstart',e=>{
      e.preventDefault();
      for(const t of e.changedTouches){ const {sx,sy}=getCanvasPointXY(t.clientX,t.clientY); startPoint(t.identifier,sx,sy); }
      if(pts.size===1 && mode==='line'){ const only=[...pts.values()][0]; const w=s2w(only.sx,only.sy); if(!first){ first=w; prev=null; need(); } }
      if(pts.size===2) return;
    },{passive:false});

    cv.addEventListener('touchmove',e=>{
      e.preventDefault();
      for(const t of e.changedTouches){ const {sx,sy}=getCanvasPointXY(t.clientX,t.clientY); movePoint(t.identifier,sx,sy); }
    },{passive:false});

    cv.addEventListener('touchend',e=>{
      e.preventDefault();
      // –µ—Å–ª–∏ –æ–¥–∏–Ω–æ—á–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ ‚Äî –∑–∞–≤–µ—Ä—à–∏–º —Å–µ–≥–º–µ–Ω—Ç –Ω–∞ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–∏
      if(e.changedTouches.length===1 && pts.size===1 && mode==='line' && first){
        const t=e.changedTouches[0]; const {sx,sy}=getCanvasPointXY(t.clientX,t.clientY);
        const w=s2w(sx,sy); segs.push({a:first,b:w}); first=null; prev=null; mode='hand'; need();
      }
      for(const t of e.changedTouches){ endPoint(t.identifier); }
    },{passive:false});
    cv.addEventListener('touchcancel',e=>{ for(const t of e.changedTouches){ endPoint(t.identifier); } },{passive:false});
  }

  // –∫–æ–ª–µ—Å–æ –º—ã—à–∏ –∫–∞–∫ –¥–æ–ø. –∑—É–º (desktop)
  cv.addEventListener('wheel',e=>{
    e.preventDefault();
    const {sx,sy}=getCanvasPointXY(e.clientX,e.clientY); const k=e.deltaY<0?1.12:0.9;
    view.tx = sx - k*(sx - view.tx);
    view.ty = sy - k*(sy - view.ty);
    view.scale = Math.max(0.2, Math.min(8, view.scale*k));
    need();
  },{passive:false});

  // –∫–Ω–æ–ø–∫–∏
  const $=id=>document.getElementById(id);
  $('btnLine').onclick=()=>{mode='line';first=null;prev=null;toast('–†–µ–∂–∏–º: –ª–∏–Ω–∏—è');};
  $('btnHand').onclick=()=>{mode='hand';first=null;prev=null;toast('–†–µ–∂–∏–º: —Ä—É–∫–∞');};
  $('btnUndo').onclick=()=>{ if(first){first=null;prev=null;} else segs.pop(); need(); };
  $('btnExport').onclick=()=>{ const url=cv.toDataURL('image/png',0.95); const a=document.createElement('a'); a.href=url; a.download='ProTrace.png'; a.click(); };

  // —Ñ–æ—Ç–æ
  const loadImageFile=f=>{
    if(!f) return;
    const img=new Image(); img.onload=()=>{
      const maxSide=Math.max(img.naturalWidth,img.naturalHeight);
      let w=img.naturalWidth,h=img.naturalHeight;
      if(maxSide>2200){ const sc=2200/maxSide; w=Math.round(w*sc); h=Math.round(h*sc); }
      const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d',{alpha:false}).drawImage(img,0,0,w,h);
      bg=c; bw=w; bh=h;
      const k=Math.min(cv.width/bw, cv.height/bh); view.scale=k; view.tx=(cv.width-bw*k)/2; view.ty=(cv.height-bh*k)/2;
      need(); toast('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
    };
    img.src=URL.createObjectURL(f);
  };
  $('fileCam').onchange=e=>loadImageFile(e.target.files?.[0]);
  $('fileGal').onchange=e=>loadImageFile(e.target.files?.[0]);

  // –ø–æ–ø–æ–≤–µ—Ä —Ç–æ–ª—â–∏–Ω—ã
  const thPop=document.getElementById('thPop');
  const lineRange=document.getElementById('linePx');
  const lineVal=document.getElementById('linePxVal');
  function togglePop(el){ el.classList.toggle('show'); if(el.classList.contains('show')){document.addEventListener('pointerdown',closeIfOutside,{once:true});} }
  function closeIfOutside(ev){
    if(thPop.contains(ev.target) || ev.target.id==='btnThickness' || gridPop.contains(ev.target) || ev.target.id==='btnGrid'){
      document.addEventListener('pointerdown',closeIfOutside,{once:true}); return;
    }
    thPop.classList.remove('show'); gridPop.classList.remove('show');
  }
  document.getElementById('btnThickness').onclick=()=>togglePop(thPop);
  lineRange.oninput=e=>{ params.linePx=+e.target.value; lineVal.textContent=e.target.value; need(); };
  lineRange.onchange=()=>{ thPop.classList.remove('show'); };

  // –ø–æ–ø–æ–≤–µ—Ä —Å–µ—Ç–∫–∏
  const gridPop=document.getElementById('gridPop');
  document.getElementById('btnGrid').onclick=()=>togglePop(gridPop);
  const gridOn = document.getElementById('gridOn');
  const gridAlpha = document.getElementById('gridAlpha');
  const gridAlphaVal = document.getElementById('gridAlphaVal');
  const gridStep = document.getElementById('gridStep');
  const gridStepVal = document.getElementById('gridStepVal');
  const gridAngle = document.getElementById('gridAngle');
  const gridAngleVal = document.getElementById('gridAngleVal');

  gridOn.onchange = e=>{ grid.on = !!e.target.checked; need(); };
  gridAlpha.oninput = e=>{ grid.alpha = (+e.target.value)/100; gridAlphaVal.textContent=e.target.value+'%'; need(); };
  gridStep.oninput  = e=>{ grid.step  = (+e.target.value|0); gridStepVal.textContent=e.target.value; need(); };
  gridAngle.oninput = e=>{ grid.angleDeg=(+e.target.value|0); gridAngleVal.textContent=e.target.value; need(); };

  // —Å—Ç–∞—Ä—Ç
  fit();
  toast('–ó—É–º/–ø–∞–Ω ‚Äî –¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏. –°–µ—Ç–∫–∞ 3D ‚Äî –∫–Ω–æ–ø–∫–∞ ¬´# –°–µ—Ç–∫–∞ 3D¬ª.');
})();
</script>
</body>
</html>