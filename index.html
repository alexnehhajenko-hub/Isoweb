<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace ‚Äî v837</title>
<style>
  :root{--violet:#6b1dff; --violetDeep:#2b145f; --border:#e7e3f7}
  html,body{margin:0;height:100%;background:#f2f3f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden;overscroll-behavior:none}
  canvas{position:fixed;inset:0;display:block;width:100vw;height:100vh;background:#fff;touch-action:none;-webkit-user-select:none;user-select:none}

  .bar{position:fixed;left:8px;right:56px;top:8px;z-index:1000;display:flex;gap:8px;pointer-events:auto}
  .btn{height:44px;padding:0 16px;border:0;border-radius:12px;background:linear-gradient(180deg,#7c5bff,var(--violet));color:#fff;font-weight:800;cursor:pointer}
  .btn.ghost{background:linear-gradient(180deg,#8c8c8c,#6a6a6a)}
  .gear{position:fixed;top:8px;right:8px;width:44px;height:44px;border-radius:12px;border:1px solid var(--border);background:#fff;color:#5b30c2;font-weight:800;z-index:1001;cursor:pointer}

  .panel-wrap{position:fixed;inset:0;z-index:1050;display:none}
  .panel-wrap.open{display:block}
  .panel-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.18)}
  .panel{position:absolute;top:64px;right:8px;background:#fff;border:1px solid var(--border);
         border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:12px;width:min(92vw,380px);
         max-height:80vh;overflow:auto}
  .panel h4{margin:6px 0 8px 0;font-size:15px}
  .row{display:flex;align-items:center;gap:10px;margin:10px 0}
  .row label{min-width:150px;font-size:13px;color:#444}
  .hr{height:1px;background:#eee;margin:10px 0}
  .close{position:sticky;top:0;margin:-6px -6px 6px auto;background:#fff;border:1px solid var(--border);width:32px;height:32px;border-radius:8px;cursor:pointer}

  .radio-row{display:flex;gap:10px;flex-wrap:wrap}
  .radio{display:flex;align-items:center;gap:6px;border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:12px;color:#333;cursor:pointer}
  .radio input{accent-color:#6b1dff}

  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#1f1f2e;color:#fff;padding:10px 12px;border-radius:12px;opacity:0;transition:.25s;z-index:1200;pointer-events:none;max-width:92vw;text-align:center}
  .toast.show{opacity:1}

  .status{position:fixed;left:8px;bottom:8px;z-index:1201;background:rgba(0,0,0,.65);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;max-width:92vw}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="bar">
    <button id="btnLine" class="btn">üìê –õ–∏–Ω–∏—è</button>
    <button id="btnUndo" class="btn ghost">‚Ü© –ù–∞–∑–∞–¥</button>
    <button id="btnHand" class="btn ghost">üñê –†—É–∫–∞</button>
  </div>
  <button id="btnSettings" class="gear" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öô</button>

  <div id="panelWrap" class="panel-wrap" aria-hidden="true">
    <div id="panelBackdrop" class="panel-backdrop"></div>
    <div id="panel" class="panel" role="dialog" aria-modal="true">
      <button id="btnClosePanel" class="close" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>

      <h4>–§–æ—Ç–æ</h4>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <label class="btn ghost" style="position:relative;min-width:120px;display:inline-flex;justify-content:center;cursor:pointer">üì∑ –ö–∞–º–µ—Ä–∞
          <input id="fileCam" type="file" accept="image/*" capture="environment" style="position:absolute;inset:0;opacity:0">
        </label>
        <label class="btn ghost" style="position:relative;min-width:120px;display:inline-flex;justify-content:center;cursor:pointer">üìÇ –ì–∞–ª–µ—Ä–µ—è
          <input id="fileGal" type="file" accept="image/*" style="position:absolute;inset:0;opacity:0">
        </label>
        <button id="btnExport" class="btn ghost" style="margin-left:auto">‚§ì PNG</button>
      </div>

      <div class="hr"></div>
      <h4>–ê—Ä–º–∞—Ç—É—Ä–∞</h4>
      <div class="row radio-row">
        <label class="radio"><input type="radio" name="comp" value="valve" checked> –®–∞—Ä–æ–≤—ã–π –∫—Ä–∞–Ω (BALL)</label>
        <label class="radio"><input type="radio" name="comp" value="check"> –û–±—Ä–∞—Ç–Ω—ã–π –∫–ª–∞–ø–∞–Ω (CHECK)</label>
        <label class="radio"><input type="radio" name="comp" value="pump"> –ù–∞—Å–æ—Å (PUMP)</label>
      </div>
      <div class="row">
        <label for="scale">–ú–∞—Å—à—Ç–∞–± –∞—Ä–º–∞—Ç—É—Ä—ã</label>
        <input id="scale" type="range" min="50" max="250" step="5" value="110" style="flex:1">
        <span id="scaleVal" style="font-size:12px;color:#666">1.10√ó</span>
      </div>

      <div class="hr"></div>
      <h4>–õ–∏–Ω–∏—è –∏ ¬´–º–∞–≥–Ω–∏—Ç¬ª</h4>
      <div class="row">
        <label for="thick">–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏</label>
        <input id="thick" type="range" min="2" max="28" step="1" value="10" style="flex:1">
        <span id="thickVal" style="font-size:12px;color:#666">10 px</span>
      </div>
      <div class="row">
        <label for="snap">–†–∞–¥–∏—É—Å –º–∞–≥–Ω–∏—Ç–∞</label>
        <input id="snap" type="range" min="6" max="40" step="1" value="22" style="flex:1">
        <span id="snapVal" style="font-size:12px;color:#666">22 px</span>
      </div>
      <div class="row">
        <label>–ú–∞–≥–Ω–∏—Ç</label>
        <label class="radio"><input type="radio" name="mag" value="on" checked> –í–∫–ª</label>
        <label class="radio"><input type="radio" name="mag" value="off"> –í—ã–∫–ª</label>
      </div>

      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="btnPlaceComp" class="btn">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Ç—Ä—É–±—É</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <div id="status" class="status">–°—Ç–∞—Ç—É—Å: –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

<script>
(function(){
  "use strict";
  function $(id){ return document.getElementById(id); }
  var toastEl=$('toast'), statusEl=$('status');
  function toast(t,ms){ if(ms===void 0) ms=1600; toastEl.textContent=t; toastEl.classList.add('show'); setTimeout(function(){ toastEl.classList.remove('show'); }, ms); }
  function status(t){ statusEl.textContent='–°—Ç–∞—Ç—É—Å: '+t; }
  window.addEventListener('error', function(e){ try{ status('–û—à–∏–±–∫–∞: '+(e.message||'unknown')); toast('–û—à–∏–±–∫–∞: '+(e.message||'unknown'),2200);}catch(_){}});

  var cv=$('cv'); var ctx=cv.getContext && cv.getContext('2d',{alpha:false});
  if(!ctx){ status('Canvas 2D –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'); return; }

  var DPR=Math.max(1,window.devicePixelRatio||1);
  var view={scale:1,tx:0,ty:0};
  var bg=null,bw=0,bh=0;

  var segs=[], comps=[], history=[];
  var mode='hand', first=null, preview=null, editing=null;
  var params={ linePx:10, lineColor:'#1f6bff', snapRadiusPx:22 };
  var compScale=1.1, magnetOn=true, hoverSnap=null;

  function darker(hex,k){ if(k===void 0) k=0.45;
    var m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); if(!m) return '#333';
    var r=parseInt(m[1],16), g=parseInt(m[2],16), b=parseInt(m[3],16);
    r=Math.max(0,Math.floor(r*(1-k))); g=Math.max(0,Math.floor(g*(1-k))); b=Math.max(0,Math.floor(b*(1-k)));
    function h(v){ var s=v.toString(16); return s.length===1?('0'+s):s; } return '#'+h(r)+h(g)+h(b);
  }

  function fit(){ cv.width=Math.round(innerWidth*DPR); cv.height=Math.round(innerHeight*DPR); if(bg && view.scale===1 && view.tx===0 && view.ty===0) fitToScreen(); need(); }
  window.addEventListener('resize', fit, {passive:true});
  function fitToScreen(){ if(!bg) return; var k=Math.min(cv.width/bw, cv.height/bh); view.scale=k; view.tx=(cv.width-bw*k)/2; view.ty=(cv.height-bh*k)/2; }
  function s2w(sx,sy){ return {x:(sx-view.tx)/view.scale, y:(sy-view.ty)/view.scale}; }
  function w2s(x,y){ return {x:x*view.scale+view.tx, y:y*view.scale+view.ty}; }
  function clampView(){ if(!bg) return; var W=cv.width,H=cv.height,CW=bw*view.scale,CH=bh*view.scale; var minTx=Math.min(0,W-CW),maxTx=Math.max(0,W-CW); var minTy=Math.min(0,H-CH),maxTy=Math.max(0,H-CH); view.tx=Math.min(maxTx,Math.max(minTx,view.tx)); view.ty=Math.min(maxTy,Math.max(minTy,view.ty)); }

  function segGeom(seg){
    var vx=seg.b.x-seg.a.x, vy=seg.b.y-seg.a.y;
    var L = (Math.hypot?Math.hypot(vx,vy):Math.sqrt(vx*vx+vy*vy)); if(!L) L=1;
    return {vx:vx,vy:vy,L:L,nx:vx/L,ny:vy/L};
  }
  function compBasis(seg,t){ var g=segGeom(seg); var x=seg.a.x+g.nx*g.L*t, y=seg.a.y+g.ny*g.L*t; return {x:x,y:y,ux:g.nx,uy:g.ny,nx:-g.ny,ny:g.nx}; }

  function allNodes(){ var out=[],i; for(i=0;i<segs.length;i++){ var s=segs[i]; out.push(s.a,s.b);} return out; }
  function snapToNodes(raw){ if(!magnetOn) return raw; var R=params.snapRadiusPx/view.scale; var best=null,bd=1e9,i;
    var nodes=allNodes(); for(i=0;i<nodes.length;i++){ var n=nodes[i]; var dx=n.x-raw.x,dy=n.y-raw.y; var d=Math.sqrt(dx*dx+dy*dy); if(d<bd){ bd=d; best=n; } }
    return (best && bd<=R) ? {x:best.x,y:best.y,_snapped:true} : raw;
  }

  function drawSegments(){
    ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);
    var col=params.lineColor, sh=darker(col,0.45), i,s;
    for(i=0;i<segs.length;i++){
      s=segs[i];
      ctx.strokeStyle=sh; ctx.globalAlpha=.75; ctx.lineWidth=(params.linePx+2)/view.scale;
      ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
      ctx.strokeStyle=col; ctx.globalAlpha=1; ctx.lineWidth=(params.linePx)/view.scale;
      ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
    }
  }
  function drawBadge(sx,sy,txt){
    ctx.setTransform(1,0,0,1,0,0); ctx.font='700 11px system-ui,-apple-system,Segoe UI,Roboto';
    var pad=6,h=18,r=7, w=ctx.measureText(txt).width+pad*2, x=sx+8, y=sy-8-h;
    var rr=Math.min(r,w/2,h/2);
    ctx.fillStyle='rgba(255,255,255,.96)'; ctx.strokeStyle='#111'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.fillStyle='#111'; ctx.textBaseline='middle'; ctx.fillText(txt,x+pad,y+h/2);
  }
  function drawHandleMarker(pt){ var p=w2s(pt.x,pt.y); ctx.setTransform(1,0,0,1,0,0); ctx.fillStyle='#16a34a'; ctx.strokeStyle='#0f5132'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(p.x,p.y,9,0,Math.PI*2); ctx.fill(); ctx.stroke(); }

  /* ==== –∞—Ä–º–∞—Ç—É—Ä–∞ (–∫–∞–∫ –≤ –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–∏) ==== */
  function drawBallValve(seg,t){
    var b=compBasis(seg,t), base=params.linePx*compScale;
    var bodyLen=base*10.5, bodyR=base*2.6, coneL=base*3.2, pipeR=base*1.4, ballR=base*2.0, neckH=base*2.6, neckR=base*0.9, handleL=base*6.5, handleW=base*0.9;
    var ux=b.ux, uy=b.uy, nx=b.nx, ny=b.ny;
    var L={x:b.x-ux*bodyLen/2,y:b.y-uy*bodyLen/2}, R={x:b.x+ux*bodyLen/2,y:b.y+uy*bodyLen/2};
    var P1={x=L.x-ux*coneL,y=L.y-uy*coneL}, P2={x:R.x+ux*coneL,y:R.y+uy*coneL};
    ctx.save(); ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty); ctx.lineJoin='round'; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(L.x-nx*bodyR, L.y-ny*bodyR); ctx.lineTo(R.x-nx*bodyR, R.y-ny*bodyR);
    ctx.arc(R.x,R.y,bodyR, Math.atan2(-ny,-nx), Math.atan2(ny,-nx), false);
    ctx.lineTo(L.x+nx*bodyR, L.y+ny*bodyR);
    ctx.arc(L.x,L.y,bodyR, Math.atan2(ny,nx), Math.atan2(-ny,nx), false);
    ctx.closePath(); ctx.fillStyle='#6b1dff'; ctx.fill(); ctx.lineWidth=2/view.scale; ctx.strokeStyle='#2b145f'; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(P1.x-nx*pipeR,P1.y-ny*pipeR); ctx.lineTo(L.x-nx*bodyR,L.y-ny*bodyR);
    ctx.lineTo(L.x+nx*bodyR,L.y+ny*bodyR); ctx.lineTo(P1.x+nx*pipeR,P1.y+ny*pipeR);
    ctx.closePath(); ctx.fillStyle='#6b1dff'; ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(R.x-nx*bodyR,R.y-ny*bodyR); ctx.lineTo(P2.x-nx*pipeR,P2.y-ny*pipeR);
    ctx.lineTo(P2.x+nx*pipeR,P2.y+ny*pipeR); ctx.lineTo(R.x+nx*bodyR,R.y+ny*bodyR);
    ctx.closePath(); ctx.fillStyle='#6b1dff'; ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.arc(b.x,b.y,ballR,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill(); ctx.strokeStyle='#1b1b1b'; ctx.stroke();
    var top={x:b.x+nx*bodyR, y:b.y+ny*bodyR}, neckTop={x:top.x+nx*neckH, y:top.y+ny*neckH};
    ctx.beginPath(); ctx.arc(b.x,b.y,neckR,0,Math.PI*2); ctx.lineWidth=2/view.scale; ctx.strokeStyle='#1b1b1b'; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(top.x,top.y); ctx.lineTo(neckTop.x,neckTop.y); ctx.stroke();
    var hw=handleW/2; ctx.fillStyle='#111';
    ctx.beginPath(); ctx.moveTo(neckTop.x-nx*hw, neckTop.y-ny*hw);
    ctx.lineTo(neckTop.x+ux*handleL-nx*hw, neckTop.y+uy*handleL-ny*hw);
    ctx.lineTo(neckTop.x+ux*handleL+nx*hw, neckTop.y+uy*handleL+ny*hw);
    ctx.lineTo(neckTop.x+nx*hw, neckTop.y+ny*hw);
    ctx.closePath(); ctx.fill();
    ctx.restore(); var S=w2s(b.x,b.y); drawBadge(S.x,S.y,'BALL');
  }

  function drawCheckValve(seg,t){
    var b=compBasis(seg,t), base=params.linePx*compScale;
    var bodyLen=base*9.5, bodyR=base*2.4, coneL=base*3.2, pipeR=base*1.4;
    var ux=b.ux, uy=b.uy, nx=b.nx, ny=b.ny;
    var L={x:b.x-ux*bodyLen/2,y:b.y-uy*bodyLen/2}, R={x:b.x+ux*bodyLen/2,y:b.y+uy*bodyLen/2};
    var P1={x=L.x-ux*coneL,y=L.y-uy*coneL}, P2={x:R.x+ux*coneL,y:R.y+uy*coneL};
    ctx.save(); ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty); ctx.lineJoin='round'; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(L.x-nx*bodyR, L.y-ny*bodyR); ctx.lineTo(R.x-nx*bodyR, R.y-ny*bodyR);
    ctx.arc(R.x,R.y,bodyR, Math.atan2(-ny,-nx), Math.atan2(ny,-nx), false);
    ctx.lineTo(L.x+nx*bodyR, L.y+ny*bodyR);
    ctx.arc(L.x,L.y,bodyR, Math.atan2(ny,nx), Math.atan2(-ny,nx), false);
    ctx.closePath(); ctx.fillStyle='#6b1dff'; ctx.fill(); ctx.lineWidth=2/view.scale; ctx.strokeStyle='#2b145f'; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(P1.x-nx*pipeR,P1.y-ny*pipeR); ctx.lineTo(L.x-nx*bodyR,L.y-ny*bodyR);
    ctx.lineTo(L.x+nx*bodyR,L.y+ny*bodyR); ctx.lineTo(P1.x+nx*pipeR,P1.y+ny*pipeR);
    ctx.closePath(); ctx.fillStyle='#6b1dff'; ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(R.x-nx*bodyR,R.y-ny*bodyR); ctx.lineTo(P2.x-nx*pipeR,P2.y-ny*pipeR);
    ctx.lineTo(P2.x+nx*pipeR,P2.y+ny*pipeR); ctx.lineTo(R.x+nx*bodyR,R.y+ny*bodyR);
    ctx.closePath(); ctx.fillStyle='#6b1dff'; ctx.fill(); ctx.stroke();
    var triLen=bodyLen*0.45, triHalf=bodyR*0.55;
    var A={x:b.x + b.ux*triLen/2, y:b.y + b.uy*triLen/2};
    var B={x:b.x - b.ux*triLen/2 + b.nx*triHalf, y:b.y - b.uy*triLen/2 + b.ny*triHalf};
    var C={x:b.x - b.ux*triLen/2 - b.nx*triHalf, y:b.y - b.uy*triLen/2 - b.ny*triHalf};
    ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.lineTo(C.x,C.y); ctx.closePath();
    ctx.fillStyle='rgba(255,255,255,0.85)'; ctx.fill(); ctx.strokeStyle='#1b1b1b'; ctx.stroke();
    ctx.restore(); var S=w2s(b.x,b.y); drawBadge(S.x,S.y,'CHECK');
  }

  function drawPump(seg,t){
    var b=compBasis(seg,t), base=params.linePx*compScale;
    var volR=base*4.2, flLen=base*2.6, flHalf=base*1.6, motorW=base*5.2, motorH=base*7.2, sockH=base*1.4;
    var ux=b.ux, uy=b.uy, nx=b.nx, ny=b.ny;
    var Lc={x:b.x-ux*(volR+flLen*0.9), y:b.y-uy*(volR+flLen*0.9)}, Rc={x:b.x+ux*(volR+flLen*0.9), y:b.y+uy*(volR+flLen*0.9)};
    ctx.save(); ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty); ctx.lineJoin='round'; ctx.lineCap='round';
    ctx.fillStyle='#6b1dff'; ctx.strokeStyle='#2b145f'; ctx.lineWidth=2.2/view.scale;
    ctx.beginPath(); ctx.arc(b.x,b.y,volR,0,Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.arc(b.x,b.y,volR*0.6,0,Math.PI*2); ctx.strokeStyle='#1b1b1b'; ctx.lineWidth=1.6/view.scale; ctx.stroke();
    function flange(cx,cy){
      var ax=ux*(flLen/2), ay=uy*(flLen/2), px=nx*flHalf, py=ny*flHalf;
      ctx.fillStyle='#6b1dff'; ctx.strokeStyle='#2b145f'; ctx.lineWidth=2.0/view.scale;
      ctx.beginPath(); ctx.moveTo(cx-ax-px, cy-ay-py); ctx.lineTo(cx+ax-px, cy+ay-py); ctx.lineTo(cx+ax+px, cy+ay+py); ctx.lineTo(cx-ax+px, cy-ay+py);
      ctx.closePath(); ctx.fill(); ctx.stroke();
      ctx.beginPath(); ctx.arc(cx,cy,flHalf*0.45,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill(); ctx.strokeStyle='#1b1b1b'; ctx.lineWidth=1.6/view.scale; ctx.stroke();
    }
    flange(Lc.x,Lc.y); flange(Rc.x,Rc.y);
    var baseTop={x:b.x+nx*(volR+sockH), y:b.y+ny*(volR+sockH)};
    var mL={x:baseTop.x - nx*(motorW/2), y:baseTop.y - ny*(motorW/2)};
    var mR={x:baseTop.x + nx*(motorW/2), y:baseTop.y + ny*(motorW/2)};
    var mT={x:baseTop.x + nx*(motorW/2) + ux*motorH, y:baseTop.y + ny*(motorW/2) + uy*motorH};
    var mB={x:baseTop.x - nx*(motorW/2) + ux*motorH, y:baseTop.y - ny*(motorW/2) + uy*motorH};
    ctx.fillStyle='#6b1dff'; ctx.strokeStyle='#2b145f'; ctx.lineWidth=2.0/view.scale;
    ctx.beginPath(); ctx.moveTo(mL.x,mL.y); ctx.lineTo(mB.x,mB.y); ctx.lineTo(mT.x,mT.y); ctx.lineTo(mR.x,mR.y); ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.strokeStyle='#1b1b1b'; ctx.lineWidth=1.2/view.scale;
    var i; for(i=1;i<6;i++){ var tpos=i/6; var a={x:mL.x + ux*motorH*tpos, y:mL.y + uy*motorH*tpos}; var bpt={x:mR.x + ux*motorH*tpos, y:mR.y + uy*motorH*tpos}; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(bpt.x,bpt.y); ctx.stroke(); }
    ctx.restore(); var S=w2s(b.x,b.y); drawBadge(S.x,S.y,'PUMP');
  }

  function draw(){
    ctx.setTransform(1,0,0,1,0,0); ctx.fillStyle='#fff'; ctx.fillRect(0,0,cv.width,cv.height);
    if(bg){ ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty); ctx.drawImage(bg,0,0,bw,bh); }
    drawSegments();
    var i,c,seg;
    for(i=0;i<comps.length;i++){
      c=comps[i]; seg=segs[c.segIndex]; if(!seg) continue;
      if(c.type==='valve') drawBallValve(seg,c.t);
      else if(c.type==='check') drawCheckValve(seg,c.t);
      else if(c.type==='pump') drawPump(seg,c.t);
    }
    if(hoverSnap && hoverSnap._snapped){
      var p=w2s(hoverSnap.x,hoverSnap.y);
      ctx.setTransform(1,0,0,1,0,0); ctx.fillStyle='#16a34a'; ctx.strokeStyle='#0f5132'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(p.x,p.y,8,0,Math.PI*2); ctx.fill(); ctx.stroke();
    }
    if(first){ var p2=w2s(first.x,first.y); ctx.setTransform(1,0,0,1,0,0); ctx.fillStyle='#ff3b30'; ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(p2.x,p2.y,7,0,Math.PI*2); ctx.fill(); ctx.stroke(); }
    if(first && preview){
      ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);
      ctx.setLineDash([12/view.scale,8/view.scale]); ctx.strokeStyle=params.lineColor; ctx.lineWidth=Math.max(3,params.linePx-2)/view.scale;
      ctx.beginPath(); ctx.moveTo(first.x,first.y); ctx.lineTo(preview.x,preview.y); ctx.stroke(); ctx.setLineDash([]);
      var p3=w2s(preview.x,preview.y); ctx.setTransform(1,0,0,1,0,0); ctx.fillStyle=params.lineColor; ctx.beginPath(); ctx.arc(p3.x,p3.y,6,0,Math.PI*2); ctx.fill();
    }
    if(mode==='edit' && editing){ var s=segs[editing.segIndex]; drawHandleMarker(editing.end==='a'?s.a:s.b); }
  }
  var raf=0, dirty=false; function need(){ dirty=true; if(!raf){ raf=requestAnimationFrame(function(){ raf=0; if(dirty){ dirty=false; draw(); } }); } }

  function findEndpointNear(sx,sy,rPx){ if(rPx===void 0) rPx=20;
    var best=null,bd=1e9,i; for(i=0;i<segs.length;i++){
      var s=segs[i], A=w2s(s.a.x,s.a.y), B=w2s(s.b.x,s.b.y);
      var dA=Math.sqrt(Math.pow(A.x-sx,2)+Math.pow(A.y-sy,2));
      var dB=Math.sqrt(Math.pow(B.x-sx,2)+Math.pow(B.y-sy,2));
      if(dA<bd && dA<=rPx){ best={segIndex:i,end:'a'}; bd=dA; } if(dB<bd && dB<=rPx){ best={segIndex:i,end:'b'}; bd=dB; }
    } return best;
  }
  function findNearestSegment(sx,sy,maxDistPx){ if(maxDistPx===void 0) maxDistPx=28;
    var bestI=-1,bd=1e9,bt=0,i; for(i=0;i<segs.length;i++){
      var s=segs[i], A=w2s(s.a.x,s.a.y), B=w2s(s.b.x,s.b.y);
      var vx=B.x-A.x, vy=B.y-A.y, len2=vx*vx+vy*vy; if(len2===0) continue;
      var t=Math.max(0,Math.min(1,((sx-A.x)*vx+(sy-A.y)*vy)/len2));
      var px=A.x+vx*t, py=A.y+vy*t, d=Math.sqrt(Math.pow(px-sx,2)+Math.pow(py-sy,2));
      if(d<bd){ bd=d; bestI=i; bt=t; }
    }
    return (bestI!==-1 && bd<=maxDistPx) ? {segIndex:bestI,t:bt} : null;
  }

  var TAP_TIME=300, TAP_MOVE=14*DPR, HOLD_MS=500;
  var pointers=new Map(), downs=new Map();
  var prevCenter=null, prevDist=null, holdTimer=null, holdId=null;

  function centroid(){ var a=Array.from(pointers.values()); if(!a.length) return null; var i,sx=0,sy=0; for(i=0;i<a.length;i++){ sx+=a[i].sx; sy+=a[i].sy; } return {sx:sx/a.length, sy:sy/a.length}; }
  function canvasXY(e){ var r=cv.getBoundingClientRect(); return { sx:(e.clientX-r.left)*(cv.width/r.width), sy:(e.clientY-r.top)*(cv.height/r.height) }; }

  cv.addEventListener('pointerdown', function(e){
    e.preventDefault(); try{ cv.setPointerCapture(e.pointerId); }catch(_){}
    var pos=canvasXY(e);
    pointers.set(e.pointerId,{sx:pos.sx,sy:pos.sy});
    downs.set(e.pointerId,{t0:performance.now(),sx:pos.sx,sy:pos.sy});
    if(pointers.size===2){
      var arr=Array.from(pointers.values()); prevCenter=centroid();
      prevDist=Math.sqrt(Math.pow(arr[0].sx-arr[1].sx,2)+Math.pow(arr[0].sy-arr[1].sy,2));
      clearTimeout(holdTimer); holdTimer=null; holdId=null;
    }else if(pointers.size===1 && !first && mode!=='place'){
      holdId=e.pointerId;
      holdTimer=setTimeout(function(){
        var d=downs.get(holdId), pt=pointers.get(holdId); if(!d||!pt) return;
        var mv=Math.sqrt(Math.pow(pt.sx-d.sx,2)+Math.pow(pt.sy-d.sy,2));
        if(mv<=TAP_MOVE){
          var hit=findEndpointNear(pt.sx,pt.sy,24*DPR);
          if(hit){ mode='edit'; editing=hit; need(); toast('–ü—Ä–∞–≤–∫–∞ –∫–æ–Ω—Ü–∞: –ø–µ—Ä–µ—Ç–∞—â–∏ –∏ –æ—Ç–ø—É—Å—Ç–∏'); }
        }
      },HOLD_MS);
    }
  }, {passive:false});

  cv.addEventListener('pointermove', function(e){
    if(!pointers.has(e.pointerId)) return;
    var pos=canvasXY(e); pointers.set(e.pointerId,{sx:pos.sx,sy:pos.sy});
    if(pointers.size===2){
      var arr=Array.from(pointers.values()); var nowCenter=centroid(); var nowDist=Math.sqrt(Math.pow(arr[0].sx-arr[1].sx,2)+Math.pow(arr[0].sy-arr[1].sy,2));
      if(prevCenter && prevDist && nowCenter){
        var k=(nowDist>0 && prevDist>0)?(nowDist/prevDist):1;
        view.tx = nowCenter.sx - k*(nowCenter.sx - view.tx);
        view.ty = nowCenter.sy - k*(nowCenter.sy - view.ty);
        view.scale = Math.max(0.2, Math.min(8, view.scale*k));
        view.tx += (nowCenter.sx - prevCenter.sx);
        view.ty += (nowCenter.sy - prevCenter.sy);
        clampView(); need();
      }
      prevCenter=nowCenter; prevDist=nowDist; clearTimeout(holdTimer); holdTimer=null; holdId=null; return;
    }
    var only=Array.from(pointers.values())[0];
    if(mode==='edit' && editing){
      var W=snapToNodes(s2w(only.sx,only.sy)); hoverSnap=W._snapped?W:null;
      var s=segs[editing.segIndex]; if(editing.end==='a') s.a={x:W.x,y:W.y}; else s.b={x:W.x,y:W.y}; need(); return;
    }
    if(mode==='hand'){ var d=downs.get(e.pointerId); if(d){ view.tx+=(only.sx-d.sx); view.ty+=(only.sy-d.sy); d.sx=only.sx; d.sy=only.sy; clampView(); need(); } }
    if(mode==='line' && first){ var W2=snapToNodes(s2w(only.sx,only.sy)); hoverSnap=W2._snapped?W2:null; preview=W2; need(); } else { hoverSnap=null; }
  }, {passive:false});

  cv.addEventListener('pointerup', function(e){
    var d=downs.get(e.pointerId);
    var p=pointers.get(e.pointerId)||{sx:0,sy:0};
    var isTap = !!d && (performance.now()-d.t0<=TAP_TIME) && (Math.sqrt(Math.pow(p.sx-d.sx,2)+Math.pow(p.sy-d.sy,2))<=TAP_MOVE);

    if(mode==='edit' && editing){
      var W=snapToNodes(s2w(p.sx,p.sy)); var s=segs[editing.segIndex]; if(editing.end==='a') s.a={x:W.x,y:W.y}; else s.b={x:W.x,y:W.y};
      mode='hand'; editing=null; hoverSnap=null; need();
    }else if(isTap && mode==='line'){
      var W3=snapToNodes(s2w(p.sx,p.sy));
      if(!first){ first={x:W3.x,y:W3.y}; preview=null; hoverSnap=W3._snapped?W3:null; need(); }
      else{ segs.push({a:first,b:{x:W3.x,y:W3.y}}); history.push('seg'); first=null; preview=null; mode='hand'; hoverSnap=null; need(); toast('–°–µ–≥–º–µ–Ω—Ç –≥–æ—Ç–æ–≤'); }
    }else if(isTap && mode==='place'){
      var near=findNearestSegment(p.sx,p.sy,28*DPR);
      if(near){ comps.push({segIndex:near.segIndex,t:near.t,type:currentComp}); history.push('comp'); mode='hand'; need(); toast('–ê—Ä–º–∞—Ç—É—Ä–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'); }
      else{ toast('–¢–∫–Ω–∏ –ø–æ –ª–∏–Ω–∏–∏, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –∞—Ä–º–∞—Ç—É—Ä—É'); }
    }

    downs.delete(e.pointerId); pointers.delete(e.pointerId);
    if(pointers.size<2){ prevCenter=null; prevDist=null; }
    clearTimeout(holdTimer); holdTimer=null; holdId=null;
  }, {passive:false});
  cv.addEventListener('pointercancel', function(e){
    downs.delete(e.pointerId); pointers.delete(e.pointerId);
    if(pointers.size<2){ prevCenter=null; prevDist=null; }
    clearTimeout(holdTimer); holdTimer=null; holdId=null;
  }, {passive:false});

  /* === UI === */
  var panelWrap=$('panelWrap'), backdrop=$('panelBackdrop'), panel=$('panel');
  function openPanel(){ panelWrap.classList.add('open'); panelWrap.setAttribute('aria-hidden','false'); }
  function closePanel(){ panelWrap.classList.remove('open'); panelWrap.setAttribute('aria-hidden','true'); }
  $('btnSettings').onclick=openPanel; $('btnClosePanel').onclick=closePanel; backdrop.onclick=closePanel;
  ['pointerdown','pointermove','pointerup','click','wheel'].forEach(function(ev){ panel.addEventListener(ev,function(e){ e.stopPropagation(); },{passive:false}); });

  $('btnLine').onclick=function(){ mode='line'; first=null; preview=null; hoverSnap=null; toast('–†–µ–∂–∏–º: –ª–∏–Ω–∏—è (—Ç–∞–ø-—Ç–∞–ø)'); };
  $('btnHand').onclick=function(){ mode='hand'; first=null; preview=null; hoverSnap=null; toast('–†—É–∫–∞: –ø–∞–Ω/–∑—É–º ‚Äî 2 –ø–∞–ª—å—Ü–∞; –ø–∞–Ω –æ–¥–Ω–∏–º –ø–∞–ª—å—Ü–µ–º –≤ —Ä–µ–∂–∏–º–µ ¬´–†—É–∫–∞¬ª'); };

  $('btnUndo').onclick=function(){
    if(mode==='edit'&&editing){ mode='hand'; editing=null; need(); return; }
    if(mode==='place'){ mode='hand'; toast('–û—Ç–º–µ–Ω–∞'); return; }
    if(first){ first=null; preview=null; hoverSnap=null; need(); return; }
    var last=history.pop();
    if(!last){ toast('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å'); return; }
    if(last==='seg' && segs.length) segs.pop();
    else if(last==='comp' && comps.length) comps.pop();
    need();
  };

  var currentComp='valve';
  var radios=document.querySelectorAll('input[name="comp"]');
  for(var i=0;i<radios.length;i++){ radios[i].addEventListener('change',function(){ currentComp=this.value; }); }

  var scaleInput=$('scale'), scaleVal=$('scaleVal');
  var thickInput=$('thick'), thickVal=$('thickVal');
  var snapInput=$('snap'),  snapVal=$('snapVal');
  function updateScale(){ compScale=Number(scaleInput.value)/100; scaleVal.textContent=compScale.toFixed(2)+'√ó'; need(); }
  function updateThick(){ params.linePx=Number(thickInput.value); thickVal.textContent=params.linePx+' px'; need(); }
  function updateSnap(){ params.snapRadiusPx=Number(snapInput.value); snapVal.textContent=params.snapRadiusPx+' px'; }
  scaleInput.addEventListener('input',updateScale);
  thickInput.addEventListener('input',updateThick);
  snapInput.addEventListener('input',updateSnap);
  updateScale(); updateThick(); updateSnap();

  var mag=document.querySelectorAll('input[name="mag"]');
  for(i=0;i<mag.length;i++){ mag[i].addEventListener('change',function(){ magnetOn=(this.value==='on'); }); }

  function resetInputs(){ var c=$('fileCam'), g=$('fileGal'); if(c) c.value=''; if(g) g.value=''; }
  function loadImageFile(f){
    if(!f) return;
    var img=new Image(); var url=URL.createObjectURL(f);
    img.onload=function(){ var maxSide=Math.max(img.naturalWidth,img.naturalHeight);
      var w=img.naturalWidth, h=img.naturalHeight;
      if(maxSide>2200){ var sc=2200/maxSide; w=Math.round(w*sc); h=Math.round(h*sc); }
      var c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d',{alpha:false}).drawImage(img,0,0,w,h);
      bg=c; bw=w; bh=h; fitToScreen(); need(); toast('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ'); URL.revokeObjectURL(url); resetInputs();
    };
    img.onerror=function(){ URL.revokeObjectURL(url); resetInputs(); toast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'); };
    img.src=url;
  }
  $('fileCam').onchange=function(e){ loadImageFile(e.target.files && e.target.files[0]); };
  $('fileGal').onchange=function(e){ loadImageFile(e.target.files && e.target.files[0]); };
  $('btnExport').onclick=function(){ try{ var url=cv.toDataURL('image/png',0.95); var a=document.createElement('a'); a.href=url; a.download='ProTrace.png'; a.click(); }catch(e){ toast('–≠–∫—Å–ø–æ—Ä—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'); } };

  $('btnPlaceComp').onclick=function(){ closePanel(); mode='place'; toast('–¢–∫–Ω–∏ –ø–æ –ª–∏–Ω–∏–∏ ‚Äî –ø–æ—Å—Ç–∞–≤–ª—é –∞—Ä–º–∞—Ç—É—Ä—É'); };

  fit(); status('–ì–æ—Ç–æ–≤–æ'); toast('–ì–æ—Ç–æ–≤–æ: v837');
})();
</script>
</body>
</html>