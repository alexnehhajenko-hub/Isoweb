<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace ‚Äî —Ñ–æ—Ç–æ + —Å–µ—Ç–∫–∞ + –ª–∏–Ω–∏–∏ (–æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º)</title>
<style>
  :root{--violet:#6b1dff; --violet2:#7c5bff; --ink:#14161a; --pane:#ffffff; --shadow:0 10px 30px rgba(0,0,0,.12)}
  html,body{margin:0;height:100%;background:#f0f2f5;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  #cv{position:fixed;inset:0;display:block;width:100vw;height:100vh;touch-action:none;-webkit-user-select:none;user-select:none}

  /* UI */
  .bar{position:fixed;left:12px;top:10px;z-index:10;display:flex;gap:8px;flex-wrap:wrap}
  .btn{height:40px;padding:0 12px;border:0;border-radius:12px;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff;font-weight:700;box-shadow:var(--shadow)}
  .btn.ghost{background:#2f3238;color:#e9ecf3}
  .btn.small{height:32px;font-size:13px;padding:0 10px}

  .status{position:fixed;left:12px;bottom:12px;background:rgba(0,0,0,.78);color:#eaf2ff;padding:6px 10px;border-radius:10px;font-size:13px;z-index:11;max-width:92vw}

  .panel{position:fixed;right:12px;top:56px;z-index:12;min-width:220px;max-width:80vw;
    background:var(--pane);color:#111;border-radius:16px;box-shadow:var(--shadow);padding:12px 12px 10px;display:none}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 0}
  .panel input[type=range]{width:140px}
  .panel .title{font-weight:800;color:#2b2f36;margin-bottom:2px}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="bar">
    <button id="btnLine"  class="btn">üìê –õ–∏–Ω–∏—è</button>
    <button id="btnUndo"  class="btn ghost">‚Ü© –ù–∞–∑–∞–¥</button>
    <button id="btnPhoto" class="btn ghost">üì∑ –§–æ—Ç–æ</button>
    <button id="btnCenter" class="btn ghost">üéØ –¶–µ–Ω—Ç—Ä</button>
    <button id="btnGear"  class="btn ghost small" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öô</button>
  </div>

  <div id="panel" class="panel">
    <div class="title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <div class="row"><span>√ò —Ç—Ä—É–±—ã</span><input id="rngWidth" type="range" min="6" max="40" value="14"></div>
    <div class="row"><span>–°–µ—Ç–∫–∞</span><input id="rngGridA" type="range" min="0" max="100" value="40"></div>
    <div class="row"><button id="btnClose" class="btn small ghost" style="width:100%">–ù–∞–∑–∞–¥</button></div>
  </div>

  <div id="status" class="status">–°—Ç–∞—Ç—É—Å: –∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

<script>
(()=>{"use strict";
/* ===== –±–∞–∑–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===== */
const DPR=Math.min(2,Math.max(1,window.devicePixelRatio||1));
const cv=document.getElementById('cv');
const ctx=cv.getContext('2d',{alpha:false});
const statusEl=document.getElementById('status');
const panel=document.getElementById('panel');

const view={tx:0,ty:0,scale:1};                  // —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –º–∏—Ä–∞ ‚Üí —ç–∫—Ä–∞–Ω
const clampScale=s=>Math.max(0.25,Math.min(6,s));
const state={ tool:'idle', mode:'hand', first:null, preview:null };

const segs=[];          // –≥–æ—Ç–æ–≤—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã (—Ç—Ä—É–±—ã)
const stack=[];         // —Å—Ç–µ–∫ –¥–ª—è ¬´–ù–∞–∑–∞–¥¬ª

const params={
  linePx:14,                          // —Ç–æ–ª—â–∏–Ω–∞ ¬´—Ç—Ä—É–±—ã¬ª
  lineColor:'#2b72ff',                // —Ü–≤–µ—Ç —Ç—Ä—É–±—ã
  endCap:'#e9f0ff',                   // —Ü–≤–µ—Ç ¬´—Ç–æ—Ä—Ü–∞¬ª
  grid:{ step:80, alpha:0.40 },       // —Å–µ—Ç–∫–∞
  bgColor:'#eef1f5'                   // —Ñ–æ–Ω, –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ
};
let bgImage=null;                     // —Ñ–æ–Ω-—Ñ–æ—Ç–æ (HTMLImageElement|null)

/* ===== —É—Ç–∏–ª–∏—Ç—ã ===== */
function updateStatus(msg=''){
  const t = state.tool==='awaitFirst' ? '–ñ–¥—É 1-—é —Ç–æ—á–∫—É'
        : state.tool==='awaitSecond'? '–ñ–¥—É 2-—é —Ç–æ—á–∫—É'
        : '–ì–æ—Ç–æ–≤';
  statusEl.textContent=`–°—Ç–∞—Ç—É—Å: ${msg||'‚Äî'} ${msg?'| ':''}${t}`;
}
function fit(){ cv.width=Math.round(innerWidth*DPR); cv.height=Math.round(innerHeight*DPR); need(); }
addEventListener('resize',fit,{passive:true});
function s2w(sx,sy){ return {x:(sx-view.tx)/view.scale, y:(sy-view.ty)/view.scale}; }
function w2s(x,y){ return {x:x*view.scale+view.tx, y:y*view.scale+view.ty}; }
let raf=0,dirty=false; function need(){ dirty=true; if(!raf){ raf=requestAnimationFrame(()=>{raf=0;if(dirty){dirty=false;draw();}});} }

/* ===== —Ä–∏—Å–æ–≤–∞–Ω–∏–µ ===== */
function drawBackground(){
  ctx.setTransform(1,0,0,1,0,0);
  if(bgImage && bgImage.complete){
    // –≤–ø–∏—Å—ã–≤–∞–µ–º —Ñ–æ—Ç–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É –±–µ–∑ –∏—Å–∫–∞–∂–µ–Ω–∏–π
    const cw=cv.width, ch=cv.height;
    const iw=bgImage.naturalWidth, ih=bgImage.naturalHeight;
    const k=Math.min(cw/iw, ch/ih);
    const w=iw*k, h=ih*k, x=(cw-w)/2, y=(ch-h)/2;
    ctx.drawImage(bgImage,x,y,w,h);
  }else{
    ctx.fillStyle=params.bgColor;
    ctx.fillRect(0,0,cv.width,cv.height);
  }
}
function drawGrid(){
  ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);
  const step=params.grid.step, a=params.grid.alpha;
  ctx.lineWidth=1/view.scale;
  // —Ç–æ–Ω–∫–∏–µ
  ctx.strokeStyle=`rgba(90,100,120,${0.12*a})`;
  ctx.beginPath();
  const minX=(-view.tx)/view.scale, minY=(-view.ty)/view.scale;
  const maxX=(cv.width -view.tx)/view.scale, maxY=(cv.height-view.ty)/view.scale;
  const x0=Math.floor(minX/step)*step, y0=Math.floor(minY/step)*step;
  for(let x=x0;x<=maxX;x+=step){ ctx.moveTo(x,minY); ctx.lineTo(x,maxY); }
  for(let y=y0;y<=maxY;y+=step){ ctx.moveTo(minX,y); ctx.lineTo(maxX,y); }
  ctx.stroke();
  // –æ—Å–∏
  ctx.strokeStyle=`rgba(0,90,255,${0.45*a})`; ctx.beginPath(); ctx.moveTo(0,minY); ctx.lineTo(0,maxY); ctx.stroke();
  ctx.strokeStyle=`rgba(255,60,0,${0.45*a})`;  ctx.beginPath(); ctx.moveTo(minX,0); ctx.lineTo(maxX,0); ctx.stroke();
}

function drawSegments(){
  ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);
  for(const s of segs){
    // —Ç–µ–Ω—å
    ctx.lineCap='round';
    ctx.strokeStyle='rgba(0,0,0,.12)';
    ctx.lineWidth=(params.linePx+3)/view.scale;
    ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
    // —Å–∞–º–∞ ¬´—Ç—Ä—É–±–∞¬ª
    ctx.strokeStyle=params.lineColor;
    ctx.lineWidth=params.linePx/view.scale;
    ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
    // —Ç–æ—Ä—Ü—ã
    ctx.fillStyle=params.endCap;
    ctx.beginPath(); ctx.arc(s.a.x,s.a.y,(params.linePx/2)/view.scale,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(s.b.x,s.b.y,(params.linePx/2)/view.scale,0,Math.PI*2); ctx.fill();
  }
}
function drawPreview(){
  if(state.tool!=='awaitSecond' || !state.first || !state.preview) return;
  ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);
  ctx.lineCap='round';
  ctx.strokeStyle=params.lineColor;
  ctx.lineWidth=params.linePx/view.scale;
  ctx.beginPath(); ctx.moveTo(state.first.x,state.first.y); ctx.lineTo(state.preview.x,state.preview.y); ctx.stroke();
}

function draw(){
  drawBackground();
  drawGrid();
  drawSegments();
  drawPreview();
}

/* ===== —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –∑—É–º/–ø–∞–Ω ===== */
const pointers=new Map();let isPanning=false,panLast=null;let prevCenter=null,prevDist=null;
function canvasXY(e){const r=cv.getBoundingClientRect();return{sx:(e.clientX-r.left)*(cv.width/r.width),sy:(e.clientY-r.top)*(cv.height/r.height)};}
function centroid(){const a=[...pointers.values()];if(!a.length)return null;let sx=0,sy=0;for(const p of a){sx+=p.sx;sy+=p.sy;}return{sx:sx/a.length,sy:sy/a.length};}
function dist2(a,b){return Math.abs(a.sx-b.sx)+Math.abs(a.sy-b.sy);}

cv.addEventListener('pointerdown',e=>{
  const {sx,sy}=canvasXY(e); pointers.set(e.pointerId,{sx,sy});
  if(pointers.size===2){ const[p0,p1]=[...pointers.values()]; prevCenter=centroid(); prevDist=dist2(p0,p1); return; }

  // –ù–ï –ø–∞–Ω–æ—Ä–∞–º–∏—Ä—É–µ–º –æ–¥–Ω–∏–º –ø–∞–ª—å—Ü–µ–º ‚Äî —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–∫–∏
  if(state.tool==='awaitFirst'){ state.first=s2w(sx,sy); state.preview=null; state.tool='awaitSecond'; updateStatus('1-—è —Ç–æ—á–∫–∞ –µ—Å—Ç—å'); need(); return; }
  if(state.tool==='awaitSecond'){ state.preview=s2w(sx,sy); segs.push({a:state.first,b:state.preview}); stack.push('seg'); state.first=null; state.preview=null; state.tool='idle'; updateStatus('–°–µ–≥–º–µ–Ω—Ç –≥–æ—Ç–æ–≤. –î–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –Ω–∞–∂–º–∏ ¬´–õ–∏–Ω–∏—è¬ª.'); need(); return; }
},{passive:true});

cv.addEventListener('pointermove',e=>{
  if(!pointers.has(e.pointerId)) return;
  const {sx,sy}=canvasXY(e); pointers.set(e.pointerId,{sx,sy});
  if(pointers.size===2){
    const nowC=centroid(); const[p0,p1]=[...pointers.values()]; const nowD=dist2(p0,p1);
    if(prevCenter&&prevDist){
      const k=nowD>0&&prevDist>0?(nowD/prevDist):1;
      const ns=clampScale(view.scale*k);
      const cx=nowC.sx,cy=nowC.sy;
      view.tx=cx-(cx-view.tx)*(ns/view.scale);
      view.ty=cy-(cy-view.ty)*(ns/view.scale);
      view.scale=ns; need();
    }
    prevCenter=nowC; prevDist=nowD; return;
  }
  if(state.tool==='awaitSecond'&&state.first){ state.preview=s2w(sx,sy); need(); }
},{passive:true});

cv.addEventListener('pointerup',e=>{ pointers.delete(e.pointerId); if(pointers.size<2){prevCenter=null;prevDist=null;} },{passive:true});

/* ===== –∫–Ω–æ–ø–∫–∏ ===== */
const $=id=>document.getElementById(id);
$('btnLine').onclick = ()=>{ state.tool='awaitFirst'; state.first=null; state.preview=null; updateStatus('–†–µ–∂–∏–º –õ–∏–Ω–∏—è: —Ç–∫–Ω–∏ 1-—é —Ç–æ—á–∫—É'); };
$('btnUndo').onclick = ()=>{
  if(state.tool==='awaitSecond'&&state.first){ state.first=null; state.preview=null; state.tool='idle'; need(); updateStatus('–°–µ–≥–º–µ–Ω—Ç –æ—Ç–º–µ–Ω—ë–Ω'); return; }
  const last=stack.pop(); if(!last){ updateStatus('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å'); return; }
  if(last==='seg'&&segs.length) segs.pop(); need(); updateStatus('–û—Ç–º–µ–Ω–µ–Ω–æ');
};
$('btnCenter').onclick = ()=>{ view.tx=cv.width/2; view.ty=cv.height/2; view.scale=1; need(); updateStatus('–¶–µ–Ω—Ç—Ä'); };
$('btnGear').onclick = ()=>{ panel.style.display='block'; };
$('btnClose').onclick = ()=>{ panel.style.display='none'; };

$('rngWidth').oninput = e=>{ params.linePx=+e.target.value; need(); };
$('rngGridA').oninput = e=>{ params.grid.alpha=(+e.target.value)/100; need(); };

$('btnPhoto').onclick = ()=>{
  const input=document.createElement('input');
  input.type='file'; input.accept='image/*';
  input.onchange = (ev)=>{
    const file=ev.target.files?.[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload = e=>{
      bgImage=new Image(); bgImage.onload=()=>{ need(); updateStatus('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ'); };
      bgImage.src=e.target.result;
    };
    reader.readAsDataURL(file);
  };
  input.click();
};

/* —Å—Ç–∞—Ä—Ç */
fit();
view.tx=cv.width/2; view.ty=cv.height/2; // –Ω–µ–±–æ–ª—å—à–æ–π –∫–æ–º—Ñ–æ—Ä—Ç
updateStatus('–ì–æ—Ç–æ–≤–æ: –Ω–∞–∂–º–∏ ¬´–õ–∏–Ω–∏—è¬ª ‚Üí 1-—è —Ç–æ—á–∫–∞ ‚Üí 2-—è —Ç–æ—á–∫–∞.');
need();
})();
</script>
</body>
</html>