<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace ‚Äî v876 check-body</title>
<style>
  :root{--violet:#6b1dff; --violet2:#7c5bff; --border:#e7e3f7}
  html,body{margin:0;height:100%;background:#f2f3f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  #cv{position:fixed;inset:0;display:block;width:100vw;height:100vh;background:#fff;touch-action:none;-webkit-user-select:none;user-select:none}

  .bar{position:fixed;left:8px;top:8px;z-index:10;display:flex;gap:8px;flex-wrap:wrap}
  .btn{height:44px;padding:0 14px;border:0;border-radius:12px;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff;font-weight:800}
  .btn.ghost{background:linear-gradient(180deg,#8c8c8c,#6a6a6a)}

  .zoom{position:fixed;right:8px;top:8px;z-index:11;display:flex;gap:8px}
  .zbtn{height:44px;min-width:44px;border:0;border-radius:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);font-size:18px}

  .gear{position:fixed;right:8px;top:64px;z-index:12;height:44px;width:44px;border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);font-size:20px}
  .status{position:fixed;left:8px;bottom:8px;background:rgba(0,0,0,.70);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;z-index:11;max-width:92vw}

  .panel-wrap{position:fixed;inset:0;z-index:20;display:none}
  .panel-wrap.open{display:block}
  .panel-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.18)}
  .panel{position:absolute;top:64px;right:8px;background:#fff;border:1px solid var(--border);
         border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:12px;width:min(92vw,380px);
         max-height:80vh;overflow:auto}
  .panel h4{margin:6px 0 8px;font-size:15px}
  .row{display:flex;align-items:center;gap:10px;margin:10px 0}
  .row label{min-width:140px;font-size:13px;color:#444}
  .close{position:sticky;top:0;margin:-6px -6px 6px auto;background:#fff;border:1px solid var(--border);width:32px;height:32px;border-radius:8px}
  input[type=range]{width:100%}
  .num{font-variant-numeric:tabular-nums;color:#111;font-weight:700}
  .radio-row{display:flex;gap:10px;flex-wrap:wrap}
  .radio{display:flex;align-items:center;gap:6px;border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:12px;color:#333}
  .radio input{accent-color:#6b1dff}
  .upl{position:relative;min-width:120px;display:inline-flex;justify-content:center}
  .upl input{position:absolute;inset:0;opacity:0}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="bar">
    <button id="btnLine"  class="btn">üìê –õ–∏–Ω–∏—è</button>
    <button id="btnUndo"  class="btn ghost">‚Ü© –ù–∞–∑–∞–¥</button>
    <button id="btnHand"  class="btn ghost">üñê –†—É–∫–∞</button>
  </div>

  <div class="zoom">
    <button id="btnMinus" class="zbtn" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
    <button id="btnPlus"  class="zbtn" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
  </div>

  <button id="btnSettings" class="gear" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öô</button>

  <div id="panelWrap" class="panel-wrap" aria-hidden="true">
    <div id="panelBackdrop" class="panel-backdrop"></div>
    <div id="panel" class="panel" role="dialog" aria-modal="true">
      <button id="btnClosePanel" class="close" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>

      <h4>–ß–µ—Ä—Ç—ë–∂</h4>
      <div class="row">
        <label for="rangeLine">–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏</label>
        <input id="rangeLine" type="range" min="2" max="56" step="1">
        <span id="lineVal" class="num">10</span>
      </div>

      <div class="row">
        <label for="rangeComp">–ê—Ä–º–∞—Ç—É—Ä–∞ √ó</label>
        <input id="rangeComp" type="range" min="0.5" max="3.0" step="0.01">
        <span id="compVal" class="num">1.15</span>
      </div>

      <div class="row" style="margin-top:8px">
        <label>–¢–∏–ø –∞—Ä–º–∞—Ç—É—Ä—ã</label>
        <div class="radio-row">
          <label class="radio"><input type="radio" name="comp" value="valve" checked> –ö—Ä–∞–Ω</label>
          <label class="radio"><input type="radio" name="comp" value="check"> –ö–ª–∞–ø–∞–Ω</label>
          <label class="radio"><input type="radio" name="comp" value="pump"> –ù–∞—Å–æ—Å</label>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="btnPlaceComp" class="btn">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Ç—Ä—É–±—É</button>
      </div>
    </div>
  </div>

  <div id="status" class="status">–°—Ç–∞—Ç—É—Å: –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

<script>
(()=>{"use strict";
/* ===== –±–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ===== */
const DPR=Math.min(1.5,Math.max(1,window.devicePixelRatio||1));
const cv=document.getElementById('cv');const ctx=cv.getContext('2d',{alpha:false});
const statusEl=document.getElementById('status');

/* ===== –∫–∞–º–µ—Ä–∞/–≤–∏–¥ ===== */
const view={tx:0,ty:0,scale:1};
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const clampScale=s=>clamp(s,0.25,6);
function fit(){cv.width=Math.round(innerWidth*DPR);cv.height=Math.round(innerHeight*DPR);need();}
addEventListener('resize',fit,{passive:true});

/* ===== —Å—Ü–µ–Ω–∞ ===== */
const segs=[], comps=[], stack=[];
let tool='idle';let mode='hand';let first=null,preview=null;
let currentComp='valve';
const params={ linePx:10,lineColor:'#1f6bff',compScale:1.15 };

/* ===== —É—Ç–∏–ª–∏—Ç—ã ===== */
function s2w(sx,sy){return{x:(sx-view.tx)/view.scale,y:(sy-view.ty)/view.scale};}
function w2s(x,y){return{x:x*view.scale+view.tx,y:y*view.scale+view.ty};}
function darker(hex,k=0.45){const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);if(!m)return'#333';let[r,g,b]=[parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16)];r=Math.max(0,Math.floor(r*(1-k)));g=Math.max(0,Math.floor(g*(1-k)));b=Math.max(0,Math.floor(b*(1-k)));return'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');}
function segGeom(seg){const vx=seg.b.x-seg.a.x,vy=seg.b.y-seg.a.y;const L=Math.hypot(vx,vy)||1;return{vx,vy,L,nx:vx/L,ny:vy/L};}
function compBasis(seg,t){const g=segGeom(seg);return{x:seg.a.x+g.nx*g.L*t,y:seg.a.y+g.ny*g.L*t,ux:g.nx,uy:g.ny,nx:-g.ny,ny:g.nx};}
function updateStatus(msg=''){const t=tool==='awaitFirst'?'–ñ–¥—É 1-—é —Ç–æ—á–∫—É':tool==='awaitSecond'?'–ñ–¥—É 2-—é —Ç–æ—á–∫—É':tool==='placeComp'?'–ê—Ä–º–∞—Ç—É—Ä–∞':(mode==='hand'?'–†—É–∫–∞':'–ì–æ—Ç–æ–≤');statusEl.textContent=`–°—Ç–∞—Ç—É—Å: ${msg} | ${t}`;}

/* ===== –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ ===== */
function drawSegments(){ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);const col=params.lineColor,sh=darker(col,0.45);for(const s of segs){ctx.strokeStyle=sh;ctx.globalAlpha=.75;ctx.lineWidth=(params.linePx+2)/view.scale;ctx.beginPath();ctx.moveTo(s.a.x,s.a.y);ctx.lineTo(s.b.x,s.b.y);ctx.stroke();ctx.strokeStyle=col;ctx.globalAlpha=1;ctx.lineWidth=params.linePx/view.scale;ctx.beginPath();ctx.moveTo(s.a.x,s.a.y);ctx.lineTo(s.b.x,s.b.y);ctx.stroke();}}
function drawValve(seg,t){/* ... –∫–∞–∫ —Ä–∞–Ω—å—à–µ ... */}
function drawPump(seg,t){/* ... –∫–∞–∫ —Ä–∞–Ω—å—à–µ (–º–æ—Ç–æ—Ä —Å–≤–µ—Ä—Ö—É) ... */}
function drawCheck(seg,t){
  const b=compBasis(seg,t), base=params.linePx*params.compScale;
  const bodyLen=base*10.5, bodyR=base*2.6, coneL=base*3.2, pipeR=base*1.4;
  const ux=b.ux, uy=b.uy, nx=b.nx, ny=b.ny;
  const L={x:b.x-ux*bodyLen/2,y:b.y-uy*bodyLen/2};
  const R={x:b.x+ux*bodyLen/2,y:b.y+uy*bodyLen/2};
  const P1={x:L.x-ux*coneL,y:L.y-uy*coneL}, P2={x:R.x+ux*coneL,y:R.y+uy*coneL};

  ctx.save();ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);
  ctx.fillStyle='#6b1dff';ctx.strokeStyle='#2b145f';ctx.lineWidth=2/view.scale;

  // –∫–æ—Ä–ø—É—Å
  ctx.beginPath();ctx.moveTo(L.x-nx*bodyR,L.y-ny*bodyR);ctx.lineTo(R.x-nx*bodyR,R.y-ny*bodyR);
  ctx.arc(R.x,R.y,bodyR,Math.atan2(-ny,-nx),Math.atan2(ny,-nx),false);
  ctx.lineTo(L.x+nx*bodyR,L.y+ny*bodyR);
  ctx.arc(L.x,L.y,bodyR,Math.atan2(ny,nx),Math.atan2(-ny,nx),false);
  ctx.closePath();ctx.fill();ctx.stroke();

  // –∫–æ–Ω—É—Å—ã
  ctx.beginPath();ctx.moveTo(P1.x-nx*pipeR,P1.y-ny*pipeR);ctx.lineTo(L.x-nx*bodyR,L.y-ny*bodyR);
  ctx.lineTo(L.x+nx*bodyR,L.y+ny*bodyR);ctx.lineTo(P1.x+nx*pipeR,P1.y+ny*pipeR);ctx.closePath();ctx.fill();ctx.stroke();
  ctx.beginPath();ctx.moveTo(R.x-nx*bodyR,R.y-ny*bodyR);ctx.lineTo(P2.x-nx*pipeR,P2.y-ny*pipeR);
  ctx.lineTo(P2.x+nx*pipeR,P2.y+ny*pipeR);ctx.lineTo(R.x+nx*bodyR,R.y+ny*bodyR);ctx.closePath();ctx.fill();ctx.stroke();

  // –±–µ–ª—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –≤–¥–æ–ª—å —Ç—Ä—É–±—ã
  const triBase=base*3.2, triRise=base*3.0;
  const A={x:b.x - nx*triBase/2, y:b.y - ny*triBase/2};
  const B={x:b.x + nx*triBase/2, y:b.y + ny*triBase/2};
  const T={x:b.x + ux*triRise,   y:b.y + uy*triRise};
  ctx.fillStyle='#fff';ctx.strokeStyle='#1b1b1b';ctx.lineWidth=1.6/view.scale;
  ctx.beginPath();ctx.moveTo(T.x,T.y);ctx.lineTo(B.x,B.y);ctx.lineTo(A.x,A.y);ctx.closePath();ctx.fill();ctx.stroke();
  ctx.restore();
}
function draw(){/* ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ ... */}
/* ===== –≤–≤–æ–¥/–ø–∞–Ω–µ–ª—å/–∫–Ω–æ–ø–∫–∏ ‚Äî –∫–∞–∫ –≤ v875 ===== */
fit();need();updateStatus('–ì–æ—Ç–æ–≤–æ (v876): ¬´–õ–∏–Ω–∏—è¬ª ‚Üí —Ç–æ—á–∫–∏ ‚Üí —Å–µ–≥–º–µ–Ω—Ç. –ö–ª–∞–ø–∞–Ω –∫–∞–∫ –≤–µ–Ω—Ç–∏–ª—å, –≤–Ω—É—Ç—Ä–∏ –±–µ–ª—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫.');
})();
</script>
</body>
</html>