<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Трассировка труб</title>
<style>
  body,html{margin:0;height:100%;background:#111;color:#eee;font-family:sans-serif;overflow:hidden}
  #stage{position:fixed;inset:0;overflow:hidden;touch-action:none;background:#111}
  #content{position:absolute;left:0;top:0;transform-origin:0 0}
  #bg{position:absolute;left:0;top:0;max-width:none;max-height:none;pointer-events:none}
  canvas{position:absolute;left:0;top:0;pointer-events:none}
  #ui{position:fixed;left:8px;top:8px;display:flex;gap:8px;flex-wrap:wrap;z-index:10}
  .btn{background:#222;border:1px solid #444;color:#eee;padding:8px 12px;border-radius:8px}
  .btn.active{outline:2px solid #4af}
  #panel{position:fixed;right:10px;top:10px;width:250px;background:#222;border:1px solid #444;border-radius:10px;
         padding:10px;z-index:20;display:none}
  #panel.open{display:block}
  .row{margin:6px 0;display:flex;justify-content:space-between;align-items:center}
  #status{position:fixed;left:10px;bottom:10px;background:rgba(0,0,0,.6);padding:6px 10px;border-radius:8px;font-size:14px}
</style>
</head>
<body>
<div id="stage">
  <div id="content">
    <img id="bg" alt="">
    <canvas id="grid"></canvas>
    <canvas id="draw"></canvas>
    <canvas id="preview"></canvas>
  </div>
</div>
<div id="ui">
  <button id="btnLine" class="btn">Линия</button>
  <button id="btnUndo" class="btn">Назад</button>
  <label class="btn">Фото<input id="file" type="file" accept="image/*" style="display:none"></label>
  <button id="btnCenter" class="btn">Центр</button>
  <button id="btnSave" class="btn">Сохранить</button>
  <button id="btnGear" class="btn">⚙</button>
</div>
<div id="panel">
  <div class="row"><label>Ø, мм</label><input id="pipeRange" type="range" min="10" max="120" value="40"></div>
  <div class="row"><label>Сетка</label><input id="gridRange" type="range" min="16" max="120" value="48"></div>
  <div class="row"><label>Магнит</label><input id="snapChk" type="checkbox" checked></div>
</div>
<div id="status">Готов</div>

<script>
(()=>{
const $stage=document.querySelector('#stage');
const $content=document.querySelector('#content');
const $bg=document.querySelector('#bg');
const $grid=document.querySelector('#grid');
const $draw=document.querySelector('#draw');
const $preview=document.querySelector('#preview');
const ctxG=$grid.getContext('2d'),ctxD=$draw.getContext('2d'),ctxP=$preview.getContext('2d');

const btnLine=document.querySelector('#btnLine');
const btnUndo=document.querySelector('#btnUndo');
const btnCenter=document.querySelector('#btnCenter');
const btnSave=document.querySelector('#btnSave');
const btnGear=document.querySelector('#btnGear');
const panel=document.querySelector('#panel');
const fileInput=document.querySelector('#file');
const pipeRange=document.querySelector('#pipeRange');
const gridRange=document.querySelector('#gridRange');
const snapChk=document.querySelector('#snapChk');
const $status=document.querySelector('#status');

const state={worldW:1600,worldH:1000,scale:1,offsetX:0,offsetY:0,
  drawing:false,start:null,segments:[],diam:40,grid:48,snap:true,
  edit:null};

function setup(w,h){
  state.worldW=w;state.worldH=h;
  [$grid,$draw,$preview].forEach(c=>{c.width=w;c.height=h});
  $content.style.width=w+'px';$content.style.height=h+'px';
  fit();drawGrid();redraw();
}
function fit(){
  const vw=$stage.clientWidth,vh=$stage.clientHeight;
  const s=Math.min(vw/state.worldW,vh/state.worldH);
  state.scale=s*0.95;
  state.offsetX=(vw-state.worldW*state.scale)/2;
  state.offsetY=(vh-state.worldH*state.scale)/2;
  applyView();
}
function applyView(){
  $content.style.transform=`translate(${state.offsetX}px,${state.offsetY}px) scale(${state.scale})`;
}
function drawGrid(){
  ctxG.clearRect(0,0,$grid.width,$grid.height);
  ctxG.strokeStyle="rgba(255,255,255,.15)";
  for(let x=0;x<=state.worldW;x+=state.grid){ctxG.beginPath();ctxG.moveTo(x,0);ctxG.lineTo(x,state.worldH);ctxG.stroke();}
  for(let y=0;y<=state.worldH;y+=state.grid){ctxG.beginPath();ctxG.moveTo(0,y);ctxG.lineTo(state.worldW,y);ctxG.stroke();}
}
function drawPipe(c,a,b,d,color="#3af"){
  const dx=b.x-a.x,dy=b.y-a.y,L=Math.hypot(dx,dy)||1;
  const nx=dx/L,ny=dy/L,px=-ny,py=nx,r=d/2;
  c.beginPath();
  c.moveTo(a.x+px*r,a.y+py*r);
  c.lineTo(b.x+px*r,b.y+py*r);
  c.arc(b.x,b.y,r,Math.atan2(py,px),Math.atan2(-py,-px));
  c.lineTo(a.x-px*r,a.y-py*r);
  c.arc(a.x,a.y,r,Math.atan2(-py,-px),Math.atan2(py,px));
  c.closePath();
  c.fillStyle=color;c.fill();c.strokeStyle="#000";c.stroke();
}
function redraw(){
  ctxD.clearRect(0,0,$draw.width,$draw.height);
  for(const s of state.segments) drawPipe(ctxD,s.a,s.b,s.d);
}
function snap(p,origin){
  if(!state.snap||!origin)return p;
  const dx=p.x-origin.x,dy=p.y-origin.y,ang=Math.atan2(dy,dx);
  const snaps=[0,Math.PI/4,Math.PI/2,-Math.PI/4,-Math.PI/2,Math.PI];
  let best=snaps[0],dif=99;
  for(const s of snaps){let d=Math.abs(ang-s);if(d>Math.PI)d=2*Math.PI-d;if(d<dif){dif=d;best=s}}
  const L=Math.hypot(dx,dy);
  return {x:origin.x+Math.cos(best)*L,y:origin.y+Math.sin(best)*L};
}
function screenToWorld(x,y){
  const r=$stage.getBoundingClientRect();
  return{ x:(x-r.left-state.offsetX)/state.scale, y:(y-r.top-state.offsetY)/state.scale };
}
// события
let pointers=new Map();let lastPan={x:0,y:0};
$stage.addEventListener('pointerdown',e=>{
  $stage.setPointerCapture(e.pointerId);
  pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
  const p=screenToWorld(e.clientX,e.clientY);
  // проверка на редактирование
  for(const seg of state.segments){
    for(const key of ['a','b']){
      if(Math.hypot(p.x-seg[key].x,p.y-seg[key].y)<15){
        state.edit={seg,key};
        $status.textContent="Редактирование конца трубы";
        return;
      }
    }
  }
  if(state.drawing){
    if(!state.start){state.start=p;$status.textContent="Старт есть, ткни конец";}
    else{const end=snap(p,state.start);state.segments.push({a:state.start,b:end,d:state.diam});state.start=null;state.drawing=false;btnLine.classList.remove('active');redraw();$status.textContent="Линия готова";}
  }else{lastPan={x:e.clientX,y:e.clientY};}
});
$stage.addEventListener('pointermove',e=>{
  if(state.edit){
    const p=screenToWorld(e.clientX,e.clientY);
    state.edit.seg[state.edit.key]=snap(p,null);
    redraw();return;
  }
  if(state.drawing&&state.start){const p=screenToWorld(e.clientX,e.clientY);ctxP.clearRect(0,0,$preview.width,$preview.height);drawPipe(ctxP,state.start,snap(p,state.start),state.diam,"rgba(0,150,255,.5)");}
  if(!state.drawing){if(pointers.has(e.pointerId)){const dx=e.clientX-lastPan.x,dy=e.clientY-lastPan.y;state.offsetX+=dx;state.offsetY+=dy;lastPan={x:e.clientX,y:e.clientY};applyView();}}
});
$stage.addEventListener('pointerup',e=>{pointers.delete(e.pointerId);if(state.edit){state.edit=null;$status.textContent="Готов";}});
btnLine.onclick=()=>{state.drawing=!state.drawing;state.start=null;btnLine.classList.toggle('active',state.drawing);};
btnUndo.onclick=()=>{state.segments.pop();redraw();};
btnCenter.onclick=()=>fit();
btnSave.onclick=()=>{const tmp=document.createElement('canvas');tmp.width=state.worldW;tmp.height=state.worldH;const t=tmp.getContext('2d');if($bg.src)t.drawImage($bg,0,0);t.drawImage($grid,0,0);t.drawImage($draw,0,0);const url=tmp.toDataURL();const a=document.createElement('a');a.href=url;a.download="trace.png";a.click();};
btnGear.onclick=()=>panel.classList.toggle('open');
pipeRange.oninput=()=>state.diam=+pipeRange.value;
gridRange.oninput=()=>{state.grid=+gridRange.value;drawGrid();};
snapChk.onchange=()=>state.snap=snapChk.checked;
fileInput.onchange=e=>{const f=e.target.files[0];if(!f)return;const url=URL.createObjectURL(f);const img=new Image();img.onload=()=>{$bg.src=url;setup(img.naturalWidth,img.naturalHeight);};img.src=url;};
setup(1600,1000);
})();
</script>
</body>
</html>