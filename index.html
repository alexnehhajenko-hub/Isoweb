<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace ‚Äî v867 loop tap</title>
<style>
  :root{--violet:#6b1dff; --violet2:#7c5bff; --border:#e7e3f7}
  html,body{margin:0;height:100%;background:#f2f3f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  #cv{position:fixed;inset:0;display:block;width:100vw;height:100vh;background:#fff;touch-action:none;-webkit-user-select:none;user-select:none}

  .bar{position:fixed;left:8px;top:8px;z-index:10;display:flex;gap:8px;flex-wrap:wrap}
  .btn{height:44px;padding:0 14px;border:0;border-radius:12px;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff;font-weight:800}
  .btn.ghost{background:linear-gradient(180deg,#8c8c8c,#6a6a6a)}

  .zoom{position:fixed;right:8px;top:8px;z-index:11;display:flex;gap:8px}
  .zbtn{height:44px;min-width:44px;border:0;border-radius:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);font-size:18px}

  .gear{position:fixed;right:8px;top:64px;z-index:12;height:44px;width:44px;border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);font-size:20px}
  .status{position:fixed;left:8px;bottom:8px;background:rgba(0,0,0,.70);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;z-index:11;max-width:92vw}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="bar">
    <button id="btnLine"  class="btn">üìê –õ–∏–Ω–∏—è</button>
    <button id="btnUndo"  class="btn ghost">‚Ü© –ù–∞–∑–∞–¥</button>
    <button id="btnHand"  class="btn ghost">üñê –†—É–∫–∞</button>
  </div>

  <div class="zoom">
    <button id="btnMinus" class="zbtn" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
    <button id="btnPlus"  class="zbtn" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
  </div>

  <button id="btnSettings" class="gear" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öô</button>

  <div id="status" class="status">–°—Ç–∞—Ç—É—Å: –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

<script>
(()=>{"use strict";
const DPR = Math.min(1.5, Math.max(1, window.devicePixelRatio||1));
const cv=document.getElementById('cv');
const ctx=cv.getContext('2d',{alpha:false});
const statusEl=document.getElementById('status');

const view={tx:0,ty:0,scale:1};
const clampScale=s=>Math.max(0.25,Math.min(6,s));
function fit(){ cv.width=Math.round(innerWidth*DPR); cv.height=Math.round(innerHeight*DPR); need(); }
addEventListener('resize',fit,{passive:true});

const segs=[]; const stack=[];
let tool='idle'; let mode='hand'; let first=null, preview=null;
const params={ linePx:10, lineColor:'#1f6bff' };
function updateStatus(msg=''){ const t=tool==='awaitFirst'?'–ñ–¥—É 1-—é —Ç–æ—á–∫—É':tool==='awaitSecond'?'–ñ–¥—É 2-—é —Ç–æ—á–∫—É':mode==='hand'?'–†—É–∫–∞':'–ì–æ—Ç–æ–≤'; statusEl.textContent=`–°—Ç–∞—Ç—É—Å: ${msg} | ${t}`; }

function s2w(sx,sy){ return {x:(sx-view.tx)/view.scale, y:(sy-view.ty)/view.scale}; }
function w2s(x,y){ return {x:x*view.scale+view.tx, y:y*view.scale+view.ty}; }
function darker(hex,k=0.45){ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); if(!m) return '#333'; let [r,g,b]=[parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16)]; r=Math.max(0,Math.floor(r*(1-k))); g=Math.max(0,Math.floor(g*(1-k))); b=Math.max(0,Math.floor(b*(1-k))); return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join(''); }

function drawSegments(){ ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty); const col=params.lineColor, sh=darker(col,0.45); for(const s of segs){ ctx.strokeStyle=sh; ctx.globalAlpha=.75; ctx.lineWidth=(params.linePx+2)/view.scale; ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke(); ctx.strokeStyle=col; ctx.globalAlpha=1; ctx.lineWidth=params.linePx/view.scale; ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke(); } }

function draw(){ ctx.setTransform(1,0,0,1,0,0); ctx.fillStyle='#fff'; ctx.fillRect(0,0,cv.width,cv.height); drawSegments(); if(tool==='awaitSecond'&&first&&preview){ ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty); ctx.strokeStyle=params.lineColor; ctx.lineWidth=params.linePx/view.scale; ctx.beginPath(); ctx.moveTo(first.x,first.y); ctx.lineTo(preview.x,preview.y); ctx.stroke(); } if(first){ const p=w2s(first.x,first.y); ctx.setTransform(1,0,0,1,0,0); ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(p.x,p.y,6,0,Math.PI*2); ctx.fill(); }}
let raf=0, dirty=false; function need(){ dirty=true; if(!raf){ raf=requestAnimationFrame(()=>{ raf=0; if(dirty){ dirty=false; draw(); } }); } }

const pointers=new Map(); let isPanning=false, panLast=null; let prevCenter=null, prevDist=null;
function canvasXY(e){ const r=cv.getBoundingClientRect(); return {sx:(e.clientX-r.left)*(cv.width/r.width), sy:(e.clientY-r.top)*(cv.height/r.height)}; }
function centroid(){ const a=[...pointers.values()]; if(!a.length) return null; let sx=0,sy=0; for(const p of a){ sx+=p.sx; sy+=p.sy;} return {sx:sx/a.length, sy:sy/a.length}; }
function dist2(a,b){ return Math.abs(a.sx-b.sx)+Math.abs(a.sy-b.sy); }

cv.addEventListener('pointerdown', e=>{ e.preventDefault(); const {sx,sy}=canvasXY(e); pointers.set(e.pointerId,{sx,sy}); if(pointers.size===2){ const [p0,p1]=[...pointers.values()]; prevCenter=centroid(); prevDist=dist2(p0,p1); return;} if(mode==='hand'){ isPanning=true; panLast={sx,sy}; updateStatus('–ü–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ'); return;} if(tool==='awaitFirst'){ first=s2w(sx,sy); preview=null; tool='awaitSecond'; updateStatus('1-—è —Ç–æ—á–∫–∞ –µ—Å—Ç—å'); need(); return;} if(tool==='awaitSecond'){ preview=s2w(sx,sy); segs.push({a:first,b:preview}); stack.push('seg'); first=null; preview=null; tool='awaitFirst'; mode='line'; updateStatus('–°–µ–≥–º–µ–Ω—Ç –≥–æ—Ç–æ–≤ ‚Äî —Ç–∫–Ω–∏ 1-—é —Ç–æ—á–∫—É —Å–ª–µ–¥—É—é—â–µ–≥–æ'); need(); return;} },{passive:false});

cv.addEventListener('pointermove', e=>{ if(!pointers.has(e.pointerId)) return; const {sx,sy}=canvasXY(e); pointers.set(e.pointerId,{sx,sy}); if(pointers.size===2){ const nowC=centroid(); const [p0,p1]=[...pointers.values()]; const nowD=dist2(p0,p1); if(prevCenter&&prevDist){ const k=nowD>0&&prevDist>0?(nowD/prevDist):1; const ns=clampScale(view.scale*k); const cx=nowC.sx, cy=nowC.sy; view.tx=cx-(cx-view.tx)*(ns/view.scale); view.ty=cy-(cy-view.ty)*(ns/view.scale); view.scale=ns; need();} prevCenter=nowC; prevDist=nowD; return;} if(isPanning&&panLast){ view.tx+=(sx-panLast.sx); view.ty+=(sy-panLast.sy); panLast={sx,sy}; need(); return;} if(tool==='awaitSecond'&&first){ preview=s2w(sx,sy); need(); } },{passive:true});

cv.addEventListener('pointerup', e=>{ pointers.delete(e.pointerId); if(pointers.size<2){ prevCenter=null; prevDist=null; } if(isPanning&&pointers.size===0){ isPanning=false; panLast=null; } },{passive:true});

const $=id=>document.getElementById(id);
$('btnLine').onclick =()=>{ tool='awaitFirst'; mode='line'; first=null; preview=null; updateStatus('–†–µ–∂–∏–º –õ–∏–Ω–∏—è'); };
$('btnHand').onclick =()=>{ tool='idle'; mode='hand'; first=null; preview=null; updateStatus('–†–µ–∂–∏–º –†—É–∫–∞'); };
$('btnUndo').onclick =()=>{ if(tool==='awaitSecond'&&first){ first=null; preview=null; tool='idle'; mode='hand'; need(); updateStatus('–°–µ–≥–º–µ–Ω—Ç –æ—Ç–º–µ–Ω—ë–Ω'); return;} const last=stack.pop(); if(!last){ updateStatus('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å'); return;} if(last==='seg'&&segs.length) segs.pop(); need(); updateStatus('–û—Ç–º–µ–Ω–µ–Ω–æ'); };
function zoomAt(f){ const cx=cv.width/2,cy=cv.height/2; const ns=clampScale(view.scale*f); view.tx=cx-(cx-view.tx)*(ns/view.scale); view.ty=cy-(cy-view.ty)*(ns/view.scale); view.scale=ns; need(); }
$('btnPlus').onclick =()=>zoomAt(1.2);
$('btnMinus').onclick=()=>zoomAt(1/1.2);

fit(); need(); updateStatus('–ì–æ—Ç–æ–≤–æ (v867): –ù–∞–∂–º–∏ ¬´–õ–∏–Ω–∏—è¬ª ‚Üí 1-—è —Ç–æ—á–∫–∞ ‚Üí 2-—è —Ç–æ—á–∫–∞ = —Å–µ–≥–º–µ–Ω—Ç. –î–∞–ª—å—à–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: —Å–Ω–æ–≤–∞ –∂–¥—É 1-—é —Ç–æ—á–∫—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç—Ä–µ–∑–∫–∞.');
})();
</script>
</body>
</html>
