<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Canvas Test</title>
<style>
  html,body{margin:0;height:100%;background:#ddd;overflow:hidden;font:14px system-ui}
  #cv{position:fixed;inset:0;touch-action:none;background:#fff}
  .ui{position:fixed;top:8px;left:8px;display:flex;gap:8px;z-index:10}
  button{height:40px;padding:0 12px;border:0;border-radius:10px;background:#7c5bff;color:#fff;font-weight:700}
  .status{position:fixed;left:8px;bottom:8px;background:rgba(0,0,0,.65);color:#fff;padding:6px 8px;border-radius:8px}
  .debug{position:fixed;right:8px;bottom:8px;max-width:90vw;max-height:40vh;overflow:auto;
         background:rgba(0,0,0,.85);color:#0f0;padding:8px;border-radius:8px;display:none;white-space:pre-wrap}
</style>
</head>
<body>
<canvas id="cv"></canvas>
<div class="ui"><button id="test">Тест</button></div>
<div id="status" class="status">Статус: Загрузка…</div>
<div id="debug" class="debug"></div>
<script>
(function(){
  "use strict";
  const qs=new URLSearchParams(location.search);
  const DEBUG = qs.get('debug')==='1';
  const logEl=document.getElementById('debug');
  function log(){ if(!DEBUG) return; logEl.style.display='block';
    logEl.textContent += Array.from(arguments).join(' ')+"\\n"; logEl.scrollTop=logEl.scrollHeight; }

  const statusEl=document.getElementById('status');
  function status(t){ statusEl.textContent='Статус: '+t; }

  window.addEventListener('error', e=>{ log('ERROR:', e.message, (e.filename||'')+':'+(e.lineno||'')); });

  const cv=document.getElementById('cv');
  const ctx=cv.getContext && cv.getContext('2d',{alpha:false});
  if(!ctx){ status('Нет 2D контекста'); log('no 2d ctx'); return; }

  const DPR=Math.max(1, window.devicePixelRatio||1);
  function fit(){ cv.width=Math.round(innerWidth*DPR); cv.height=Math.round(innerHeight*DPR); draw(); }
  addEventListener('resize', fit, {passive:true}); fit();

  const points=[];
  function draw(){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.fillStyle='#f7f7f7'; ctx.fillRect(0,0,cv.width,cv.height);
    for(const p of points){
      ctx.beginPath(); ctx.fillStyle='#6b1dff';
      ctx.arc(p.x,p.y,14,0,Math.PI*2); ctx.fill();
    }
  }

  cv.addEventListener('pointerdown', e=>{
    const r=cv.getBoundingClientRect(), sx=(e.clientX-r.left)*(cv.width/r.width), sy=(e.clientY-r.top)*(cv.height/r.height);
    points.push({x:sx,y:sy}); draw();
  }, {passive:false});

  document.getElementById('test').onclick=()=>{ status('Работает!'); };

  status('Готово'); log('init ok; DPR=',DPR);
  draw();
})();
</script>
</body>
</html>