<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Pro Trace — тапами + выравнивание концов</title>
<style>
  html,body{margin:0;height:100%;background:#0f1115;color:#eef2f7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;overflow:hidden}
  #wrap{position:fixed;inset:0;overflow:hidden;background:#0f1115}
  #cv{position:absolute;inset:0;touch-action:none}
  .bar{position:fixed;left:10px;top:10px;display:flex;gap:8px;z-index:10;flex-wrap:wrap}
  .btn{background:#1c1f26;border:1px solid #2e3340;color:#eef2f7;padding:10px 14px;border-radius:12px;font-weight:700}
  .btn.active{outline:2px solid #6aa6ff}
  #gear{position:fixed;right:10px;top:10px;z-index:12}
  #panel{position:fixed;right:10px;top:58px;width:300px;max-width:92vw;background:rgba(24,26,33,.96);
         border:1px solid #2e3340;border-radius:14px;padding:12px;box-shadow:0 14px 36px rgba(0,0,0,.35);display:none;z-index:20}
  #panel h3{margin:0 0 8px}
  #panel .row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:10px 0}
  #panel input[type=range]{width:170px}
  #status{position:fixed;left:10px;bottom:10px;background:rgba(0,0,0,.6);padding:8px 12px;border-radius:10px;border:1px solid #2e3340;font-size:14px;z-index:11}
  #file{display:none}
</style>
</head>
<body>
  <div id="wrap"><canvas id="cv"></canvas></div>

  <div class="bar">
    <button id="btnLine"  class="btn">Линия</button>
    <button id="btnUndo"  class="btn">Назад</button>
    <button id="btnPhoto" class="btn">Фото</button>
    <button id="btnCenter" class="btn">Центр</button>
    <button id="btnSave"  class="btn">Сохранить</button>
  </div>

  <button id="gear" class="btn" title="Параметры">⚙</button>
  <div id="panel">
    <h3>Параметры</h3>
    <div class="row"><span>Ø, мм</span><input id="diam" type="range" min="10" max="200" value="40"><b id="dVal">40</b></div>
    <div class="row"><span>Сетка</span><input id="grid" type="range" min="10" max="120" value="40"><b id="gVal">40</b></div>
    <div class="row"><label style="display:flex;gap:8px;align-items:center"><input id="snap" type="checkbox" checked> Магнит 0/45/90°</label></div>
  </div>

  <input id="file" type="file" accept="image/*"/>
  <div id="status">Готов: Линия → 1-й тап → 2-й тап. Долгое нажатие на торце — правка.</div>

<script>
(()=>{
// ===== Состояние
const S = {
  scale: 1, ox: 0, oy: 0, minS:.2, maxS:6,
  img:null, iw:0, ih:0,
  pipe:40, grid:40, snap:true,
  segs:[],                 // [{a:{x,y}, b:{x,y}}]
  drawing:false, first:null,
  // редактирование
  nodes:[],                // [{x,y, seg, end:'a'|'b'}]
  dragNode:null,           // {seg,end}
  longPress:null,          // timer id
  // жесты
  pinch:null,
  tap:{x:0,y:0,t:0, moved:false}
};

// ===== DOM
const cv = document.getElementById('cv'); const ctx = cv.getContext('2d');
const btnLine = document.getElementById('btnLine');
const btnUndo = document.getElementById('btnUndo');
const btnPhoto= document.getElementById('btnPhoto');
const btnCenter=document.getElementById('btnCenter');
const btnSave = document.getElementById('btnSave');
const gear    = document.getElementById('gear');
const panel   = document.getElementById('panel');
const fileInp = document.getElementById('file');
const diamInp = document.getElementById('diam'); const dVal=document.getElementById('dVal');
const gridInp = document.getElementById('grid'); const gVal=document.getElementById('gVal');
const snapInp = document.getElementById('snap');
const statusEl= document.getElementById('status');

const setStatus = t => statusEl.textContent = 'Статус: ' + t;

// ===== Размеры
function resize(){
  const dpr = Math.max(1, devicePixelRatio||1);
  const w = innerWidth, h = innerHeight;
  cv.width = Math.round(w*dpr); cv.height = Math.round(h*dpr);
  cv.style.width = w+'px'; cv.style.height = h+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
  draw();
}
addEventListener('resize', resize, {passive:true});

// ===== Координаты
const toWorld  = (x,y)=>({ x:(x - S.ox)/S.scale, y:(y - S.oy)/S.scale });
const toScreen = (x,y)=>({ x:x*S.scale + S.ox,   y:y*S.scale + S.oy   });

// ===== Магнит
function snapPoint(base, p){
  if(!S.snap || !base) return p;
  const dx=p.x-base.x, dy=p.y-base.y, len=Math.hypot(dx,dy);
  if(len<1e-6) return p;
  const ang=Math.atan2(dy,dx), step=Math.PI/4;
  const r=Math.round(ang/step)*step;
  return {x: base.x + Math.cos(r)*len, y: base.y + Math.sin(r)*len};
}

// ===== Рендер
function drawBG(){
  if(!S.img) return;
  const p = toScreen(0,0);
  ctx.drawImage(S.img, p.x, p.y, S.iw*S.scale, S.ih*S.scale);
}
function drawGrid(){
  const step = S.grid*S.scale;
  if(step<8) return;
  ctx.save();
  ctx.strokeStyle='rgba(255,255,255,.12)'; ctx.lineWidth=1;
  const x0=((S.ox%step)+step)%step, y0=((S.oy%step)+step)%step;
  for(let x=x0;x<cv.width;x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,cv.height); ctx.stroke(); }
  for(let y=y0;y<cv.height;y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(cv.width,y); ctx.stroke(); }
  ctx.restore();
}
function drawSeg(s, preview=false){
  const a=toScreen(s.a.x,s.a.y), b=toScreen(s.b.x,s.b.y);
  const w = Math.max(2, S.pipe*S.scale*0.45);
  // тень
  ctx.strokeStyle='rgba(0,0,0,.28)'; ctx.lineWidth=w+4; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(a.x+1.5,a.y+1.5); ctx.lineTo(b.x+1.5,b.y+1.5); ctx.stroke();
  // труба
  ctx.strokeStyle = preview?'#7fc1ff':'#4da3ff'; ctx.lineWidth=w; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
  // торцы
  ctx.fillStyle=ctx.strokeStyle; const r=w/2;
  ctx.beginPath(); ctx.arc(a.x,a.y,r,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(b.x,b.y,r,0,Math.PI*2); ctx.fill();
}
function drawNodes(){
  // рисуем круги на концах для наглядности редактирования
  ctx.save();
  const R = Math.max(6, S.pipe*S.scale*0.35);
  for(const n of S.nodes){
    const s = toScreen(n.x,n.y);
    ctx.beginPath(); ctx.arc(s.x,s.y,R,0,Math.PI*2);
    ctx.fillStyle = 'rgba(255,255,255,.08)'; ctx.fill();
    ctx.strokeStyle = (S.dragNode && S.dragNode.seg===n.seg && S.dragNode.end===n.end) ? '#ffd166' : 'rgba(255,255,255,.35)';
    ctx.lineWidth=2; ctx.stroke();
  }
  ctx.restore();
}
function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  drawBG(); drawGrid();
  for(const s of S.segs) drawSeg(s,false);
  if(S.drawing && S.first && S.preview) drawSeg({a:S.first, b:S.preview}, true);
  drawNodes();
}

// ===== Узлы (концы труб) для редактирования
function rebuildNodes(){
  S.nodes.length=0;
  S.segs.forEach((s,i)=>{
    S.nodes.push({x:s.a.x,y:s.a.y, seg:i, end:'a'});
    S.nodes.push({x:s.b.x,y:s.b.y, seg:i, end:'b'});
  });
}
function pickNodeAt(clientX,clientY){
  const p = toWorld(clientX,clientY);
  const tol = Math.max(10, S.pipe/2)/S.scale; // радиус поиска (в мире)
  let best=null, dmin=1e9;
  for(const n of S.nodes){
    const d = Math.hypot(p.x-n.x, p.y-n.y);
    if(d<tol && d<dmin){ dmin=d; best=n; }
  }
  return best; // {x,y,seg,end}
}

// ===== Пинч-зум (двумя пальцами)
function pinchBegin(a,b){
  S.pinch = { d: Math.hypot(b.x-a.x,b.y-a.y), cx:(a.x+b.x)/2, cy:(a.y+b.y)/2, sc:S.scale, ox:S.ox, oy:S.oy };
}
function pinchMove(a,b){
  if(!S.pinch) return;
  const d = Math.hypot(b.x-a.x,b.y-a.y);
  let s = Math.min(S.maxS, Math.max(S.minS, S.pinch.sc*(d/S.pinch.d)));
  const wx = (S.pinch.cx - S.pinch.ox)/S.pinch.sc;
  const wy = (S.pinch.cy - S.pinch.oy)/S.pinch.sc;
  S.scale = s;
  S.ox = S.pinch.cx - wx*s;
  S.oy = S.pinch.cy - wy*s;
  draw();
}
function pinchEnd(){ S.pinch=null; }

// ===== Ввод: строго ТАПЫ для рисования, длинное нажатие для редактирования
const TAP_MOVE=12, TAP_TIME=350, LONG_MS=500;
let touchMap=new Map();

cv.addEventListener('pointerdown', e=>{
  cv.setPointerCapture(e.pointerId);
  S.tap={x:e.clientX,y:e.clientY,t:performance.now(),moved:false};

  // старт возможного long-press по узлу
  const n = pickNodeAt(e.clientX,e.clientY);
  if(n){
    S.longPress = setTimeout(()=>{
      S.dragNode = {seg:n.seg, end:n.end};
      setStatus('Редактирование: тяните конец трубы');
      draw();
    }, LONG_MS);
  }else{
    S.longPress = setTimeout(()=>{}, LONG_MS); // пустышка — чтобы отменить при move
  }
}, {passive:false});

cv.addEventListener('pointermove', e=>{
  if(Math.hypot(e.clientX-S.tap.x, e.clientY-S.tap.y) > TAP_MOVE){
    S.tap.moved = true;
    if(S.longPress){ clearTimeout(S.longPress); S.longPress=null; }
  }
  // если редактируем конец
  if(S.dragNode){
    const L = S.segs[S.dragNode.seg]; if(!L) return;
    let p = toWorld(e.clientX,e.clientY);
    const other = (S.dragNode.end==='a') ? L.b : L.a;
    p = snapPoint(other, p);
    L[S.dragNode.end] = p;
    // обновлять отображение узлов
    rebuildNodes();
    draw();
  }
}, {passive:false});

cv.addEventListener('pointerup', e=>{
  if(S.longPress){ clearTimeout(S.longPress); S.longPress=null; }
  // завершили редактирование
  if(S.dragNode){ S.dragNode=null; setStatus('Готов'); draw(); return; }

  const isTap = !S.tap.moved && (performance.now()-S.tap.t<=TAP_TIME);
  if(isTap){
    const w = toWorld(e.clientX,e.clientY);
    if(!S.drawing) return; // рисуем только когда включен режим Линия
    if(!S.first){
      S.first = w;
      setStatus('1-я точка есть. Ткни вторую.');
    }else{
      const end = snapPoint(S.first, w);
      S.segs.push({a:{...S.first}, b:{...end}});
      S.first=null; S.drawing=false; btnLine.classList.remove('active');
      rebuildNodes();
      setStatus('Линия готова. Для новой снова нажми «Линия».');
    }
    S.preview=null; draw();
  }
}, {passive:false});

// предпросмотр второй точки (при лёгком движении пальца — не рисуем линию)
cv.addEventListener('touchstart', e=>{
  for(const t of e.changedTouches) touchMap.set(t.identifier,{x:t.clientX,y:t.clientY});
  if(touchMap.size===2){
    const [a,b] = [...touchMap.values()];
    pinchBegin(a,b);
  }
},{passive:false});
cv.addEventListener('touchmove', e=>{
  for(const t of e.changedTouches) touchMap.set(t.identifier,{x:t.clientX,y:t.clientY});
  if(touchMap.size===2){
    const [a,b] = [...touchMap.values()];
    pinchMove(a,b); e.preventDefault(); return;
  }
  // если идёт рисование второй точки — показываем предпросмотр
  if(S.drawing && S.first && e.touches.length===1){
    const t = e.touches[0];
    let p = toWorld(t.clientX,t.clientY);
    S.preview = snapPoint(S.first, p);
    draw();
  }
},{passive:false});
cv.addEventListener('touchend', e=>{
  for(const t of e.changedTouches) touchMap.delete(t.identifier);
  if(touchMap.size<2) pinchEnd();
},{passive:false});
cv.addEventListener('touchcancel', e=>{
  for(const t of e.changedTouches) touchMap.delete(t.identifier);
  pinchEnd();
},{passive:false});

// ===== Кнопки
btnLine.onclick=()=>{ S.drawing=!S.drawing; S.first=null; S.preview=null; btnLine.classList.toggle('active',S.drawing);
  setStatus(S.drawing?'Режим ЛИНИЯ: ткни 1-ю точку':'Готов'); draw(); };
btnUndo.onclick=()=>{ if(S.first){S.first=null; S.preview=null; setStatus('Старт снят'); draw(); return;}
  S.segs.pop(); rebuildNodes(); draw(); setStatus('Отменено'); };
btnCenter.onclick=()=>{ if(S.img){ const k=Math.min(innerWidth/S.iw, innerHeight/S.ih)*0.95; S.scale=Math.max(S.minS,Math.min(S.maxS,k)); S.ox=(innerWidth-S.iw*S.scale)/2; S.oy=(innerHeight-S.ih*S.scale)/2; } else { S.scale=1; S.ox=innerWidth/2; S.oy=innerHeight/2; } draw(); setStatus('По центру'); };
btnSave.onclick=()=>{ const off=document.createElement('canvas'); off.width=cv.width; off.height=cv.height; const o=off.getContext('2d'); o.drawImage(cv,0,0); const a=document.createElement('a'); a.href=off.toDataURL('image/png'); a.download='trace.png'; a.click(); };

btnPhoto.onclick=()=>fileInp.click();
fileInp.onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const url=URL.createObjectURL(f);
  const img=new Image();
  img.onload=()=>{
    S.img=img; S.iw=img.naturalWidth; S.ih=img.naturalHeight;
    const k=Math.min(innerWidth/S.iw, innerHeight/S.ih)*0.95;
    S.scale=Math.max(S.minS,Math.min(S.maxS,k));
    S.ox=(innerWidth-S.iw*S.scale)/2; S.oy=(innerHeight-S.ih*S.scale)/2;
    draw(); setStatus('Фото загружено');
  };
  img.src=url;
};

// панель
gear.onclick=()=> panel.style.display = panel.style.display==='none' ? 'block' : 'none';
document.addEventListener('pointerdown',e=>{
  if(panel.style.display!=='none' && !panel.contains(e.target) && e.target!==gear) panel.style.display='none';
});
diamInp.oninput=()=>{ S.pipe=+diamInp.value; dVal.textContent=diamInp.value; draw(); };
gridInp.oninput=()=>{ S.grid=+gridInp.value; gVal.textContent=gridInp.value; draw(); };
snapInp.onchange=()=>{ S.snap=snapInp.checked; };

// старт
resize();
setStatus('Готов: Линия → 1-й тап → 2-й тап. Долгое нажатие на торце — выравнивание и правка.');
})();
</script>
</body>
</html>