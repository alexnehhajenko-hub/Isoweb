<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace ‚Äî –ª–∏–Ω–∏—è –ø–æ —Ç–∞–ø–∞–º + 3D —Å–µ—Ç–∫–∞</title>
<style>
  :root{
    --violet:#6b1dff; --violet2:#7c5bff; --ink:#111; --panel:#2b2d31;
    --ui:#ffffff; --muted:#8b8f98; --accent:#1f6bff;
  }
  html,body{height:100%;margin:0;background:#f4f5f7;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overscroll-behavior:none}
  #stage{position:fixed;inset:0;overflow:hidden}
  /* —Ñ–æ–Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ */
  #bg{position:absolute;inset:0;object-fit:contain;max-width:100%;max-height:100%;margin:auto;opacity:1;transition:opacity .15s}
  /* —Ö–æ–ª—Å—Ç—ã */
  canvas{position:absolute;inset:0;touch-action:none;display:block}
  #grid{pointer-events:none}
  /* –ø–∞–Ω–µ–ª—å */
  .bar{position:fixed;left:10px;top:10px;z-index:5;display:flex;gap:10px;flex-wrap:wrap}
  .btn{height:44px;border:0;border-radius:12px;padding:0 14px;font-weight:700;background:#fff;color:#111;box-shadow:0 2px 10px rgba(0,0,0,.12)}
  .btn.primary{background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff}
  .tog{height:44px;border-radius:12px;display:flex;align-items:center;gap:8px;background:#fff;color:#111;padding:0 14px;box-shadow:0 2px 10px rgba(0,0,0,.12)}
  .tog input{width:18px;height:18px}
  .status{position:fixed;left:10px;bottom:10px;background:rgba(0,0,0,.75);color:#9ff59f;padding:6px 8px;border-radius:8px;font-size:12px;z-index:6}
</style>
</head>
<body>
<div id="stage">
  <img id="bg" alt="">
  <canvas id="grid"></canvas>
  <canvas id="cv"></canvas>
</div>

<div class="bar">
  <label class="btn">
    üì∑ –§–æ—Ç–æ
    <input id="pick" type="file" accept="image/*" style="display:none">
  </label>
  <button id="btnClearBg" class="btn">üßπ –£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω</button>
  <button id="btnCenter"  class="btn">üéØ –¶–µ–Ω—Ç—Ä</button>
  <button id="btnLine"    class="btn primary">üìê –õ–∏–Ω–∏—è</button>
  <label class="tog"><input id="chkGrid" type="checkbox" checked> –°–µ—Ç–∫–∞ 3D</label>
</div>
<div id="status" class="status">–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤</div>

<script>
(()=>{'use strict';
/* ---------- –±–∞–∑–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã ---------- */
const DPR=Math.min(2,Math.max(1,devicePixelRatio||1));
const cv = document.getElementById('cv');
const g  = cv.getContext('2d',{alpha:true});
const gridCv = document.getElementById('grid');
const gg = gridCv.getContext('2d',{alpha:true});
const bg = document.getElementById('bg');
const statusEl = document.getElementById('status');
function say(m){statusEl.textContent='–°—Ç–∞—Ç—É—Å: '+m;}

function fitCanvases(){
  const w=innerWidth, h=innerHeight;
  for(const c of [cv,gridCv]){c.width=Math.round(w*DPR); c.height=Math.round(h*DPR); c.style.width=w+'px'; c.style.height=h+'px';}
  need(); drawGrid();
}
addEventListener('resize',fitCanvases,{passive:true});

/* ---------- –≤–∏–¥ –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ ---------- */
const view={tx:0,ty:0,scale:1};
const clampScale=s=>Math.max(0.3,Math.min(6,s));
function s2w(sx,sy){return{x:(sx-view.tx)/view.scale, y:(sy-view.ty)/view.scale};}
function w2s(x,y){return{x:x*view.scale+view.tx, y:y*view.scale+view.ty};}

/* ---------- —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ ---------- */
const segs=[];  // {a:{x,y}, b:{x,y}, d:diameter}
const stack=[];
let tool='idle';     // awaitFirst | awaitSecond
let first=null;      // –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞
let preview=null;    // –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Ç–æ—Ä–æ–π —Ç–æ—á–∫–∏
const params={diam:20,color:'#2b7bff'};

/* ---------- —Ä–µ–Ω–¥–µ—Ä ---------- */
let raf=0,dirty=false;
function need(){dirty=true;if(!raf){raf=requestAnimationFrame(()=>{raf=0;if(dirty){dirty=false;draw();}})}}

function draw(){
  // –æ—á–∏—Å—Ç–∫–∞
  g.setTransform(1,0,0,1,0,0);
  g.clearRect(0,0,cv.width,cv.height);

  // —Ä–∏—Å—É–µ–º —Å–µ–≥–º–µ–Ω—Ç—ã —Å —É—á—ë—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞
  g.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);
  for(const s of segs){drawPipe(s.a,s.b,params.diam,params.color);}
  // –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
  if(tool==='awaitSecond'&&first&&preview){drawPipe(first,preview,params.diam,params.color,0.45,true);}

  // –º–∞—Ä–∫–µ—Ä –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–∏
  if(first){const p=w2s(first.x,first.y); g.setTransform(1,0,0,1,0,0);
    g.fillStyle='#ff5252'; g.beginPath(); g.arc(p.x*DPR,p.y*DPR,6*DPR,0,Math.PI*2); g.fill();
  }
}

function drawPipe(A,B,diam,color,alpha=1, dashed=false){
  const dx=B.x-A.x, dy=B.y-A.y, len=Math.hypot(dx,dy)||1;
  const nx=-dy/len, ny=dx/len;            // –Ω–æ—Ä–º–∞–ª—å –¥–ª—è —Ç–æ–ª—â–∏–Ω—ã
  const r=diam/2;

  // —Ç–µ–Ω—å
  g.globalAlpha=alpha*0.5; g.fillStyle='rgba(0,0,0,.25)';
  g.beginPath();
  g.moveTo(A.x+nx*(r+2),A.y+ny*(r+2));
  g.lineTo(B.x+nx*(r+2),B.y+ny*(r+2));
  g.lineTo(B.x-nx*(r+2),B.y-ny*(r+2));
  g.lineTo(A.x-nx*(r+2),A.y-ny*(r+2));
  g.closePath(); g.fill();

  // —Ç–µ–ª–æ
  g.globalAlpha=alpha; g.fillStyle=color;
  if(dashed){g.setLineDash([12,10]); g.lineWidth=2/view.scale; g.strokeStyle=color;}
  g.beginPath();
  g.moveTo(A.x+nx*r, A.y+ny*r);
  g.lineTo(B.x+nx*r, B.y+ny*r);
  g.lineTo(B.x-nx*r, B.y-ny*r);
  g.lineTo(A.x-nx*r, A.y-ny*r);
  g.closePath(); g.fill();
  if(dashed){g.stroke(); g.setLineDash([]);}
  g.globalAlpha=1;
}

/* ---------- —Å–µ—Ç–∫–∞ ¬´–ø—Å–µ–≤–¥–æ-3D¬ª ---------- */
let gridOn=true;
function drawGrid(){
  gg.setTransform(1,0,0,1,0,0);
  gg.clearRect(0,0,gridCv.width,gridCv.height);
  if(!gridOn) return;
  const W=gridCv.width, H=gridCv.height;
  const cx=W/2, cy=H*0.62; // –ª–∏–Ω–∏—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞ –ø–æ–Ω–∏–∂–µ —Ü–µ–Ω—Ç—Ä–∞
  const vp={x:cx, y:H*0.28}; // —Ç–æ—á–∫–∞ —Å—Ö–æ–¥–∞

  gg.strokeStyle='rgba(255,255,255,.18)';
  gg.lineWidth=1;

  // –ø—Ä–æ–¥–æ–ª—å–Ω—ã–µ (–∫ –≥–æ—Ä–∏–∑–æ–Ω—Ç—É)
  for(let y=cy; y<H; y+=32*DPR){
    gg.beginPath(); gg.moveTo(0,y); gg.lineTo(W,y); gg.stroke();
  }

  // –ø–æ–ø–µ—Ä–µ—á–Ω—ã–µ (–∫ —Ç–æ—á–∫–µ —Å—Ö–æ–¥–∞)
  const step=48*DPR;
  for(let x=-W; x<=W*2; x+=step){
    gg.beginPath(); gg.moveTo(x,H); gg.lineTo(vp.x,vp.y); gg.stroke();
  }

  // –æ—Å–∏
  gg.strokeStyle='rgba(80,180,255,.35)';
  gg.beginPath(); gg.moveTo(cx,0); gg.lineTo(cx,H); gg.stroke();
  gg.strokeStyle='rgba(250,120,80,.35)';
  gg.beginPath(); gg.moveTo(0,cy); gg.lineTo(W,cy); gg.stroke();
}

/* ---------- –≤–≤–æ–¥: –ø–∞–Ω/–∑—É–º –∏ —Ç–∞–ø –¥–ª—è –ª–∏–Ω–∏–π ---------- */
const pointers=new Map(); let isPanning=false; let panLast=null;
cv.addEventListener('pointerdown',e=>{
  e.preventDefault();
  const sx=e.clientX*DPR, sy=e.clientY*DPR;
  pointers.set(e.pointerId,{sx,sy});
  // –∂–µ—Å—Ç –¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏ ‚Äî –∑—É–º
  if(pointers.size===2){return;}
  // –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–∏–º –ø–∞–ª—å—Ü–µ–º, –µ—Å–ª–∏ –Ω–µ –∂–¥—ë–º —Ç–æ—á–∫—É
  if(tool==='idle'){isPanning=true; panLast={sx,sy}; say('–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ'); return;}
  // —Ä–µ–∂–∏–º –ª–∏–Ω–∏—è ‚Äî —Å—Ç–∞–≤–∏–º —Ç–æ—á–∫–∏
  if(tool==='awaitFirst'){first=s2w(sx,sy); tool='awaitSecond'; preview=null; say('–ü–æ—Å—Ç–∞–≤–∏–ª 1-—é —Ç–æ—á–∫—É'); need(); return;}
  if(tool==='awaitSecond'){preview=s2w(sx,sy); segs.push({a:first,b:preview, d:params.diam}); stack.push('seg'); first=null; preview=null; tool='idle'; say('–°–µ–≥–º–µ–Ω—Ç –≥–æ—Ç–æ–≤. –î–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –Ω–∞–∂–º–∏ ¬´–õ–∏–Ω–∏—è¬ª.'); need(); return;}
},{passive:false});

cv.addEventListener('pointermove',e=>{
  if(!pointers.has(e.pointerId))return;
  const sx=e.clientX*DPR, sy=e.clientY*DPR; pointers.set(e.pointerId,{sx,sy});
  if(pointers.size===2){
    const [p0,p1]=[...pointers.values()];
    const d0=Math.hypot(p0.sx-p1.sx,p0.sy-p1.sy)||1;
    const k=e.pressure>0?1.0:1.0; // –æ—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è iPadOS
    const ns=clampScale(view.scale*(1 + ( (Math.hypot(p0.sx-p1.sx,p0.sy-p1.sy)-d0)/(800*DPR) )));
    const cx=innerWidth*DPR/2, cy=innerHeight*DPR/2;
    view.tx=cx-(cx-view.tx)*(ns/view.scale);
    view.ty=cy-(cy-view.ty)*(ns/view.scale);
    view.scale=ns; need(); return;
  }
  if(isPanning&&panLast){view.tx+=(sx-panLast.sx); view.ty+=(sy-panLast.sy); panLast={sx,sy}; need(); return;}
  if(tool==='awaitSecond'&&first){preview=s2w(sx,sy); need();}
},{passive:true});

cv.addEventListener('pointerup',e=>{pointers.delete(e.pointerId); if(isPanning&&pointers.size===0){isPanning=false; panLast=null;}},{passive:true});

/* ---------- –∫–Ω–æ–ø–∫–∏ ---------- */
document.getElementById('btnLine').onclick=()=>{tool='awaitFirst'; first=null; preview=null; say('–õ–∏–Ω–∏—è: —Ç–∫–Ω–∏ 1-—é —Ç–æ—á–∫—É');};
document.getElementById('btnCenter').onclick=()=>{view.tx=0; view.ty=0; view.scale=1; need(); say('–¶–µ–Ω—Ç—Ä');};
document.getElementById('btnClearBg').onclick=()=>{bg.src=''; bg.removeAttribute('src'); say('–§–æ–Ω –æ—á–∏—â–µ–Ω');};

document.getElementById('chkGrid').onchange=(e)=>{gridOn=e.target.checked; drawGrid();};

/* ---------- –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ ---------- */
document.getElementById('pick').onchange=(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const url=URL.createObjectURL(f);
  bg.src=url;
  say('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
};

/* ---------- —Å—Ç–∞—Ä—Ç ---------- */
fitCanvases();
say('–ì–æ—Ç–æ–≤: ¬´–§–æ—Ç–æ¬ª –¥–ª—è —Ñ–æ–Ω–∞, ¬´–°–µ—Ç–∫–∞ 3D¬ª ‚Äî –≤–∫–ª/–≤—ã–∫–ª, ¬´–õ–∏–Ω–∏—è¬ª ‚Üí 1-—è —Ç–æ—á–∫–∞ ‚Üí 2-—è —Ç–æ—á–∫–∞.');
})();
</script>
</body>
</html>