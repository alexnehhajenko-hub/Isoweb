<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace ‚Äî 3D + –§–æ—Ç–æ (–æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º)</title>
<style>
  html,body{margin:0;height:100%;background:#0e0e0f;font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif}
  #app{position:fixed;inset:0}
  .bar{position:fixed;left:10px;top:10px;z-index:10;display:flex;gap:8px;flex-wrap:wrap}
  .btn{height:40px;padding:0 12px;border:0;border-radius:10px;background:#2b2b2f;color:#fff;font-weight:700}
  .btn.ghost{background:#4b4b52}
  input[type=file]{display:none}
  .status{position:fixed;left:10px;bottom:10px;color:#77ff77;background:#111b;padding:6px 8px;border-radius:8px;font-size:12px;z-index:10}
</style>
</head>
<body>
  <div id="app"></div>

  <div class="bar">
    <label class="btn">üì∑ –§–æ—Ç–æ
      <input id="bgUpload" type="file" accept="image/*" capture="environment">
    </label>
    <button id="btnClearBg" class="btn ghost">üßπ –£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω</button>
    <button id="btnReset"   class="btn ghost">üéØ –¶–µ–Ω—Ç—Ä</button>
  </div>

  <div id="status" class="status">–°—Ç–∞—Ç—É—Å: –∑–∞–≥—Ä—É–∂–∞—é 3D‚Ä¶</div>

<script>
(()=>{ 'use strict';
  const statusEl = document.getElementById('status');
  const appEl = document.getElementById('app');
  const setStatus = t => statusEl.textContent = '–°—Ç–∞—Ç—É—Å: ' + t;

  // ===== –ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫ (CDN) –æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º =====
  function addScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; s.defer=true; document.head.appendChild(s); }); }
  (async function load(){
    try{
      await addScript('https://unpkg.com/three@0.160.1/build/three.min.js');
      await addScript('https://unpkg.com/three@0.160.1/examples/js/controls/OrbitControls.js');
      init();
    }catch(e){ setStatus('–Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏'); console.error(e); }
  })();

  function init(){
    setStatus('3D –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
    const DPR = Math.min(2, Math.max(1, window.devicePixelRatio||1));

    // –°—Ü–µ–Ω–∞
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0e0e0f);

    // –ö–∞–º–µ—Ä–∞
    const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 2000);
    camera.position.set(12, 10, 14);

    // –†–µ–Ω–¥–µ—Ä–µ—Ä
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(DPR);
    renderer.setSize(innerWidth, innerHeight);
    appEl.appendChild(renderer.domElement);

    // –°–≤–µ—Ç
    scene.add(new THREE.HemisphereLight(0xffffff, 0x222233, 0.8));
    const dl = new THREE.DirectionalLight(0xffffff, 0.6); dl.position.set(10,15,8); scene.add(dl);

    // –°–µ—Ç–∫–∞ + –æ—Å–∏
    const grid = new THREE.GridHelper(100, 100, 0x3a3a3f, 0x1f1f22);
    grid.material.opacity = 0.6; grid.material.transparent = true;
    scene.add(grid);
    scene.add(new THREE.AxesHelper(2.5));

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.dampingFactor = 0.08; controls.target.set(0,0,0);

    // –†–µ—Å–∞–π–∑
    addEventListener('resize', ()=>{
      camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    }, {passive:true});

    // ===== –§–æ—Ç–æ –∫–∞–∫ —Ñ–æ–Ω =====
    const input = document.getElementById('bgUpload');
    const btnClear = document.getElementById('btnClearBg');
    const btnReset = document.getElementById('btnReset');

    input.addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ev=>{
        setStatus('—Å—Ç–∞–≤–ª—é —Ñ–æ—Ç–æ —Ñ–æ–Ω–æ–º‚Ä¶');
        const tex = new THREE.TextureLoader().load(ev.target.result, ()=>{
          scene.background = tex;
          // –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —Ü–≤–µ—Ç–æ–≤
          if (THREE.SRGBColorSpace) tex.colorSpace = THREE.SRGBColorSpace;
          setStatus('—Ñ–æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        }, undefined, ()=> setStatus('–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ'));
      };
      reader.readAsDataURL(file);
      e.target.value = '';
    });

    btnClear.addEventListener('click', ()=>{
      scene.background = new THREE.Color(0x0e0e0f);
      setStatus('—Ñ–æ–Ω —É–¥–∞–ª—ë–Ω');
    });

    btnReset.addEventListener('click', ()=>{
      controls.target.set(0,0,0);
      camera.position.set(12,10,14);
      controls.update();
      setStatus('–∫–∞–º–µ—Ä–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É');
    });

    // –†–µ–Ω–¥–µ—Ä-—Ü–∏–∫–ª
    (function loop(){ controls.update(); renderer.render(scene, camera); requestAnimationFrame(loop); })();
  }
})();
</script>
</body>
</html>