<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IsoPipe 3D</title>
  <style>
    body, html { margin:0; padding:0; overflow:hidden; background:#000; }
    #ui { position:fixed; top:10px; left:10px; z-index:10; }
    button { margin:3px; padding:6px 10px; border:none; border-radius:8px; background:#333; color:#fff; }
    button:active { background:#555; }
    #settingsPanel {
      position:fixed; top:10px; right:10px; padding:10px;
      background:#fff; border-radius:10px; display:none; z-index:11;
    }
    #settingsPanel label { display:block; margin:5px 0 2px; }
    canvas { display:block; }
  </style>
</head>
<body>
  <div id="ui">
    <button id="lineBtn">Линия</button>
    <button id="undoBtn">Назад</button>
    <button id="photoBtn">Фото</button>
    <button id="centerBtn">Центр</button>
    <button id="settingsBtn">⚙</button>
    <input type="file" id="bgInput" accept="image/*" style="display:none">
  </div>

  <div id="settingsPanel">
    <label>Ø трубы (мм)</label>
    <input type="range" id="diameter" min="10" max="100" value="40">
    <label>Размер сетки</label>
    <input type="range" id="gridSize" min="10" max="100" value="40">
    <label><input type="checkbox" id="isometry" checked> Изометрия</label>
    <br><button id="closeSettings">Закрыть</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/examples/js/controls/OrbitControls.js"></script>

  <script>
    let scene = new THREE.Scene();
    let camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
    let renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Сетка
    let gridSize = 40;
    let gridHelper = new THREE.GridHelper(1000, gridSize, 0x444444, 0x888888);
    scene.add(gridHelper);

    // Камера и управление
    camera.position.set(200,200,200);
    let controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.screenSpacePanning = true;

    // Свет
    scene.add(new THREE.AmbientLight(0xffffff, 0.8));
    let dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
    dirLight.position.set(100,200,100);
    scene.add(dirLight);

    // Фон
    let bgTexture = null;
    function setBackground(img) {
      let loader = new THREE.TextureLoader();
      loader.load(img, tex => {
        scene.background = tex;
      });
    }

    // Трубы
    let pipes = [];
    let startPoint = null;
    let diameter = 40;

    function addPipe(p1, p2) {
      let dir = new THREE.Vector3().subVectors(p2, p1);
      let length = dir.length();
      let mid = new THREE.Vector3().addVectors(p1, p2).multiplyScalar(0.5);

      let geometry = new THREE.CylinderGeometry(diameter/2, diameter/2, length, 16);
      let material = new THREE.MeshStandardMaterial({color:0x0077ff});
      let cylinder = new THREE.Mesh(geometry, material);

      // Ориентация
      cylinder.quaternion.setFromUnitVectors(
        new THREE.Vector3(0,1,0),
        dir.clone().normalize()
      );
      cylinder.position.copy(mid);

      scene.add(cylinder);
      pipes.push(cylinder);
    }

    // Управление кнопками
    document.getElementById("lineBtn").onclick = () => {
      renderer.domElement.onclick = (event) => {
        let mouse = new THREE.Vector2(
          (event.clientX / window.innerWidth) * 2 - 1,
          -(event.clientY / window.innerHeight) * 2 + 1
        );
        let raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);
        let plane = new THREE.Plane(new THREE.Vector3(0,1,0),0);
        let point = new THREE.Vector3();
        raycaster.ray.intersectPlane(plane, point);

        if (!startPoint) {
          startPoint = point.clone();
        } else {
          addPipe(startPoint, point);
          startPoint = null;
        }
      };
    };

    document.getElementById("undoBtn").onclick = () => {
      let last = pipes.pop();
      if (last) scene.remove(last);
    };

    document.getElementById("photoBtn").onclick = () => {
      document.getElementById("bgInput").click();
    };
    document.getElementById("bgInput").onchange = (e) => {
      let file = e.target.files[0];
      if (file) setBackground(URL.createObjectURL(file));
    };

    document.getElementById("centerBtn").onclick = () => {
      controls.reset();
    };

    document.getElementById("settingsBtn").onclick = () => {
      document.getElementById("settingsPanel").style.display = "block";
    };
    document.getElementById("closeSettings").onclick = () => {
      document.getElementById("settingsPanel").style.display = "none";
    };

    document.getElementById("diameter").oninput = (e) => {
      diameter = e.target.value;
    };

    document.getElementById("gridSize").oninput = (e) => {
      scene.remove(gridHelper);
      gridHelper = new THREE.GridHelper(1000, e.target.value, 0x444444, 0x888888);
      scene.add(gridHelper);
    };

    document.getElementById("isometry").oninput = (e) => {
      if (e.target.checked) {
        camera.toOrthographic = true;
        let aspect = window.innerWidth / window.innerHeight;
        camera = new THREE.OrthographicCamera(-200*aspect,200*aspect,200,-200,1,2000);
        camera.position.set(200,200,200);
        controls = new THREE.OrbitControls(camera, renderer.domElement);
      } else {
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
        camera.position.set(200,200,200);
        controls = new THREE.OrbitControls(camera, renderer.domElement);
      }
    };

    // Анимация
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>