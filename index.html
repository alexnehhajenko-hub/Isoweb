<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace ‚Äî v868 tap + armature</title>
<style>
  :root{--violet:#6b1dff; --violet2:#7c5bff; --border:#e7e3f7}
  html,body{margin:0;height:100%;background:#f2f3f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  #cv{position:fixed;inset:0;display:block;width:100vw;height:100vh;background:#fff;touch-action:none;-webkit-user-select:none;user-select:none}

  .bar{position:fixed;left:8px;top:8px;z-index:10;display:flex;gap:8px;flex-wrap:wrap}
  .btn{height:44px;padding:0 14px;border:0;border-radius:12px;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff;font-weight:800}
  .btn.ghost{background:linear-gradient(180deg,#8c8c8c,#6a6a6a)}

  .zoom{position:fixed;right:8px;top:8px;z-index:11;display:flex;gap:8px}
  .zbtn{height:44px;min-width:44px;border:0;border-radius:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);font-size:18px}

  .gear{position:fixed;right:8px;top:64px;z-index:12;height:44px;width:44px;border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);font-size:20px}
  .status{position:fixed;left:8px;bottom:8px;background:rgba(0,0,0,.70);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;z-index:11;max-width:92vw}

  .panel-wrap{position:fixed;inset:0;z-index:20;display:none}
  .panel-wrap.open{display:block}
  .panel-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.18)}
  .panel{position:absolute;top:64px;right:8px;background:#fff;border:1px solid var(--border);
         border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:12px;width:min(92vw,380px);
         max-height:80vh;overflow:auto}
  .panel h4{margin:6px 0 8px;font-size:15px}
  .row{display:flex;align-items:center;gap:10px;margin:10px 0}
  .row label{min-width:140px;font-size:13px;color:#444}
  .close{position:sticky;top:0;margin:-6px -6px 6px auto;background:#fff;border:1px solid var(--border);width:32px;height:32px;border-radius:8px}
  input[type=range]{width:100%}
  .num{font-variant-numeric:tabular-nums;color:#111;font-weight:700}
  .radio-row{display:flex;gap:10px;flex-wrap:wrap}
  .radio{display:flex;align-items:center;gap:6px;border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:12px;color:#333}
  .radio input{accent-color:#6b1dff}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="bar">
    <button id="btnLine"  class="btn">üìê –õ–∏–Ω–∏—è</button>
    <button id="btnUndo"  class="btn ghost">‚Ü© –ù–∞–∑–∞–¥</button>
    <button id="btnHand"  class="btn ghost">üñê –†—É–∫–∞</button>
  </div>

  <div class="zoom">
    <button id="btnMinus" class="zbtn" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
    <button id="btnPlus"  class="zbtn" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
  </div>

  <button id="btnSettings" class="gear" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öô</button>

  <div id="panelWrap" class="panel-wrap" aria-hidden="true">
    <div id="panelBackdrop" class="panel-backdrop"></div>
    <div id="panel" class="panel" role="dialog" aria-modal="true">
      <button id="btnClosePanel" class="close" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>

      <h4>–ß–µ—Ä—Ç—ë–∂</h4>
      <div class="row">
        <label for="rangeLine">–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏</label>
        <input id="rangeLine" type="range" min="2" max="56" step="1">
        <span id="lineVal" class="num">10</span>
      </div>

      <div class="row">
        <label for="rangeComp">–ê—Ä–º–∞—Ç—É—Ä–∞ √ó</label>
        <input id="rangeComp" type="range" min="0.5" max="3.0" step="0.01">
        <span id="compVal" class="num">1.15</span>
      </div>

      <div class="row" style="margin-top:8px">
        <label>–¢–∏–ø –∞—Ä–º–∞—Ç—É—Ä—ã</label>
        <div class="radio-row">
          <label class="radio"><input type="radio" name="comp" value="valve" checked> –ö—Ä–∞–Ω</label>
          <label class="radio"><input type="radio" name="comp" value="check"> –ö–ª–∞–ø–∞–Ω</label>
          <label class="radio"><input type="radio" name="comp" value="pump"> –ù–∞—Å–æ—Å</label>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="btnPlaceComp" class="btn">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Ç—Ä—É–±—É</button>
      </div>
    </div>
  </div>

  <div id="status" class="status">–°—Ç–∞—Ç—É—Å: –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

<script>
(()=>{"use strict";
const DPR=Math.min(1.5,Math.max(1,window.devicePixelRatio||1));
const cv=document.getElementById('cv');
const ctx=cv.getContext('2d',{alpha:false});
const statusEl=document.getElementById('status');

const view={tx:0,ty:0,scale:1};
const clampScale=s=>Math.max(0.25,Math.min(6,s));
function fit(){cv.width=Math.round(innerWidth*DPR);cv.height=Math.round(innerHeight*DPR);need();}
addEventListener('resize',fit,{passive:true});

const segs=[];const comps=[];const stack=[];
let tool='idle';let mode='hand';let first=null,preview=null;let currentComp='valve';
const params={linePx:10,lineColor:'#1f6bff',compScale:1.15};
function updateStatus(msg=''){const t=tool==='awaitFirst'?'–ñ–¥—É 1-—é —Ç–æ—á–∫—É':tool==='awaitSecond'?'–ñ–¥—É 2-—é —Ç–æ—á–∫—É':mode==='hand'?'–†—É–∫–∞':'–ì–æ—Ç–æ–≤';statusEl.textContent=`–°—Ç–∞—Ç—É—Å: ${msg} | ${t}`;}

function s2w(sx,sy){return{x:(sx-view.tx)/view.scale,y:(sy-view.ty)/view.scale};}
function w2s(x,y){return{x:x*view.scale+view.tx,y:y*view.scale+view.ty};}
function darker(hex,k=0.45){const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);if(!m)return'#333';let[r,g,b]=[parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16)];r=Math.max(0,Math.floor(r*(1-k)));g=Math.max(0,Math.floor(g*(1-k)));b=Math.max(0,Math.floor(b*(1-k)));return'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');}

function segGeom(seg){const vx=seg.b.x-seg.a.x,vy=seg.b.y-seg.a.y;const L=Math.hypot(vx,vy)||1;return{vx,vy,L,nx:vx/L,ny:vy/L};}
function compBasis(seg,t){const g=segGeom(seg);return{x:seg.a.x+g.nx*g.L*t,y:seg.a.y+g.ny*g.L*t,ux:g.nx,uy:g.ny,nx:-g.ny,ny:g.nx};}

function drawSegments(){ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);const col=params.lineColor,sh=darker(col,0.45);for(const s of segs){ctx.strokeStyle=sh;ctx.globalAlpha=.75;ctx.lineWidth=(params.linePx+2)/view.scale;ctx.beginPath();ctx.moveTo(s.a.x,s.a.y);ctx.lineTo(s.b.x,s.b.y);ctx.stroke();ctx.strokeStyle=col;ctx.globalAlpha=1;ctx.lineWidth=params.linePx/view.scale;ctx.beginPath();ctx.moveTo(s.a.x,s.a.y);ctx.lineTo(s.b.x,s.b.y);ctx.stroke();}} 

function drawValve(seg,t){const b=compBasis(seg,t);ctx.save();ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);ctx.fillStyle='#6b1dff';ctx.beginPath();ctx.arc(b.x,b.y,params.linePx*params.compScale*2,0,Math.PI*2);ctx.fill();ctx.restore();}
function drawCheck(seg,t){const b=compBasis(seg,t);ctx.save();ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);ctx.strokeStyle='#6b1dff';ctx.beginPath();ctx.moveTo(b.x-8,b.y-8);ctx.lineTo(b.x+8,b.y+8);ctx.moveTo(b.x+8,b.y-8);ctx.lineTo(b.x-8,b.y+8);ctx.stroke();ctx.restore();}
function drawPump(seg,t){const b=compBasis(seg,t);ctx.save();ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);ctx.fillStyle='#6b1dff';ctx.fillRect(b.x-10,b.y-6,20,12);ctx.restore();}

function draw(){ctx.setTransform(1,0,0,1,0,0);ctx.fillStyle='#fff';ctx.fillRect(0,0,cv.width,cv.height);drawSegments();for(const c of comps){const seg=segs[c.segIndex];if(!seg)continue;if(c.type==='valve')drawValve(seg,c.t);else if(c.type==='check')drawCheck(seg,c.t);else if(c.type==='pump')drawPump(seg,c.t);}if(tool==='awaitSecond'&&first&&preview){ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);ctx.strokeStyle=params.lineColor;ctx.lineWidth=params.linePx/view.scale;ctx.beginPath();ctx.moveTo(first.x,first.y);ctx.lineTo(preview.x,preview.y);ctx.stroke();}if(first){const p=w2s(first.x,first.y);ctx.setTransform(1,0,0,1,0,0);ctx.fillStyle='red';ctx.beginPath();ctx.arc(p.x,p.y,6,0,Math.PI*2);ctx.fill();}}
let raf=0,dirty=false;function need(){dirty=true;if(!raf){raf=requestAnimationFrame(()=>{raf=0;if(dirty){dirty=false;draw();}});}}

function findNearestSegment(sx,sy,maxDistPx=28){let best=-1,bd=1e9,bt=0;for(let i=0;i<segs.length;i++){const s=segs[i];const A=w2s(s.a.x,s.a.y),B=w2s(s.b.x,s.b.y);const vx=B.x-A.x,vy=B.y-A.y,len2=vx*vx+vy*vy;if(!len2)continue;const t=Math.max(0,Math.min(1,((sx-A.x)*vx+(sy-A.y)*vy)/len2));const px=A.x+vx*t,py=A.y+vy*t,d=Math.hypot(px-sx,py-sy);if(d<bd){bd=d;best=i;bt=t;}}return(best!==-1&&bd<=maxDistPx)?{segIndex:best,t:bt}:null;}

const pointers=new Map();let isPanning=false,panLast=null;let prevCenter=null,prevDist=null;
function canvasXY(e){const r=cv.getBoundingClientRect();return{sx:(e.clientX-r.left)*(cv.width/r.width),sy:(e.clientY-r.top)*(cv.height/r.height)};}
function centroid(){const a=[...pointers.values()];if(!a.length)return null;let sx=0,sy=0;for(const p of a){sx+=p.sx;sy+=p.sy;}return{sx:sx/a.length,sy:sy/a.length};}
function dist2(a,b){return Math.abs(a.sx-b.sx)+Math.abs(a.sy-b.sy);}

cv.addEventListener('pointerdown',e=>{const{sx,sy}=canvasXY(e);pointers.set(e.pointerId,{sx,sy});if(pointers.size===2){const[p0,p1]=[...pointers.values()];prevCenter=centroid();prevDist=dist2(p0,p1);return;}if(mode==='hand'){isPanning=true;panLast={sx,sy};updateStatus('–ü–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ');return;}if(tool==='awaitFirst'){first=s2w(sx,sy);preview=null;tool='awaitSecond';updateStatus('1-—è —Ç–æ—á–∫–∞ –µ—Å—Ç—å');need();return;}if(tool==='awaitSecond'){preview=s2w(sx,sy);segs.push({a:first,b:preview});stack.push('seg');first=null;preview=null;tool='idle';mode='hand';updateStatus('–°–µ–≥–º–µ–Ω—Ç –≥–æ—Ç–æ–≤. –ß—Ç–æ–±—ã –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –µ—â—ë, —Å–Ω–æ–≤–∞ –Ω–∞–∂–º–∏ –õ–∏–Ω–∏—è');need();return;}if(tool==='placeComp'){const near=findNearestSegment(sx,sy,28*DPR);if(near){comps.push({segIndex:near.segIndex,t:near.t,type:currentComp});stack.push('comp');tool='idle';mode='hand';updateStatus('–ê—Ä–º–∞—Ç—É—Ä–∞ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞');need();}else updateStatus('–¢–∫–Ω–∏ –ø–æ –ª–∏–Ω–∏–∏');return;}},{passive:false});

cv.addEventListener('pointermove',e=>{if(!pointers.has(e.pointerId))return;const{sx,sy}=canvasXY(e);pointers.set(e.pointerId,{sx,sy});if(pointers.size===2){const nowC=centroid();const[p0,p1]=[...pointers.values()];const nowD=dist2(p0,p1);if(prevCenter&&prevDist){const k=nowD>0&&prevDist>0?(nowD/prevDist):1;const ns=clampScale(view.scale*k);const cx=nowC.sx,cy=nowC.sy;view.tx=cx-(cx-view.tx)*(ns/view.scale);view.ty=cy-(cy-view.ty)*(ns/view.scale);view.scale=ns;need();}prevCenter=nowC;prevDist=nowD;return;}if(isPanning&&panLast){view.tx+=(sx-panLast.sx);view.ty+=(sy-panLast.sy);panLast={sx,sy};need();return;}if(tool==='awaitSecond'&&first){preview=s2w(sx,sy);need();}},{passive:true});

cv.addEventListener('pointerup',e=>{pointers.delete(e.pointerId);if(pointers.size<2){prevCenter=null;prevDist=null;}if(isPanning&&pointers.size===0){isPanning=false;panLast=null;}},{passive:true});

const $=id=>document.getElementById(id);
$('btnLine').onclick=()=>{tool='awaitFirst';mode='line';first=null;preview=null;updateStatus('–†–µ–∂–∏–º –õ–∏–Ω–∏—è: —Ç–∫–Ω–∏ 1-—é —Ç–æ—á–∫—É');};
$('btnHand').onclick=()=>{tool='idle';mode='hand';first=null;preview=null;updateStatus('–†–µ–∂–∏–º –†—É–∫–∞');};
$('btnUndo').onclick=()=>{if(tool==='awaitSecond'&&first){first=null;preview=null;tool='idle';mode='hand';need();updateStatus('–°–µ–≥–º–µ–Ω—Ç –æ—Ç–º–µ–Ω—ë–Ω');return;}const last=stack.pop();if(!last){updateStatus('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å');return;}if(last==='seg'&&segs.length)segs.pop();else if(last==='comp'&&comps.length)comps.pop();need();updateStatus('–û—Ç–º–µ–Ω–µ–Ω–æ');};
function zoomAt(f){const cx=cv.width/2,cy=cv.height/2;const ns=clampScale(view.scale*f);view.tx=cx-(cx-view.tx)*(ns/view.scale);view.ty=cy-(cy-view.ty)*(ns/view.scale);view.scale=ns;need();}
$('btnPlus').onclick=()=>zoomAt(1.2);
$('btnMinus