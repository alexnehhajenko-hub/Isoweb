<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>IsoPipe ‚Äî –∏–∑–æ–º–µ—Ç—Ä–∏—è –ø–æ —Ç–æ—á–∫–∞–º</title>
  <style>
    :root{--violet:#7b2cff;--violet2:#6a1bff}
    html,body{margin:0;height:100%;background:#f2f3f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden;touch-action:none}
    canvas{display:block;width:100vw;height:100vh;background:#fff;touch-action:none;user-select:none;-webkit-user-select:none}

    .bar{position:fixed;left:0;right:56px;top:0;z-index:1000;padding:8px 8px 0 8px;transition:.2s}
    .bar-scroll{display:flex;gap:10px;overflow-x:auto;padding-bottom:8px;-webkit-overflow-scrolling:touch}
    .bar-scroll::-webkit-scrollbar{display:none}

    .btn{min-width:100px;height:44px;padding:0 14px;border:0;border-radius:12px;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff;font-weight:800;font-size:14px;white-space:nowrap;flex:0 0 auto}
    .btn.ghost{background:linear-gradient(180deg,#8c8c8c,#6a6a6a)}
    .btn.active{filter:brightness(1.08)}

    .gear{position:fixed;top:8px;right:8px;width:44px;height:44px;border-radius:12px;border:1px solid #e7e3f7;background:#fff;color:#5b30c2;font-weight:800;z-index:1001}

    .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#1f1f2e;color:#fff;padding:8px 10px;border-radius:10px;opacity:0;transition:.25s;z-index:1100;pointer-events:none}
    .toast.show{opacity:1}

    .angle-tag{position:fixed;pointer-events:none;z-index:1002;background:rgba(27,27,42,.9);color:#fff;font-size:12px;padding:4px 6px;border-radius:8px;transform:translate(-50%,-130%);white-space:nowrap}
  </style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="bar" id="topBar">
    <div class="bar-scroll">
      <button id="btnHand" class="btn ghost">üñê –†—É–∫–∞</button>
      <button id="btnLine" class="btn">üìê –õ–∏–Ω–∏—è</button>
      <button id="btnUndo" class="btn ghost">‚Ü© –ù–∞–∑–∞–¥</button>
      <label class="btn ghost">
        üñº –§–æ—Ç–æ/–ì–∞–ª–µ—Ä–µ—è
        <input id="pickImage" type="file" accept="image/*" style="display:none">
      </label>
      <button id="btnClearImage" class="btn ghost">‚úñ –£–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</button>
    </div>
  </div>

  <button id="btnSettings" class="gear">‚öô</button>

  <div id="angleTag" class="angle-tag" style="display:none">0¬∞</div>
  <div id="toast" class="toast"></div>

<script>
(function(){
  const DPR = window.devicePixelRatio||1;
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const $ = id=>document.getElementById(id);

  let mode='hand';
  const segs=[];
  let firstPt=null,previewPt=null;
  const snap={on:true,radius:18};

  let bgImg=null, view={scale:1,tx:0,ty:0};

  const pointers=new Map();

  function fit(){
    cv.width=innerWidth*DPR; cv.height=innerHeight*DPR;
    requestRedraw();
  }
  addEventListener('resize',fit);

  function screenToWorld(sx,sy){return{x:(sx-view.tx)/view.scale,y:(sy-view.ty)/view.scale}}
  function worldToScreen(x,y){return{x:x*view.scale+view.tx,y:y*view.scale+view.ty}}
  function getCanvasPoint(e){const r=cv.getBoundingClientRect();return{sx:(e.clientX-r.left)*DPR,sy:(e.clientY-r.top)*DPR}}

  function draw(){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,cv.width,cv.height);
    if(bgImg) ctx.drawImage(bgImg,view.tx,view.ty,bgImg.width*view.scale,bgImg.height*view.scale);
    ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);

    ctx.lineCap='round'; ctx.lineJoin='round';
    ctx.strokeStyle='#7b2cff'; ctx.lineWidth=4/view.scale;
    for(const s of segs){ctx.beginPath();ctx.moveTo(s.a.x,s.a.y);ctx.lineTo(s.b.x,s.b.y);ctx.stroke();}

    // –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞
    if(firstPt){
      ctx.beginPath();ctx.fillStyle='red';ctx.arc(firstPt.x,firstPt.y,6/view.scale,0,Math.PI*2);ctx.fill();
    }
    // –ø—Ä–µ–≤—å—é
    if(firstPt&&previewPt){
      ctx.beginPath();ctx.strokeStyle='green';ctx.setLineDash([10/view.scale,6/view.scale]);
      ctx.moveTo(firstPt.x,firstPt.y);ctx.lineTo(previewPt.x,previewPt.y);ctx.stroke();ctx.setLineDash([]);
      ctx.beginPath();ctx.fillStyle='green';ctx.arc(previewPt.x,previewPt.y,5/view.scale,0,Math.PI*2);ctx.fill();
    }
  }
  let raf=0,dirty=false;
  function requestRedraw(){dirty=true;if(!raf)raf=requestAnimationFrame(()=>{raf=0;if(dirty){dirty=false;draw();}})}

  // –∂–µ—Å—Ç—ã
  cv.addEventListener('pointerdown',e=>{
    e.preventDefault();
    pointers.set(e.pointerId,getCanvasPoint(e));
    if(pointers.size===2) return; // pinch
    const {sx,sy}=getCanvasPoint(e); const p=screenToWorld(sx,sy);
    if(mode==='line'){
      if(!firstPt){firstPt=p;previewPt=null;}
      else{segs.push({a:firstPt,b:p});firstPt=null;previewPt=null;}
      requestRedraw();
    }
  });
  cv.addEventListener('pointermove',e=>{
    if(!pointers.has(e.pointerId)) return;
    pointers.set(e.pointerId,getCanvasPoint(e));
    if(pointers.size===2){
      const [p1,p2]=[...pointers.values()];
      const dx=p2.sx-p1.sx,dy=p2.sy-p1.sy;const dist=Math.hypot(dx,dy);
      if(!cv._lastDist) cv._lastDist=dist;
      else{const k=dist/cv._lastDist;cv._lastDist=dist;const cx=(p1.sx+p2.sx)/2,cy=(p1.sy+p2.sy)/2;
        view.tx=cx-k*(cx-view.tx);view.ty=cy-k*(cy-view.ty);view.scale*=k;requestRedraw();}
    }else if(mode==='line'&&firstPt){
      const {sx,sy}=getCanvasPoint(e);previewPt=screenToWorld(sx,sy);requestRedraw();
    }
  });
  cv.addEventListener('pointerup',e=>{pointers.delete(e.pointerId);cv._lastDist=null});

  // –∫–Ω–æ–ø–∫–∏
  $('btnHand').onclick=()=>{mode='hand';toast('–†—É–∫–∞');};
  $('btnLine').onclick=()=>{mode='line';firstPt=null;previewPt=null;toast('–õ–∏–Ω–∏—è');};
  $('btnUndo').onclick=()=>{segs.pop();requestRedraw();};
  $('btnClearImage').onclick=()=>{bgImg=null;requestRedraw();};
  $('pickImage').onchange=e=>{
    const file=e.target.files[0];if(!file)return;
    const img=new Image();
    img.onload=()=>{bgImg=document.createElement('canvas');bgImg.width=img.width;bgImg.height=img.height;bgImg.getContext('2d').drawImage(img,0,0);view.scale=Math.min(cv.width/bgImg.width,cv.height/bgImg.height);view.tx=0;view.ty=0;requestRedraw();};
    img.src=URL.createObjectURL(file);
  };

  function toast(t,ms=1200){const el=$('toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),ms);}
  fit();
})();
</script>
</body>
</html>