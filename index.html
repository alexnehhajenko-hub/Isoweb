<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Трассировка труб</title>
<style>
  :root { --uiH: 48px; }
  html,body{margin:0;height:100%;background:#f0f0f3;font-family:system-ui,Arial}
  /* Верхняя панель */
  #ui{
    position:fixed; inset:0 0 auto 0; height:var(--uiH);
    display:flex; justify-content:center; align-items:center; gap:8px;
    z-index:10; background:transparent;
  }
  button{
    background:#6a5acd; color:#fff; border:0; border-radius:12px;
    padding:8px 14px; font-size:14px; white-space:nowrap;
  }
  button:active{opacity:.88}
  /* Холст */
  #wrap{
    position:fixed; inset:var(--uiH) 0 0 0;
    display:flex; justify-content:center; align-items:center; padding:8px;
  }
  canvas{
    width:95vw; height:calc(95vh - var(--uiH));
    border:1px solid #d8d8e0; background:#fff; border-radius:8px;
    touch-action:none; /* запрет жестов браузера над холстом */
  }
  /* Панель настроек */
  #panel{
    position:fixed; right:10px; top:calc(var(--uiH) + 10px);
    background:#fff; border:1px solid #e6e6ee; border-radius:12px;
    box-shadow:0 8px 18px rgba(0,0,0,.06); padding:10px 12px; z-index:20;
    display:none; min-width:230px;
  }
  #panel h3{margin:0 0 8px; font-size:14px}
  #panel label{display:block; font-size:13px; margin:8px 0 4px}
  #status{
    position:fixed; left:10px; bottom:10px; z-index:30;
    background:rgba(0,0,0,.72); color:#fff; padding:6px 10px;
    border-radius:10px; font-size:13px
  }
</style>
</head>
<body>
  <div id="ui">
    <button id="lineBtn">Линия</button>
    <button id="undoBtn">Назад</button>
    <button id="centerBtn">Центр</button>
    <button id="saveBtn">Сохранить</button>
    <button id="settingsBtn">Настройки</button>
  </div>

  <div id="wrap">
    <canvas id="cv"></canvas>
  </div>

  <div id="panel">
    <h3>Параметры</h3>
    <label>Толщина трубы</label>
    <input id="wRange" type="range" min="2" max="40" value="10">
    <label style="margin-top:10px">Фото (фон)</label>
    <input id="bgInput" type="file" accept="image/*">
  </div>

  <div id="status">Режим: ожидание</div>

<script>
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d', { alpha:false });

function fitCanvas(){
  const r = window.devicePixelRatio || 1;
  const w = Math.round(cv.clientWidth * r);
  const h = Math.round(cv.clientHeight * r);
  cv.width = w; cv.height = h;
  ctx.setTransform(r,0,0,r,0,0);
  draw();
}
addEventListener('resize', fitCanvas);
fitCanvas();

let pipeW = 10;
let bgImg = null;
const pipes = [];   // {x1,y1,x2,y2}
let mode = 'idle';  // 'idle' | 'line'
let p1 = null;      // первая точка
let preview = null; // временная линия

const statusEl = document.getElementById('status');
const setStatus = t => statusEl.textContent = t;

document.getElementById('wRange').oninput = e => { pipeW = +e.target.value; draw(); };
document.getElementById('bgInput').onchange = e => {
  const f = e.target.files[0]; if(!f) return;
  const img = new Image();
  img.onload = ()=>{ bgImg = img; draw(); };
  img.src = URL.createObjectURL(f);
};

document.getElementById('lineBtn').onclick = ()=>{
  mode = 'line'; p1 = null; preview = null;
  setStatus('Режим: линия. Тапни первую точку');
};
document.getElementById('undoBtn').onclick = ()=>{
  pipes.pop(); preview=null; draw(); setStatus('Отменено');
};
document.getElementById('centerBtn').onclick = ()=>{ draw(); setStatus('Центр'); };
document.getElementById('saveBtn').onclick = ()=>{
  const a = document.createElement('a');
  a.download = 'pipes.png'; a.href = cv.toDataURL('image/png'); a.click();
  setStatus('PNG сохранён');
};
const panel = document.getElementById('panel');
document.getElementById('settingsBtn').onclick = ()=>{
  panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
};

function draw(){
  // фон
  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,cv.width,cv.height);
  if(bgImg){ ctx.drawImage(bgImg, 0,0, cv.width, cv.height); }

  // трубы
  ctx.strokeStyle = '#2970ff';
  ctx.lineWidth = pipeW;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  for(const s of pipes){
    ctx.beginPath(); ctx.moveTo(s.x1,s.y1); ctx.lineTo(s.x2,s.y2); ctx.stroke();
  }
  if(preview){
    ctx.beginPath(); ctx.moveTo(preview.x1,preview.y1); ctx.lineTo(preview.x2,preview.y2); ctx.stroke();
  }
}

// — касания / мышь — (Pointer события)
cv.style.touchAction = 'none';  // без системных жестов на холсте
cv.addEventListener('pointerdown', onDown);
cv.addEventListener('pointermove', onMove);
cv.addEventListener('pointerup', onUp);
cv.addEventListener('pointercancel', ()=>{ preview=null; });

function localXY(e){
  const r = cv.getBoundingClientRect();
  return { x: e.clientX - r.left, y: e.clientY - r.top };
}

function onDown(e){
  if(mode!=='line') return;
  const {x,y} = localXY(e);
  if(!p1){
    p1 = {x,y};
    preview = {x1:x,y1:y,x2:x,y2:y};
    setStatus('Первая точка. Тапни вторую.');
  }else{
    pipes.push({x1:p1.x,y1:p1.y,x2:x,y2:y});
    p1=null; preview=null; draw();
    setStatus('Линия готова. Для новой — «Линия».');
  }
}

function onMove(e){
  if(!p1) return;
  const {x,y} = localXY(e);
  preview = {x1:p1.x,y1:p1.y,x2:x,y2:y};
  draw();
}

function onUp(){ /* ничего */ }

// Полностью отключаем double-tap zoom/даблклик
document.addEventListener('dblclick', e=>e.preventDefault(), {passive:false});
</script>
</body>
</html>