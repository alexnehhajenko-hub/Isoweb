<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Isoweb ‚Äî —Ñ–æ—Ç–æ + —Ä–∞–∑–º–µ—Ç–∫–∞</title>
<style>
  :root { --bg:#0d0f12; --panel:#1c1f26; --txt:#eaecef; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif;overflow:hidden}
  #wrap{position:fixed;inset:0;overflow:hidden}

  /* –ü–æ—Ä—è–¥–æ–∫ —Å–ª–æ—ë–≤ –í–ê–ñ–ï–ù */
  #gl   {position:absolute;inset:0;z-index:0}   /* WebGL (—Å–µ—Ç–∫–∞/—Ñ–æ—Ç–æ)         */
  #grid2d{position:absolute;inset:0;z-index:1;pointer-events:none;opacity:.25}
  #draw {position:absolute;inset:0;z-index:2;touch-action:none}  /* <- —Ç—É—Ç —Ä–∏—Å—É–µ–º */

  #bar{position:absolute;left:12px;top:12px;z-index:3;display:flex;gap:10px;flex-wrap:wrap}
  .btn{background:#2b2f39;border:1px solid rgba(255,255,255,.08);border-radius:12px;color:var(--txt);padding:10px 14px;font-weight:700}
  .btn.primary{background:linear-gradient(180deg,#7aa2ff,#5a7bff);color:#fff;border:none}
  #status{position:absolute;left:10px;bottom:10px;z-index:3;background:#0a0a0c;border:1px solid rgba(255,255,255,.08);color:#7cff78;border-radius:10px;padding:6px 10px;font-size:12px}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="gl"></canvas>
  <svg id="grid2d"></svg>
  <canvas id="draw"></canvas>

  <div id="bar">
    <button class="btn" id="btnPhoto">üì∑ –§–æ—Ç–æ</button>
    <button class="btn" id="btnErasePhoto">üßπ –£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω</button>
    <button class="btn" id="btnCenter">üéØ –¶–µ–Ω—Ç—Ä</button>
    <button class="btn primary" id="btnLine">üìê –õ–∏–Ω–∏—è</button>
    <button class="btn" id="btnUndo">‚Ü©Ô∏è –ù–∞–∑–∞–¥</button>
    <input type="file" id="fileInput" accept="image/*" style="display:none" />
  </div>

  <div id="status">–°—Ç–∞—Ç—É—Å: –∑–∞–≥—Ä—É–∂–∞—é 3D‚Ä¶</div>
</div>

<!-- CDN: three + OrbitControls -->
<script src="https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.1/examples/js/controls/OrbitControls.js"></script>
<script>
(()=>{'use strict';
const DPR=Math.min(2, Math.max(1, devicePixelRatio||1));
const gl=document.getElementById('gl');
const draw=document.getElementById('draw');
const grid2d=document.getElementById('grid2d');
const statusEl=document.getElementById('status');
const setStatus = (t)=> statusEl.textContent = '–°—Ç–∞—Ç—É—Å: ' + t;

/* === THREE === */
let scene,camera,renderer,controls,grid3d,axes,photoMesh=null;

function init3D(){
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 2000);
  camera.position.set(0,2.5,7);

  renderer=new THREE.WebGLRenderer({canvas:gl,antialias:true,alpha:true});
  renderer.setPixelRatio(DPR);
  renderer.setSize(innerWidth,innerHeight,false);
  renderer.setClearAlpha(0); // —Ñ–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—Å–≤–µ—á–∏–≤–∞–µ—Ç (–Ω–µ —á—ë—Ä–Ω—ã–π –∫–æ–≤—ë—Ä)

  controls=new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping=true; controls.dampingFactor=0.08;

  grid3d=new THREE.GridHelper(20, 40, 0x404040, 0x404040);
  scene.add(grid3d);
  axes=new THREE.AxesHelper(3); scene.add(axes);

  animate();
  setStatus('3D –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
}
function animate(){ requestAnimationFrame(animate); renderer.render(scene,camera); }
function centerCam(){ camera.position.set(0,2.5,7); controls.target.set(0,0,0); controls.update(); }

function placePhoto(dataUrl){
  const loader=new THREE.TextureLoader();
  loader.load(dataUrl,(tex)=>{
    const w=12,h=12;
    const geo=new THREE.PlaneGeometry(w,h);
    const mat=new THREE.MeshBasicMaterial({map:tex, side:THREE.DoubleSide});
    if(photoMesh){ scene.remove(photoMesh); photoMesh.geometry.dispose(); photoMesh.material.dispose(); }
    photoMesh=new THREE.Mesh(geo,mat);
    photoMesh.position.set(0,0,-0.02);
    scene.add(photoMesh);
    setStatus('‚úÖ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
  },undefined,(err)=>{ setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ'); console.error(err); });
}
function removePhoto(){
  if(photoMesh){ scene.remove(photoMesh); photoMesh.geometry.dispose(); photoMesh.material.dispose(); photoMesh=null; }
  setStatus('–§–æ–Ω —É–¥–∞–ª—ë–Ω');
}

/* === 2D-—Ä–∏—Å–æ–≤–∞–Ω–∏–µ === */
const ctx = draw.getContext('2d');
const segs=[]; let tool='idle'; let first=null,preview=null;

function fitAll(){
  renderer.setSize(innerWidth, innerHeight, false);
  // 2D canvas
  draw.width = Math.round(innerWidth*DPR);
  draw.height= Math.round(innerHeight*DPR);
  draw.style.width = innerWidth+'px';
  draw.style.height= innerHeight+'px';
  // —ç–∫—Ä–∞–Ω–Ω–∞—è —Å–µ—Ç–∫–∞
  grid2d.setAttribute('width', innerWidth);
  grid2d.setAttribute('height', innerHeight);
  grid2d.innerHTML='';
  const step=40;
  for(let x=0;x<=innerWidth;x+=step){
    const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1',x); ln.setAttribute('y1',0);
    ln.setAttribute('x2',x); ln.setAttribute('y2',innerHeight);
    ln.setAttribute('stroke','#7c7c7c'); ln.setAttribute('stroke-width','1');
    grid2d.appendChild(ln);
  }
  for(let y=0;y<=innerHeight;y+=step){
    const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1',0); ln.setAttribute('y1',y);
    ln.setAttribute('x2',innerWidth); ln.setAttribute('y2',y);
    ln.setAttribute('stroke','#7c7c7c'); ln.setAttribute('stroke-width','1');
    grid2d.appendChild(ln);
  }
  redraw();
}
addEventListener('resize', fitAll);

function redraw(){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,draw.width,draw.height);
  ctx.lineCap='round'; ctx.lineJoin='round';

  for(const s of segs){
    ctx.strokeStyle='#1f6bff'; ctx.lineWidth=10*DPR;
    ctx.beginPath(); ctx.moveTo(s.a.x, s.a.y); ctx.lineTo(s.b.x, s.b.y); ctx.stroke();
  }
  if(tool==='awaitSecond' && first && preview){
    ctx.strokeStyle='#1f6bff'; ctx.lineWidth=10*DPR;
    ctx.beginPath(); ctx.moveTo(first.x, first.y); ctx.lineTo(preview.x, preview.y); ctx.stroke();
  }
  if(first){
    ctx.fillStyle='#ff3b30';
    ctx.beginPath(); ctx.arc(first.x, first.y, 6*DPR, 0, Math.PI*2); ctx.fill();
  }
}
function pos(e){
  const r=draw.getBoundingClientRect();
  const sx=(e.clientX - r.left) * (draw.width/r.width);
  const sy=(e.clientY - r.top)  * (draw.height/r.height);
  return {x:sx, y:sy};
}

draw.addEventListener('pointerdown',(e)=>{
  if(tool==='idle') return;             // –≤–Ω–µ —Ä–µ–∂–∏–º–∞ –ª–∏–Ω–∏–∏ ‚Äî —Ç–æ–ª—å–∫–æ –∫–∞–º–µ—Ä–∞
  e.preventDefault();
  const p=pos(e);
  if(tool==='awaitFirst'){ first=p; preview=null; tool='awaitSecond'; setStatus('1-—è —Ç–æ—á–∫–∞ –µ—Å—Ç—å ‚Äî —Ç–∫–Ω–∏ 2-—é'); redraw(); return; }
  if(tool==='awaitSecond'){ preview=p; segs.push({a:first,b:preview}); first=null; preview=null; tool='idle'; setStatus('–°–µ–≥–º–µ–Ω—Ç –≥–æ—Ç–æ–≤. –î–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –Ω–∞–∂–º–∏ ¬´–õ–∏–Ω–∏—è¬ª.'); redraw(); return; }
},{passive:false});
draw.addEventListener('pointermove',(e)=>{ if(tool==='awaitSecond' && first){ preview=pos(e); redraw(); }},{passive:true});

/* === UI === */
const $=id=>document.getElementById(id);
$('btnPhoto').onclick = ()=> $('fileInput').click();
$('fileInput').onchange = (ev)=>{ const f=ev.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=e=>placePhoto(e.target.result); fr.readAsDataURL(f); };
$('btnErasePhoto').onclick = removePhoto;
$('btnCenter').onclick = centerCam;
$('btnLine').onclick = ()=>{ tool='awaitFirst'; first=null; preview=null; setStatus('–†–µ–∂–∏–º –õ–∏–Ω–∏—è: —Ç–∫–Ω–∏ 1-—é —Ç–æ—á–∫—É'); };
$('btnUndo').onclick = ()=>{
  if(tool==='awaitSecond' && first){ first=null; preview=null; tool='idle'; setStatus('–û—Ç–º–µ–Ω–µ–Ω–æ'); redraw(); return; }
  if(segs.length){ segs.pop(); redraw(); setStatus('–£–¥–∞–ª—ë–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç'); }
};

init3D();
fitAll();
})();
</script>
</body>
</html>