<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace ‚Äî 3D + –§–æ—Ç–æ —Ñ–æ–Ω (–æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º)</title>
<style>
  :root{--bg:#0e0e0f;--panel:#1a1b1f;--btn:#2b2d34;--text:#f5f5f7;--muted:#9aa0a6;--green:#3ddc84}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  #cv{position:fixed;inset:0;display:block;width:100vw;height:100vh;touch-action:none;-webkit-user-select:none;user-select:none;background:#000}
  .bar{position:fixed;left:12px;top:12px;z-index:10;display:flex;gap:10px;flex-wrap:wrap}
  .btn{height:44px;padding:0 14px;border:0;border-radius:12px;background:var(--btn);color:#fff;font-weight:700;box-shadow:0 2px 10px rgba(0,0,0,.25)}
  .btn:active{transform:translateY(1px)}
  .status{position:fixed;left:12px;bottom:12px;background:rgba(0,0,0,.6);color:#9fff9f;padding:6px 10px;border-radius:9px;font-size:12px;z-index:11}
  input[type=file]{display:none}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="bar">
    <button id="btnPhoto" class="btn">üì∑ –§–æ—Ç–æ</button>
    <button id="btnClear" class="btn">üßπ –£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω</button>
    <button id="btnCenter" class="btn">üéØ –¶–µ–Ω—Ç—Ä</button>
    <input id="filePhoto" type="file" accept="image/*" capture="environment">
  </div>

  <div id="status" class="status">–°—Ç–∞—Ç—É—Å: –∑–∞–≥—Ä—É–∂–∞—é 3D‚Ä¶</div>

  <!-- three.js + OrbitControls —Å CDN -->
  <script src="https://unpkg.com/three@0.160.1/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.1/examples/js/controls/OrbitControls.js"></script>

<script>
(()=>{'use strict';

const DPR = Math.min(2, Math.max(1, window.devicePixelRatio || 1));
const cv = document.getElementById('cv');
const statusEl = document.getElementById('status');
const log = (t)=>{ statusEl.textContent = '–°—Ç–∞—Ç—É—Å: ' + t; };

// === three.js –±–∞–∑–æ–≤–∞—è —Å—Ü–µ–Ω–∞ ===
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 5000);
const renderer = new THREE.WebGLRenderer({canvas: cv, antialias: true, alpha: false});
renderer.setPixelRatio(DPR);
renderer.outputColorSpace = THREE.SRGBColorSpace;

const controls = new THREE.OrbitControls(camera, cv);
controls.enableDamping = true;
controls.dampingFactor = 0.06;
controls.target.set(0,0,0);

// —Å–µ—Ç–∫–∞ –∏ –æ—Å–∏
const grid = new THREE.GridHelper(1000, 40, 0x444444, 0x222222);
grid.material.opacity = 0.7; grid.material.transparent = true;
scene.add(grid);
scene.add(new THREE.AxesHelper(200));

// —Å–≤–µ—Ç –ª—ë–≥–∫–∏–π, —á—Ç–æ–±—ã –æ–±—ä–µ–∫—Ç—ã (–µ—Å–ª–∏ –ø–æ—è–≤—è—Ç—Å—è) –Ω–µ –±—ã–ª–∏ —á—ë—Ä–Ω—ã–º–∏
const light = new THREE.HemisphereLight(0xffffff, 0x222233, 0.8);
scene.add(light);

function centerView(){
  camera.position.set(350, 250, 350);
  controls.target.set(0,0,0);
  controls.update();
}
function fit(){
  const w = innerWidth, h = innerHeight;
  renderer.setSize(w, h, false);
  camera.aspect = w / h;
  camera.updateProjectionMatrix();
}
addEventListener('resize', fit, {passive:true});
fit();
centerView();

// === —Ñ–æ–Ω –∏–∑ —Ñ–æ—Ç–æ ===
function setBackgroundFromFile(file){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    const loader = new THREE.TextureLoader();
    loader.load(e.target.result, (tex)=>{
      tex.colorSpace = THREE.SRGBColorSpace;
      tex.minFilter = THREE.LinearFilter;
      scene.background = tex;
      log('–§–æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚úÖ');
    }, undefined, (err)=>{
      log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ–Ω–∞');
      console.error(err);
    });
  };
  reader.readAsDataURL(file);
}

// === UI ===
document.getElementById('btnPhoto').onclick = ()=> document.getElementById('filePhoto').click();
document.getElementById('filePhoto').onchange = (e)=>{
  const f = e.target.files && e.target.files[0];
  if(f) setBackgroundFromFile(f);
  e.target.value = '';
};
document.getElementById('btnClear').onclick = ()=>{ scene.background = null; log('–§–æ–Ω –æ—á–∏—â–µ–Ω'); };
document.getElementById('btnCenter').onclick = ()=>{ centerView(); log('–ö–∞–º–µ—Ä–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É'); };

// === —Ü–∏–∫–ª –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ ===
function tick(){
  controls.update();
  renderer.render(scene, camera);
  requestAnimationFrame(tick);
}
tick();

log('3D –∑–∞–≥—Ä—É–∂–µ–Ω–æ');

})();
</script>
</body>
</html>