<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>IsoPipe ‚Äî –ø–æ —Ñ–æ—Ç–æ, —Å—Ç—ã–∫-–≤-—Å—Ç—ã–∫</title>
<style>
  :root{--violet:#7b2cff;--violet2:#6a1bff;--border:#e7e3f7}
  html,body{margin:0;height:100%;background:#f2f3f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  canvas{display:block;width:100vw;height:100vh;background:#fff;touch-action:none;user-select:none;-webkit-user-select:none}

  .bar{position:fixed;left:0;right:56px;top:0;z-index:1000;padding:8px 8px 0;transition:.2s}
  .bar-scroll{display:flex;gap:10px;overflow-x:auto;padding-bottom:8px;-webkit-overflow-scrolling:touch}
  .bar-scroll::-webkit-scrollbar{display:none}
  .btn{min-width:110px;height:46px;padding:0 14px;border:0;border-radius:12px;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff;font-weight:800;font-size:15px;white-space:nowrap;flex:0 0 auto}
  .btn.ghost{background:linear-gradient(180deg,#8c8c8c,#6a6a6a)}
  .btn.active{filter:brightness(1.08)}
  .gear{position:fixed;top:8px;right:8px;width:46px;height:46px;border-radius:12px;border:1px solid var(--border);background:#fff;color:#5b30c2;font-weight:800;z-index:1001}

  .panel-wrap{position:fixed;inset:0;z-index:1050;display:none}
  .panel-wrap.open{display:block}
  .panel-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.18)}
  .panel{position:absolute;top:68px;right:8px;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:12px;width:min(92vw,380px);max-height:80vh;overflow:auto}
  .panel h4{margin:6px 0 8px;font-size:15px}
  .row{display:flex;align-items:center;gap:10px;margin:10px 0}
  .row label{min-width:170px;font-size:14px;color:#555}
  .row input[type="range"]{flex:1;appearance:none;height:6px;border-radius:999px;background:#eee}
  .row input[type="range"]::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#7b2cff}
  .switch{display:flex;align-items:center;gap:10px}
  .val{width:42px;text-align:right;font-size:12px;color:#666}
  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#1f1f2e;color:#fff;padding:10px 12px;border-radius:12px;opacity:0;transition:.25s;z-index:1100;pointer-events:none}
  .toast.show{opacity:1}
  .crosshair{position:fixed;pointer-events:none;z-index:1002;color:#444;font-size:10px;opacity:.8;transform:translate(-50%,-50%);display:none}
  .crosshair:before,.crosshair:after{content:"";position:absolute;background:currentColor}
  .crosshair:before{width:18px;height:1.5px;left:-9px;top:0}
  .crosshair:after{width:1.5px;height:18px;left:0;top:-9px}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="bar">
    <div class="bar-scroll">
      <button id="btnHand" class="btn ghost">üñê –†—É–∫–∞</button>
      <button id="btnLine" class="btn">üìê –õ–∏–Ω–∏—è</button>
      <button id="btnUndo" class="btn ghost">‚Ü© –ù–∞–∑–∞–¥</button>
      <label class="btn ghost" style="position:relative">üñº –§–æ—Ç–æ/–≥–∞–ª–µ—Ä–µ—è
        <input id="pickImage" type="file" accept="image/*" style="position:absolute;inset:0;opacity:0">
      </label>
      <button id="btnClearImage" class="btn ghost">‚úñ –£–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</button>
    </div>
  </div>

  <button id="btnSettings" class="gear" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öô</button>

  <div id="toast" class="toast"></div>
  <div id="cross" class="crosshair"></div>

  <div id="panelWrap" class="panel-wrap" aria-hidden="true">
    <div id="panelBackdrop" class="panel-backdrop"></div>
    <div id="panel" class="panel" role="dialog" aria-modal="true">
      <h4>–ü—Ä–∏—Ç—è–∂–µ–Ω–∏–µ</h4>
      <div class="row"><label>–°–∏–ª–∞ –º–∞–≥–Ω–∏—Ç–∞ (px)</label><input id="snapTol" type="range" min="4" max="30" value="12"><span id="snapTolVal" class="val">12</span></div>
      <div class="row"><label>–ü—Ä–∏–ª–∏–ø–∞–Ω–∏–µ –∫ –∫–æ–Ω—Ü–∞–º (px)</label><input id="endStick" type="range" min="10" max="60" value="28"><span id="endStickVal" class="val">28</span></div>
      <div class="row switch"><input id="showDots" type="checkbox"><label for="showDots">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ—á–∫–∏</label></div>
      <div class="row"><button id="btnDone" class="btn" style="width:100%;background:linear-gradient(180deg,#16a34a,#15803d)">–ì–æ—Ç–æ–≤–æ</button></div>
    </div>
  </div>

<script>
(function(){
  // ====== –±–∞–∑–æ–≤—ã–µ ======
  const DPR = Math.max(1, window.devicePixelRatio||1);
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d', {alpha:false});
  const $ = id => document.getElementById(id);
  const toast = (t,ms=1200)=>{ const el=$('toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),ms); };

  // —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  let mode='hand';             // hand | line
  const segs=[];
  let firstPt=null, previewPt=null;
  const snap = { tol:12, endStick:28 };
  let showDots=false;

  // —Ñ–æ–Ω-—Ñ–æ—Ç–æ –∏ –∫–∞–º–µ—Ä–∞
  let img=null, iw=0, ih=0;    // –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ "–º–∏—Ä–æ–≤—ã—Ö" –ø–∏–∫—Å–µ–ª—è—Ö
  const view = { scale:1, tx:0, ty:0 }; // —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º —ç–∫—Ä–∞–Ω–∞ -> –º–∏—Ä–∞

  // –∫—É—Ä—Å–æ—Ä-–ø—Ä–∏—Ü–µ–ª
  const cross = $('cross');
  const showCross = (sx,sy)=>{cross.style.display='block';cross.style.left=sx+'px';cross.style.top=sy+'px'};
  const hideCross = ()=>{cross.style.display='none'};

  // —É—Ç–∏–ª–∏—Ç—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
  function fit(){
    cv.width = Math.round(innerWidth*DPR);
    cv.height= Math.round(innerHeight*DPR);
    redraw();
  }
  addEventListener('resize', fit);

  const scr2world = (sx,sy)=>({ x:(sx - view.tx)/view.scale, y:(sy - view.ty)/view.scale });
  const world2scr  = (x,y)=>({ x: x*view.scale + view.tx, y: y*view.scale + view.ty });

  // ====== —Ä–∏—Å–æ–≤–∞–Ω–∏–µ ======
  function redraw(){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,cv.width,cv.height);

    // —Ñ–æ–Ω
    if(img){
      ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);
      ctx.drawImage(img,0,0,iw,ih);
    }else{
      ctx.setTransform(1,0,0,1,0,0);
    }

    // –º–∏—Ä
    ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);

    // –ª–∏–Ω–∏–∏
    ctx.lineCap='round'; ctx.lineJoin='round';
    for(const s of segs){
      ctx.strokeStyle='#5b00bf'; ctx.globalAlpha=.7; ctx.lineWidth=(8/DPR)/view.scale;
      ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();

      ctx.strokeStyle='#7b2cff'; ctx.globalAlpha=1; ctx.lineWidth=(6/DPR)/view.scale;
      ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
    }

    // –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞
    if(firstPt){
      ctx.beginPath(); ctx.fillStyle='#ff3b30'; ctx.arc(firstPt.x,firstPt.y,(7/DPR)/view.scale,0,Math.PI*2); ctx.fill();
    }

    // –ø—Ä–µ–≤—å—é
    if(firstPt && previewPt){
      ctx.setLineDash([12/view.scale,8/view.scale]); ctx.strokeStyle='#16a34a'; ctx.lineWidth=(5/DPR)/view.scale;
      ctx.beginPath(); ctx.moveTo(firstPt.x,firstPt.y); ctx.lineTo(previewPt.x,previewPt.y); ctx.stroke();
      ctx.setLineDash([]);
      ctx.beginPath(); ctx.fillStyle='#16a34a'; ctx.arc(previewPt.x,previewPt.y,(6/DPR)/view.scale,0,Math.PI*2); ctx.fill();
    }

    // —É–∑–ª—ã (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
    if(showDots){
      const r=(5/DPR)/view.scale;
      const dot=p=>{ctx.beginPath();ctx.fillStyle='rgba(123,44,255,.35)';ctx.arc(p.x,p.y,r*1.4,0,Math.PI*2);ctx.fill();
                    ctx.beginPath();ctx.fillStyle='#7b2cff';ctx.arc(p.x,p.y,r,0,Math.PI*2);ctx.fill();}
      for(const s of segs){dot(s.a); dot(s.b);}
    }

    ctx.setTransform(1,0,0,1,0,0);
  }
  let raf=0, dirty=false; function need(){dirty=true; if(!raf){raf=requestAnimationFrame(()=>{raf=0; if(dirty){dirty=false; redraw();}})}}

  // ====== snapping: —Ç–æ–ª—å–∫–æ —Å–µ–≥–º–µ–Ω—Ç –∏ –∫–æ–Ω—Ü—ã ======
  function snapToEnds(p){
    let best=null, bd=Infinity;
    for(const s of segs){
      for(const n of [s.a, s.b]){
        const d=Math.hypot(n.x-p.x, n.y-p.y);
        if(d < bd && d <= snap.endStick){ bd=d; best=n; }
      }
    }
    return best ? {x:best.x, y:best.y, _lock:'end'} : p;
  }
  function snapToSegment(p){
    if(!segs.length) return p;
    let best=null, bd=Infinity;
    for(const s of segs){
      const A=s.a, B=s.b;
      const vx=B.x-A.x, vy=B.y-A.y, L=Math.hypot(vx,vy); if(L<1) continue;
      const nx=vx/L, ny=vy/L;
      const wx=p.x-A.x, wy=p.y-A.y;
      let proj=wx*nx+wy*ny; proj=Math.max(0, Math.min(L, proj)); // —Å—Ç—Ä–æ–≥–æ –≤–Ω—É—Ç—Ä–∏
      const px=A.x+nx*proj, py=A.y+ny*proj;
      const d=Math.hypot(p.x-px, p.y-py);
      if(d < bd && d <= snap.tol){ bd=d; best={x:px,y:py}; }
    }
    return best ? {...best, _lock:'seg'} : p;
  }
  function previewSnap(raw){
    const end = snapToEnds(raw);
    if(end._lock) return end;
    return snapToSegment(raw);
  }
  function finalize(start, rawEnd){
    // —Å–Ω–∞—á–∞–ª–∞ —É–∑–ª—ã, –ø–æ—Ç–æ–º —Å–µ–≥–º–µ–Ω—Ç; –≤ –∫–æ–Ω—Ü–µ –µ—â—ë —Ä–∞–∑ ¬´–∂—ë—Å—Ç–∫–∏–π —Å—Ç—ã–∫¬ª –∫ –±–ª–∏–∂–∞–π—à–µ–º—É –∫–æ–Ω—Ü—É
    let p = snapToEnds(rawEnd); p = snapToSegment(p);
    p = snapToEnds(p);
    return p;
  }

  // ====== –∂–µ—Å—Ç—ã ======
  const pointers = new Map(); let lastPan=null;
  function getPt(e){ const r=cv.getBoundingClientRect(); return { sx:(e.clientX-r.left)*DPR, sy:(e.clientY-r.top)*DPR }; }

  cv.addEventListener('pointerdown', e=>{
    e.preventDefault();
    const pt=getPt(e); pointers.set(e.pointerId, pt);
    if(pointers.size===2) return; // –Ω–∞—á–∏–Ω–∞–µ–º pinch ‚Äî –Ω–µ –º–µ—à–∞–µ–º

    // –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏—Ü–µ–ª
    showCross(pt.sx/DPR, pt.sy/DPR);

    if(mode==='line'){
      const w = scr2world(pt.sx, pt.sy);
      if(!firstPt){ firstPt = w; previewPt=null; need(); return; }
      // —Å—Ç–∞–≤–∏–º –≤—Ç–æ—Ä—É—é —Ç–æ—á–∫—É —Å —Ñ–∏–Ω–∞–ª—å–Ω—ã–º —Å–Ω–∞–ø–æ–º
      const final = finalize(firstPt, w);
      segs.push({a:firstPt, b:final});
      firstPt=null; previewPt=null; need();
    }
  }, {passive:false});

  cv.addEventListener('pointermove', e=>{
    if(!pointers.has(e.pointerId)) return;
    const pt=getPt(e); pointers.set(e.pointerId, pt);

    // –ø—Ä–∏—Ü–µ–ª
    showCross(pt.sx/DPR, pt.sy/DPR);

    if(pointers.size===2){
      // pinch-zoom
      const [p0,p1]=[...pointers.values()];
      const d = (p)=>Math.hypot(p.sx, p.sy);
      if(!p0.prev||!p1.prev){ p0.prev={...p0}; p1.prev={...p1}; return; }
      const d0=Math.hypot(p0.prev.sx-p1.prev.sx,p0.prev.sy-p1.prev.sy);
      const d1=Math.hypot(p0.sx-p1.sx,p0.sy-p1.sy);
      if(d0>0){
        const k=d1/d0;
        const cx=(p0.sx+p1.sx)/2, cy=(p0.sy+p1.sy)/2;
        view.tx = cx - k*(cx - view.tx);
        view.ty = cy - k*(cy - view.ty);
        view.scale *= k;
        need();
      }
      p0.prev={...p0}; p1.prev={...p1};
      return;
    }

    if(mode==='hand'){
      // –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–∏–º –ø–∞–ª—å—Ü–µ–º
      if(!lastPan) lastPan={x:pt.sx,y:pt.sy};
      const dx=pt.sx-lastPan.x, dy=pt.sy-lastPan.y;
      view.tx += dx; view.ty += dy;
      lastPan={x:pt.sx,y:pt.sy};
      need();
    }

    if(mode==='line' && firstPt){
      // –ø—Ä–µ–≤—å—é —Å –ø—Ä–∏–≤—è–∑–∫–æ–π
      const raw = scr2world(pt.sx, pt.sy);
      previewPt = previewSnap(raw);
      need();
    }
  }, {passive:false});

  cv.addEventListener('pointerup', e=>{
    pointers.delete(e.pointerId);
    lastPan=null;
    if(pointers.size===0) hideCross();
  });

  cv.addEventListener('pointercancel', e=>{
    pointers.delete(e.pointerId);
    lastPan=null; if(pointers.size===0) hideCross();
  });

  // ====== –∫–Ω–æ–ø–∫–∏ ======
  function setActive(id){ ['btnHand','btnLine'].forEach(b=>$(b).classList.toggle('active', b===id)); }
  $('btnHand').onclick=()=>{ mode='hand'; firstPt=null; previewPt=null; setActive('btnHand'); toast('–†—É–∫–∞: –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –¥–≤–∞ –ø–∞–ª—å—Ü–∞ ‚Äî –º–∞—Å—à—Ç–∞–±'); };
  $('btnLine').onclick=()=>{ mode='line'; firstPt=null; previewPt=null; setActive('btnLine'); toast('–õ–∏–Ω–∏—è: –ø–æ—Å—Ç–∞–≤—å 2 —Ç–æ—á–∫–∏'); };
  $('btnUndo').onclick=()=>{ if(firstPt){firstPt=null; previewPt=null;} else segs.pop(); need(); };
  $('btnClearImage').onclick=()=>{ img=null; iw=ih=0; need(); };

  // —Ñ–æ—Ç–æ
  $('pickImage').onchange = e=>{
    const file=e.target.files?.[0]; if(!file) return;
    const loader=new Image(); loader.onload=()=>{
      // –¥–µ–ª–∞–µ–º bitmap —Ç–æ–≥–æ –∂–µ —Ä–∞–∑–º–µ—Ä–∞ ‚Äî –≤ "–º–∏—Ä–æ–≤—ã—Ö" –ø–∏–∫—Å–µ–ª—è—Ö —Ñ–æ—Ç–æ
      const c=document.createElement('canvas'); c.width=loader.naturalWidth; c.height=loader.naturalHeight;
      c.getContext('2d',{alpha:false}).drawImage(loader,0,0);
      img=c; iw=c.width; ih=c.height;
      // —Ñ–∏—Ç–æ–º –ø–æ —ç–∫—Ä–∞–Ω—É
      const k=Math.min(cv.width/iw, cv.height/ih);
      view.scale=k; view.tx=(cv.width - iw*k)/2; view.ty=(cv.height - ih*k)/2;
      need();
    };
    loader.src=URL.createObjectURL(file);
  };

  // –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  const wrap=$('panelWrap'), panel=$('panel'), back=$('panelBackdrop');
  const openPanel=()=>{wrap.classList.add('open'); wrap.setAttribute('aria-hidden','false');};
  const closePanel=()=>{wrap.classList.remove('open'); wrap.setAttribute('aria-hidden','true');};
  $('btnSettings').onclick=openPanel; $('btnDone').onclick=closePanel; back.onclick=closePanel;

  $('snapTol').oninput = e=>{ snap.tol=+e.target.value; $('snapTolVal').textContent=e.target.value; };
  $('endStick').oninput = e=>{ snap.endStick=+e.target.value; $('endStickVal').textContent=e.target.value; };
  $('showDots').onchange= e=>{ showDots=!!e.target.checked; need(); };

  // —Å—Ç–∞—Ä—Ç
  fit();
  setActive('btnHand');
  toast('üñê –†—É–∫–∞: –ø–∞–Ω–æ—Ä–∞–º–∏—Ä—É–π; üìê –õ–∏–Ω–∏—è: —Å—Ç–∞–≤—å 2 —Ç–æ—á–∫–∏. –î–≤–∞ –ø–∞–ª—å—Ü–∞ ‚Äî –º–∞—Å—à—Ç–∞–±.');
})();
</script>
</body>
</html>