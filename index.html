<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace — Маска (передний план) + фуллскрин-фикс</title>
<style>
  :root{--violet:#8000ff; --violet2:#7618ff}
  html,body{margin:0;height:100%;background:#f2f3f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  canvas{display:block;width:100vw;height:100vh;background:#fff;touch-action:none;user-select:none;-webkit-user-select:none}

  .hud{position:fixed;top:8px;left:8px;right:8px;z-index:1000;display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px;transition:.2s ease opacity}
  .hud.hidden{opacity:0;pointer-events:none}
  .hud button{height:40px;border:0;border-radius:12px;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff;font-weight:800}
  .hud .wide{grid-column:span 2}

  .mini{position:fixed;top:8px;right:8px;z-index:1001;display:flex;gap:8px}
  .mini.hidden{display:none}
  .mini button{height:40px;border:0;border-radius:12px;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff;font-weight:800;padding:0 14px}

  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#1f1f2e;color:#fff;padding:8px 10px;border-radius:10px;opacity:0;transition:.25s;z-index:1100}
  .toast.show{opacity:1}

  .panel-wrap{position:fixed;inset:0;z-index:1050;display:none}
  .panel-wrap.open{display:block}
  .panel-backdrop{position:absolute;inset:0;background:transparent}
  .panel{position:absolute;top:96px;right:8px;background:#fff;border:1px solid #e7e3f7;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:12px;width:min(92vw,360px)}
  .panel h4{margin:0 0 8px 0;font-size:15px}
  .row{display:flex;align-items:center;gap:8px;margin:8px 0}
  .row label{min-width:150px;font-size:13px;color:#555}
  .row input[type="range"]{flex:1;appearance:none;height:6px;border-radius:999px;background:#eee}
  .row input[type="range"]::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:var(--violet)}
  .switch{display:flex;align-items:center;gap:8px}
  .close{position:absolute;top:6px;right:8px;line-height:1;border:none;background:transparent;font-size:20px;color:#666}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1200}
  .modal.show{display:flex}
  .modal .bg{position:absolute;inset:0;background:rgba(0,0,0,.25)}
  .modal .card{position:relative;min-width:280px;max-width:90vw;background:#fff;border:1px solid #e7e3f7;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:14px}
  .modal h4{margin:0 0 10px 0}
  .modal input{width:100%;padding:10px;border:1px solid #d8c9ff;border-radius:10px;margin-bottom:10px;font-size:16px}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end}
  .modal .actions button{height:38px;border:0;border-radius:10px;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff;font-weight:700;padding:0 14px}
  .modal .actions .ghost{background:#fff;color:#5c30b5;border:1px solid #d8c9ff}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <!-- HUD, miniHUD, inputs, панели и модалки оставил как у тебя -->

<script>
(function(){
  const DPR = Math.min(1.5, Math.max(1, (window.devicePixelRatio||1)));

  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d', { alpha:false });

  // ===== исправленная функция получения координат =====
  function getCanvasPoint(e){
    const r = cv.getBoundingClientRect();
    const sx = (e.clientX - r.left) * (cv.width / r.width);
    const sy = (e.clientY - r.top)  * (cv.height / r.height);
    return {sx, sy};
  }

  // Пример использования:
  cv.addEventListener('pointerdown', e=>{
    const {sx,sy} = getCanvasPoint(e);
    console.log('точка:', sx, sy); // дальше используем sx,sy вместо clientX*DPR
  });

  // ====== Остальной твой код (рисование, снапы, маска и т.п.) сюда без изменений ======

})();
</script>
</body>
</html>