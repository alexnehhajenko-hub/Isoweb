<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace ‚Äî v877 line-only</title>
<style>
  :root{--violet:#6b1dff; --violet2:#7c5bff; --border:#e7e3f7}
  html,body{margin:0;height:100%;background:#f2f3f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  #cv{position:fixed;inset:0;display:block;width:100vw;height:100vh;background:#fff;touch-action:none;-webkit-user-select:none;user-select:none}

  .bar{position:fixed;left:8px;top:8px;z-index:10;display:flex;gap:8px;flex-wrap:wrap}
  .btn{height:44px;padding:0 14px;border:0;border-radius:12px;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff;font-weight:800}
  .btn.ghost{background:linear-gradient(180deg,#8c8c8c,#6a6a6a)}

  .zoom{position:fixed;right:8px;top:8px;z-index:11;display:flex;gap:8px}
  .zbtn{height:44px;min-width:44px;border:0;border-radius:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);font-size:18px}

  .gear{position:fixed;right:8px;top:64px;z-index:12;height:44px;width:44px;border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);font-size:20px}
  .status{position:fixed;left:8px;bottom:8px;background:rgba(0,0,0,.70);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;z-index:11;max-width:92vw}

  .panel-wrap{position:fixed;inset:0;z-index:20;display:none}
  .panel-wrap.open{display:block}
  .panel-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.18)}
  .panel{position:absolute;top:64px;right:8px;background:#fff;border:1px solid var(--border);
         border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:12px;width:min(92vw,380px);
         max-height:80vh;overflow:auto}
  .panel h4{margin:6px 0 8px;font-size:15px}
  .row{display:flex;align-items:center;gap:10px;margin:10px 0}
  .row label{min-width:140px;font-size:13px;color:#444}
  .close{position:sticky;top:0;margin:-6px -6px 6px auto;background:#fff;border:1px solid var(--border);width:32px;height:32px;border-radius:8px}
  input[type=range]{width:100%}
  .num{font-variant-numeric:tabular-nums;color:#111;font-weight:700}
  .radio-row{display:flex;gap:10px;flex-wrap:wrap}
  .radio{display:flex;align-items:center;gap:6px;border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:12px;color:#333}
  .radio input{accent-color:#6b1dff}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="bar">
    <button id="btnLine"  class="btn">üìê –õ–∏–Ω–∏—è</button>
    <button id="btnUndo"  class="btn ghost">‚Ü© –ù–∞–∑–∞–¥</button>
  </div>

  <div class="zoom">
    <button id="btnMinus" class="zbtn" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
    <button id="btnPlus"  class="zbtn" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
  </div>

  <button id="btnSettings" class="gear" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öô</button>

  <div id="panelWrap" class="panel-wrap" aria-hidden="true">
    <div id="panelBackdrop" class="panel-backdrop"></div>
    <div id="panel" class="panel" role="dialog" aria-modal="true">
      <button id="btnClosePanel" class="close" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>

      <h4>–ß–µ—Ä—Ç—ë–∂</h4>
      <div class="row">
        <label for="rangeLine">–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏</label>
        <input id="rangeLine" type="range" min="2" max="56" step="1">
        <span id="lineVal" class="num">10</span>
      </div>

      <div class="row">
        <label for="rangeComp">–ê—Ä–º–∞—Ç—É—Ä–∞ √ó</label>
        <input id="rangeComp" type="range" min="0.5" max="3.0" step="0.01">
        <span id="compVal" class="num">1.15</span>
      </div>

      <div class="row" style="margin-top:8px">
        <label>–¢–∏–ø –∞—Ä–º–∞—Ç—É—Ä—ã</label>
        <div class="radio-row">
          <label class="radio"><input type="radio" name="comp" value="valve" checked> –ö—Ä–∞–Ω</label>
          <label class="radio"><input type="radio" name="comp" value="check"> –ö–ª–∞–ø–∞–Ω</label>
          <label class="radio"><input type="radio" name="comp" value="pump"> –ù–∞—Å–æ—Å</label>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="btnPlaceComp" class="btn">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Ç—Ä—É–±—É</button>
      </div>
    </div>
  </div>

  <div id="status" class="status">–°—Ç–∞—Ç—É—Å: –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

<script>
(()=>{"use strict";
/* –±–∞–∑–æ–≤—ã–µ */
const DPR=Math.min(1.5,Math.max(1,window.devicePixelRatio||1));
const cv=document.getElementById('cv');const ctx=cv.getContext('2d',{alpha:false});
const statusEl=document.getElementById('status');
const view={tx:0,ty:0,scale:1};function fit(){cv.width=Math.round(innerWidth*DPR);cv.height=Math.round(innerHeight*DPR);need();}addEventListener('resize',fit,{passive:true});
const segs=[],comps=[],stack=[];let tool='idle';let first=null,preview=null;let currentComp='valve';
const params={linePx:10,lineColor:'#1f6bff',compScale:1.15};

/* —É—Ç–∏–ª–∏—Ç—ã */
function s2w(sx,sy){return{x:(sx-view.tx)/view.scale,y:(sy-view.ty)/view.scale};}
function w2s(x,y){return{x:x*view.scale+view.tx,y:y*view.scale+view.ty};}
function darker(hex,k=0.45){const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);if(!m)return'#333';let[r,g,b]=[parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16)];r=Math.max(0,Math.floor(r*(1-k)));g=Math.max(0,Math.floor(g*(1-k)));b=Math.max(0,Math.floor(b*(1-k)));return'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');}
function segGeom(seg){const vx=seg.b.x-seg.a.x,vy=seg.b.y-seg.a.y;const L=Math.hypot(vx,vy)||1;return{vx,vy,L,nx:vx/L,ny:vy/L};}
function compBasis(seg,t){const g=segGeom(seg);return{x:seg.a.x+g.nx*g.L*t,y:seg.a.y+g.ny*g.L*t,ux:g.nx,uy:g.ny,nx:-g.ny,ny:g.nx};}
function updateStatus(m=''){const t=tool==='awaitFirst'?'–ñ–¥—É 1-—é —Ç–æ—á–∫—É':tool==='awaitSecond'?'–ñ–¥—É 2-—é —Ç–æ—á–∫—É':tool==='placeComp'?'–ê—Ä–º–∞—Ç—É—Ä–∞':'–ì–æ—Ç–æ–≤';statusEl.textContent=`–°—Ç–∞—Ç—É—Å: ${m} | ${t}`;}

/* —Ä–∏—Å–æ–≤–∞–Ω–∏–µ */
function drawSegments(){ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);const col=params.lineColor,sh=darker(col,0.45);for(const s of segs){ctx.strokeStyle=sh;ctx.globalAlpha=.75;ctx.lineWidth=(params.linePx+2)/view.scale;ctx.beginPath();ctx.moveTo(s.a.x,s.a.y);ctx.lineTo(s.b.x,s.b.y);ctx.stroke();ctx.strokeStyle=col;ctx.globalAlpha=1;ctx.lineWidth=params.linePx/view.scale;ctx.beginPath();ctx.moveTo(s.a.x,s.a.y);ctx.lineTo(s.b.x,s.b.y);ctx.stroke();}}
function draw(){ctx.setTransform(1,0,0,1,0,0);ctx.fillStyle='#fff';ctx.fillRect(0,0,cv.width,cv.height);drawSegments();for(const c of comps){/* –∞—Ä–º–∞—Ç—É—Ä–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ */}if(tool==='awaitSecond'&&first&&preview){ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);ctx.strokeStyle=params.lineColor;ctx.lineWidth=params.linePx/view.scale;ctx.beginPath();ctx.moveTo(first.x,first.y);ctx.lineTo(preview.x,preview.y);ctx.stroke();}if(first){const p=w2s(first.x,first.y);ctx.setTransform(1,0,0,1,0,0);ctx.fillStyle='red';ctx.beginPath();ctx.arc(p.x,p.y,6,0,Math.PI*2);ctx.fill();}}let raf=0,dirty=false;function need(){dirty=true;if(!raf){raf=requestAnimationFrame(()=>{raf=0;if(dirty){dirty=false;draw();}});}}

/* –≤–≤–æ–¥ */
cv.addEventListener('pointerdown',e=>{const r=cv.getBoundingClientRect();const sx=(e.clientX-r.left)*(cv.width/r.width),sy=(e.clientY-r.top)*(cv.height/r.height);if(tool==='awaitFirst'){first=s2w(sx,sy);preview=null;tool='awaitSecond';updateStatus('1-—è —Ç–æ—á–∫–∞');need();return;}if(tool==='awaitSecond'){preview=s2w(sx,sy);segs.push({a:first,b:preview});stack.push('seg');first=null;preview=null;tool='idle';updateStatus('–õ–∏–Ω–∏—è –≥–æ—Ç–æ–≤–∞. –ù–∞–∂–º–∏ ¬´–õ–∏–Ω–∏—è¬ª –¥–ª—è –Ω–æ–≤–æ–π.');need();return;}if(tool==='placeComp'){/* –ø–æ–∏—Å–∫ —Å–µ–≥–º–µ–Ω—Ç–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞—Ä–º–∞—Ç—É—Ä—ã */tool='idle';updateStatus('–ê—Ä–º–∞—Ç—É—Ä–∞ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞');need();return;}},{passive:false});
cv.addEventListener('pointermove',e=>{if(tool==='awaitSecond'&&first){const r=cv.getBoundingClientRect();const sx=(e.clientX-r.left)*(cv.width/r.width),sy=(e.clientY-r.top)*(cv.height/r.height);preview=s2w(sx,sy);need();}},{passive:true});

/* –∫–Ω–æ–ø–∫–∏ */
const $=id=>document.getElementById(id);
$('btnLine').onclick=()=>{tool='awaitFirst';first=null;preview=null;updateStatus('–†–µ–∂–∏–º –õ–∏–Ω–∏—è: —Ç–∫–Ω–∏ 1-—é —Ç–æ—á–∫—É');};
$('btnUndo').onclick=()=>{if(tool==='awaitSecond'&&first){first=null;preview=null;tool='idle';need();updateStatus('–û—Ç–º–µ–Ω–µ–Ω–æ');return;}const last=stack.pop();if(!last){updateStatus('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å');return;}if(last==='seg'&&segs.length)segs.pop();need();updateStatus('–û—Ç–º–µ–Ω–µ–Ω–æ');};
function zoomAt(f){const cx=cv.width/2,cy=cv.height/2;const ns=clampScale(view.scale*f);view.tx=cx-(cx-view.tx)*(ns/view.scale);view.ty=cy-(cy-view.ty)*(ns/view.scale);view.scale=ns;need();}
$('btnPlus').onclick=()=>zoomAt(1.1);
$('btnMinus').onclick=()=>zoomAt(1/1.1);

fit();need();updateStatus('–ì–æ—Ç–æ–≤–æ (v877): 1) –õ–∏–Ω–∏—è, 2) –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞, 3) –≤—Ç–æ—Ä–∞—è —Ç–æ—á–∫–∞ ‚Üí –ª–∏–Ω–∏—è. –î–ª—è –Ω–æ–≤–æ–π –ª–∏–Ω–∏–∏ —Å–Ω–æ–≤–∞ ¬´–õ–∏–Ω–∏—è¬ª.');
})();
</script>
</body>
</html>