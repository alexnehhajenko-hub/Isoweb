<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pro Trace ‚Äî v865 tap-to-draw (fix)</title>
<style>
  :root{--violet:#6b1dff; --violet2:#7c5bff; --border:#e7e3f7}
  html,body{margin:0;height:100%;background:#f2f3f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  #cv{position:fixed;inset:0;display:block;width:100vw;height:100vh;background:#fff;touch-action:none;-webkit-user-select:none;user-select:none}

  .bar{position:fixed;left:8px;top:8px;z-index:10;display:flex;gap:8px;flex-wrap:wrap}
  .btn{height:44px;padding:0 14px;border:0;border-radius:12px;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff;font-weight:800}
  .btn.ghost{background:linear-gradient(180deg,#8c8c8c,#6a6a6a)}

  .zoom{position:fixed;right:8px;top:8px;z-index:11;display:flex;gap:8px}
  .zbtn{height:44px;min-width:44px;border:0;border-radius:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);font-size:18px}

  .gear{position:fixed;right:8px;top:64px;z-index:12;height:44px;width:44px;border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);font-size:20px}
  .status{position:fixed;left:8px;bottom:8px;background:rgba(0,0,0,.70);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;z-index:11;max-width:92vw}

  .panel-wrap{position:fixed;inset:0;z-index:20;display:none}
  .panel-wrap.open{display:block}
  .panel-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.18)}
  .panel{position:absolute;top:64px;right:8px;background:#fff;border:1px solid var(--border);
         border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:12px;width:min(92vw,380px);
         max-height:80vh;overflow:auto}
  .panel h4{margin:6px 0 8px;font-size:15px}
  .row{display:flex;align-items:center;gap:10px;margin:10px 0}
  .row label{min-width:140px;font-size:13px;color:#444}
  .close{position:sticky;top:0;margin:-6px -6px 6px auto;background:#fff;border:1px solid var(--border);width:32px;height:32px;border-radius:8px}
  input[type=range]{width:100%}
  .num{font-variant-numeric:tabular-nums;color:#111;font-weight:700}
  .upl{position:relative;min-width:120px;display:inline-flex;justify-content:center}
  .upl input{position:absolute;inset:0;opacity:0}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="bar">
    <button id="btnLine"  class="btn">üìê –õ–∏–Ω–∏—è</button>
    <button id="btnUndo"  class="btn ghost">‚Ü© –ù–∞–∑–∞–¥</button>
    <button id="btnHand"  class="btn ghost">üñê –†—É–∫–∞</button>
  </div>

  <div class="zoom">
    <button id="btnMinus" class="zbtn" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
    <button id="btnPlus"  class="zbtn" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
  </div>

  <button id="btnSettings" class="gear" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öô</button>

  <div id="panelWrap" class="panel-wrap" aria-hidden="true">
    <div id="panelBackdrop" class="panel-backdrop"></div>
    <div id="panel" class="panel" role="dialog" aria-modal="true">
      <button id="btnClosePanel" class="close" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>

      <h4>–§–æ—Ç–æ (—Ñ–æ–Ω)</h4>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <label class="btn ghost upl">üì∑ –ö–∞–º–µ—Ä–∞
          <input id="fileCam" type="file" accept="image/*" capture="environment">
        </label>
        <label class="btn ghost upl">üìÇ –ì–∞–ª–µ—Ä–µ—è
          <input id="fileGal" type="file" accept="image/*">
        </label>
        <button id="btnClearBg" class="btn ghost" style="margin-left:auto">üßπ –£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω</button>
      </div>

      <h4>–ß–µ—Ä—Ç—ë–∂</h4>
      <div class="row">
        <label for="rangeLine">–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏</label>
        <input id="rangeLine" type="range" min="2" max="56" step="1">
        <span id="lineVal" class="num">10</span>
      </div>

      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn ghost" disabled title="–°–∫–æ—Ä–æ">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Ç—Ä—É–±—É</button>
      </div>
    </div>
  </div>

  <div id="status" class="status">–°—Ç–∞—Ç—É—Å: –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

<script>
(()=>{"use strict";

/* ===== –±–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===== */
const DPR = Math.min(1.5, Math.max(1, window.devicePixelRatio||1)); // –±—ã—Å—Ç—Ä–µ–µ –Ω–∞ iPhone
const MAX_SIDE = 1600; // —É–∂–∏–º–∞–µ–º –æ–≥—Ä–æ–º–Ω—ã–µ —Ñ–æ—Ç–æ

const cv=document.getElementById('cv');
const ctx=cv.getContext('2d',{alpha:false});
const statusEl=document.getElementById('status');
window.addEventListener('error', e=>{ statusEl.textContent='–°—Ç–∞—Ç—É—Å: –û—à–∏–±–∫–∞ ‚Äî '+(e.message||'unknown'); });

/* ===== –∫–∞–º–µ—Ä–∞/–≤–∏–¥ ===== */
const view={tx:0,ty:0,scale:1};
const clampScale=s=>Math.max(0.25,Math.min(6,s));
function fit(){ cv.width=Math.round(innerWidth*DPR); cv.height=Math.round(innerHeight*DPR); if(bg && view.scale===1 && view.tx===0 && view.ty===0) fitToScreen(); need(); }
addEventListener('resize',fit,{passive:true});
function fitToScreen(){ if(!bg) return; const k=Math.min(cv.width/bw, cv.height/bh); view.scale=k; view.tx=(cv.width-bw*k)/2; view.ty=(cv.height-bh*k)/2; }

/* ===== —Ñ–æ–Ω ===== */
let bg=null,bw=0,bh=0;
function loadImageFile(f){
  if(!f) return;
  const img=new Image();
  img.onload=()=>{
    const maxSide=Math.max(img.naturalWidth,img.naturalHeight);
    let w=img.naturalWidth,h=img.naturalHeight;
    if(maxSide>MAX_SIDE){ const sc=MAX_SIDE/maxSide; w=Math.round(w*sc); h=Math.round(h*sc); }
    const c=document.createElement('canvas'); c.width=w; c.height=h;
    c.getContext('2d',{alpha:false}).drawImage(img,0,0,w,h);
    bg=c; bw=w; bh=h; fitToScreen(); need(); updateStatus('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
  };
  img.src=URL.createObjectURL(f);
}
document.getElementById('fileCam').onchange=e=>loadImageFile(e.target.files?.[0]);
document.getElementById('fileGal').onchange=e=>loadImageFile(e.target.files?.[0]);
document.getElementById('btnClearBg').onclick=()=>{ bg=null; need(); updateStatus('–§–æ–Ω —É–¥–∞–ª—ë–Ω'); };

/* ===== —Å—Ü–µ–Ω–∞ ===== */
const segs=[];      // {a:{x,y}, b:{x,y}}
const stack=[];     // 'seg'
let tool='idle';    // 'idle' | 'awaitFirst' | 'awaitSecond'
let mode='hand';    // 'hand' | 'line'
let first=null;     // –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞ (–º–∏—Ä)
let preview=null;   // –ø–æ–¥—Å–∫–∞–∑–∫–∞ –≤—Ç–æ—Ä–æ–π —Ç–æ—á–∫–∏ (–º–∏—Ä)

const params={ linePx:10, lineColor:'#1f6bff' };
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
function updateStatus(extra=''){
  const map={idle:'–ì–æ—Ç–æ–≤',awaitFirst:'–û–∂–∏–¥–∞–Ω–∏–µ 1-–π —Ç–æ—á–∫–∏',awaitSecond:'–û–∂–∏–¥–∞–Ω–∏–µ 2-–π —Ç–æ—á–∫–∏'};
  statusEl.textContent=`–°—Ç–∞—Ç—É—Å: ${extra} | ${map[tool]} | –õ–∏–Ω–∏—è ${params.linePx}px`;
}

/* ===== —É—Ç–∏–ª–∏—Ç—ã ===== */
function s2w(sx,sy){ return { x:(sx-view.tx)/view.scale, y:(sy-view.ty)/view.scale }; }
function w2s(x,y){ return { x:x*view.scale+view.tx, y:y*view.scale+view.ty }; }
function darker(hex,k=0.45){ const m=/^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex); if(!m) return '#333'; let [r,g,b]=[parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16)]; r=Math.max(0,Math.floor(r*(1-k))); g=Math.max(0,Math.floor(g*(1-k))); b=Math.max(0,Math.floor(b*(1-k))); return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join(''); }

/* ===== –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ ===== */
function drawSegments(){
  ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);
  const col=params.lineColor, sh=darker(col,0.45);
  for(const s of segs){
    ctx.strokeStyle=sh; ctx.globalAlpha=.75; ctx.lineWidth=(params.linePx+2)/view.scale;
    ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
    ctx.strokeStyle=col; ctx.globalAlpha=1; ctx.lineWidth=params.linePx/view.scale;
    ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
  }
}

function draw(){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,cv.width,cv.height);
  if(bg){ ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty); ctx.drawImage(bg,0,0,bw,bh); }
  drawSegments();
  // –º–∞—Ä–∫–µ—Ä 1-–π —Ç–æ—á–∫–∏
  if(first){
    const p=w2s(first.x,first.y);
    ctx.setTransform(1,0,0,1,0,0);
    ctx.beginPath(); ctx.arc(p.x,p.y,5,0,Math.PI*2); ctx.fillStyle='#111'; ctx.fill();
  }
  // –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä 2-–π —Ç–æ—á–∫–∏
  if(tool==='awaitSecond'&&first&&preview){
    ctx.setTransform(view.scale,0,0,view.scale,view.tx,view.ty);
    ctx.setLineDash([]); // —Å–ø–ª–æ—à–Ω–∞—è ‚Äî –±—ã—Å—Ç—Ä–µ–µ
    ctx.strokeStyle=params.lineColor; ctx.lineWidth=Math.max(3,params.linePx-2)/view.scale;
    ctx.beginPath(); ctx.moveTo(first.x,first.y); ctx.lineTo(preview.x,preview.y); ctx.stroke();
  }
}
let raf=0, dirty=false; function need(){ dirty=true; if(!raf){ raf=requestAnimationFrame(()=>{ raf=0; if(dirty){ dirty=false; draw(); } }); } }

/* ===== –≤–≤–æ–¥: ¬´—Ç–∞–ø-—Ç–∞–ø¬ª ===== */
const pointers=new Map();
let isPanning=false, panLast=null;
let prevCenter=null, prevDist=null;

function canvasXY(e){ const r=cv.getBoundingClientRect(); return { sx:(e.clientX-r.left)*(cv.width/r.width), sy:(e.clientY-r.top)*(cv.height/r.height) }; }
function centroid(){ const a=[...pointers.values()]; if(!a.length) return null; let sx=0,sy=0; for(const p of a){ sx+=p.sx; sy+=p.sy; } return {sx:sx/a.length, sy:sy/a.length}; }
function dist2(a,b){ return Math.abs(a.sx-b.sx)+Math.abs(a.sy-b.sy); }

cv.addEventListener('pointerdown', e=>{
  const {sx,sy}=canvasXY(e); pointers.set(e.pointerId,{sx,sy});
  if(pointers.size===2){ const [p0,p1]=[...pointers.values()]; prevCenter=centroid(); prevDist=dist2(p0,p1); return; }

  if(mode==='hand'){ isPanning=true; panLast={sx,sy}; updateStatus('–ü–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ'); return; }

  if(tool==='awaitFirst'){
    e.preventDefault();
    first=s2w(sx,sy); preview=null; tool='awaitSecond'; updateStatus('1-—è —Ç–æ—á–∫–∞ –µ—Å—Ç—å, —Ç–∫–Ω–∏ 2-—é'); need(); return;
  }

  if(tool==='awaitSecond'){
    e.preventDefault();
    preview=s2w(sx,sy);
    if(first && (first.x!==preview.x || first.y!==preview.y)){
      segs.push({a:first,b:preview}); stack.push('seg'); updateStatus('–°–µ–≥–º–µ–Ω—Ç –≥–æ—Ç–æ–≤');
    } else { updateStatus('–¢–æ—á–∫–∏ —Å–æ–≤–ø–∞–ª–∏ ‚Äî —Å–µ–≥–º–µ–Ω—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω'); }
    first=null; preview=null; tool='idle'; mode='hand'; need(); return;
  }
},{passive:false});

cv.addEventListener('pointermove', e=>{
  if(!pointers.has(e.pointerId)) return; const {sx,sy}=canvasXY(e); pointers.set(e.pointerId,{sx,sy});

  if(pointers.size===2){
    const nowC=centroid(); const [p0,p1]=[...pointers.values()]; const nowD=dist2(p0,p1);
    if(prevCenter && prevDist){
      const k = nowD>0 && prevDist>0 ? (nowD/prevDist) : 1;
      const ns=clampScale(view.scale*k);
      const cx=nowC.sx, cy=nowC.sy;
      view.tx = cx - (cx - view.tx)*(ns/view.scale);
      view.ty = cy - (cy - view.ty)*(ns/view.scale);
      view.scale = ns; need();
    }
    prevCenter=nowC; prevDist=nowD; return;
  }

  if(isPanning && panLast){
    view.tx += (sx - panLast.sx);
    view.ty += (sy - panLast.sy);
    panLast={sx,sy}; need(); return;
  }

  if(tool==='awaitSecond' && first){ preview=s2w(sx,sy); need(); }
},{passive:true});

cv.addEventListener('pointerup', e=>{
  pointers.delete(e.pointerId);
  if(pointers.size<2){ prevCenter=null; prevDist=null; }
  if(isPanning && pointers.size===0){ isPanning=false; panLast=null; }
},{passive:true});

/* ===== –∫–Ω–æ–ø–∫–∏ ===== */
const $=id=>document.getElementById(id);
$('btnLine').onclick =()=>{ tool='awaitFirst'; mode='line'; first=null; preview=null; updateStatus('–†–µ–∂–∏–º –õ–∏–Ω–∏—è: —Ç–∫–Ω–∏ 1-—é —Ç–æ—á–∫—É'); };
$('btnHand').onclick =()=>{ tool='idle'; mode='hand'; first=null; preview=null; updateStatus('–†–µ–∂–∏–º –†—É–∫–∞'); };
$('btnUndo').onclick =()=>{
  if(tool==='awaitSecond'&&first){ first=null; preview=null; tool='idle'; mode='hand'; need(); updateStatus('–°–µ–≥–º–µ–Ω—Ç –æ—Ç–º–µ–Ω—ë–Ω'); return; }
  const last=stack.pop(); if(!last){ updateStatus('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å'); return; }
  if(last==='seg'&&segs.length) segs.pop(); need(); updateStatus('–û—Ç–º–µ–Ω–µ–Ω–æ');
};
function zoomAt(f){ const cx=cv.width/2,cy=cv.height/2; const ns=clampScale(view.scale*f); view.tx=cx-(cx-view.tx)*(ns/view.scale); view.ty=cy-(cy-view.ty)*(ns/view.scale); view.scale=ns; need(); }
$('btnPlus').onclick =()=>zoomAt(1.2);
$('btnMinus').onclick=()=>zoomAt(1/1.2);

/* ===== –ü–∞–Ω–µ–ª—å ===== */
const wrap=$('panelWrap'), backdrop=document.getElementById('panelBackdrop'), panel=document.getElementById('panel');
const btnSettings=$('btnSettings'), btnClose=document.getElementById('btnClosePanel');
const rangeLine=document.getElementById('rangeLine'), lineVal=document.getElementById('lineVal');
function openPanel(){ wrap.classList.add('open'); wrap.setAttribute('aria-hidden','false'); }
function closePanel(){ wrap.classList.remove('open'); wrap.setAttribute('aria-hidden','true'); }
btnSettings.onclick=openPanel; btnClose.onclick=closePanel; backdrop.onclick=closePanel;
['pointerdown','pointermove','pointerup','click','wheel'].forEach(ev=>panel.addEventListener(ev, e=>e.stopPropagation(), {passive:true}));

rangeLine.value=params.linePx; lineVal.textContent=params.linePx.toString();
rangeLine.oninput=()=>{ params.linePx=clamp(parseInt(rangeLine.value,10)||10,2,56); lineVal.textContent=params.linePx; need(); updateStatus('–¢–æ–ª—â–∏–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞'); };

/* ===== —Å—Ç–∞—Ä—Ç ===== */
fit(); need();
mode='hand'; tool='idle';
updateStatus('–ì–æ—Ç–æ–≤–æ (v865): –ù–∞–∂–º–∏ ¬´–õ–∏–Ω–∏—è¬ª ‚Üí —Ç–∞–ø 1-—è —Ç–æ—á–∫–∞ (–≤–∏–¥–µ–Ω –º–∞—Ä–∫–µ—Ä) ‚Üí —Ç–∞–ø 2-—è —Ç–æ—á–∫–∞ = —Å–µ–≥–º–µ–Ω—Ç. –î–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç—Ä–µ–∑–∫–∞ —Å–Ω–æ–≤–∞ –Ω–∞–∂–º–∏ ¬´–õ–∏–Ω–∏—è¬ª. –ü–∏–Ω—á ‚Äî –∑—É–º; ¬´–†—É–∫–∞¬ª ‚Äî –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ.');

})();
</script>
</body>
</html>