<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>IsoWeb ‚Äî –ø—Ä–æ—Å—Ç–æ–π –∏ —Ç–æ—á–Ω—ã–π</title>
<style>
  :root{--violet:#7b2cff; --violet2:#5b1fe3}
  html,body{height:100%;margin:0;background:#f2f3f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  #cv{display:block;width:100vw;height:100vh;background:#fff;touch-action:none;user-select:none;-webkit-user-select:none}

  .bar{position:fixed;left:8px;right:8px;top:8px;z-index:10;display:flex;gap:8px;flex-wrap:wrap}
  .btn{height:40px;border:0;border-radius:12px;padding:0 12px;font-weight:800;cursor:pointer;background:linear-gradient(180deg,var(--violet2),var(--violet));color:#fff}
  .ghost{background:#fff;color:var(--violet);border:1px solid #d8c9ff}
  .warn{background:#ff3b3b;color:#fff}

  .panel{position:fixed;left:8px;right:8px;bottom:8px;background:#fff;border:1px solid #e7e3f7;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:12px;z-index:9}
  .row{display:flex;align-items:center;gap:10px}
  .row label{min-width:150px;font-size:13px;color:#555}
  .row input[type="range"]{flex:1;appearance:none;height:6px;border-radius:999px;background:#eee}
  .row input[type="range"]::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:var(--violet)}
  .val{width:48px;text-align:right;font-variant-numeric:tabular-nums;color:#666}

  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#1f1f2e;color:#fff;padding:8px 10px;border-radius:10px;opacity:0;transition:.2s;z-index:20}
  .toast.show{opacity:1}
</style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="bar">
    <button class="btn" id="bCamera">üì∑ –ö–∞–º–µ—Ä–∞</button>
    <button class="btn" id="bGallery">üìÇ –ì–∞–ª–µ—Ä–µ—è</button>
    <button class="btn" id="bLine">–õ–∏–Ω–∏—è</button>
    <button class="btn" id="bValve">–í–µ–Ω—Ç–∏–ª—å</button>
    <button class="btn ghost" id="bGrid">–°–µ—Ç–∫–∞</button>
    <button class="btn ghost" id="bFit">Fit</button>
    <button class="btn ghost" id="bUndo">–ù–∞–∑–∞–¥</button>
    <button class="btn warn" id="bClear">–û—á–∏—Å—Ç–∏—Ç—å</button>
  </div>

  <!-- –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞: —Ç–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏ -->
  <div class="panel">
    <div class="row">
      <label>–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏ (px)</label>
      <input id="lineWidth" type="range" min="2" max="24" value="6">
      <span class="val" id="lineWidthVal">6</span>
    </div>
  </div>

  <!-- –∏–Ω–ø—É—Ç—ã —Ñ–æ—Ç–æ (–∫–∞–º–µ—Ä–∞/–≥–∞–ª–µ—Ä–µ—è) -->
  <input id="fileCamera"  type="file" accept="image/*" capture="environment" hidden>
  <input id="fileGallery" type="file" accept="image/*" hidden>

  <div class="toast" id="toast"></div>

<script>
(()=>{
// ===== –¢–æ—á–Ω–æ—Å—Ç—å: –±–µ–∑ —Å–¥–≤–∏–≥–æ–≤ =====
const DPR = 1;                // —Ñ–∏–∫—Å ‚Äî –∫–∞—Å–∞–Ω–∏–µ = –ø–∏–∫—Å–µ–ª—å —ç–∫—Ä–∞–Ω–∞ (—Ç–æ—á–Ω–æ)
const VALVE_LEN_PX = 64;      // –¥–ª–∏–Ω–∞ ¬´–∫—É—Å–æ—á–∫–∞ —Ç—Ä—É–±—ã¬ª –≤–µ–Ω—Ç–∏–ª—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ
const VALVE_THICK_PX = 6;     // —Ç–æ–ª—â–∏–Ω–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ–π —Ç—Ä—É–±—ã —É –≤–µ–Ω—Ç–∏–ª—è
const MAX_IMG_SIDE = 2000;    // —á—Ç–æ–±—ã —Ñ–æ—Ç–æ –Ω–µ –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º —Ç—è–∂—ë–ª—ã–º

// ===== DOM/—Å–æ—Å—Ç–æ—è–Ω–∏–µ =====
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d', {alpha:false});
const toastEl = document.getElementById('toast');
const toast=(t,ms=900)=>{ toastEl.textContent=t; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),ms); };

const st = {
  mode:'idle',         // idle | line | valve
  first:null,          // –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞ –ª–∏–Ω–∏–∏ (–º–∏—Ä)
  segs:[],             // —Ç—Ä—É–±—ã: [{a:{x,y}, b:{x,y}}]
  valves:[],           // –≤–µ–Ω—Ç–∏–ª–∏: [{a:{x,y}, b:{x,y}}]
  grid:true,

  // –∫–∞–º–µ—Ä–∞/—Ö–æ–ª—Å—Ç
  s:1, cx:0, cy:0,

  // —Å—Ç–∏–ª—å
  lineWidth:6,

  // —Ñ–æ—Ç–æ-–ø–æ–¥–ª–æ–∂–∫–∞
  photo:{img:null, w:0, h:0, alpha:0.92}
};

// offscreen —Å–µ—Ç–∫–∞
let gridCv=document.createElement('canvas');
let gridDirty=true;

// ===== –†–∞–∑–º–µ—Ä =====
function resize(){
  cv.width = Math.floor(innerWidth*DPR);
  cv.height= Math.floor(innerHeight*DPR);
  if(st.cx===0&&st.cy===0){ st.cx=cv.width/2; st.cy=cv.height/2; st.s=1; }
  gridDirty=true; scheduleDraw();
}
addEventListener('resize', resize, {passive:true});
resize();

// ===== –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è =====
const w2s=(p)=>({x: st.cx + p.x*st.s, y: st.cy + p.y*st.s});
const s2w=(sx,sy)=>({x:(sx-st.cx)/st.s, y:(sy-st.cy)/st.s});

// ===== –°–µ—Ç–∫–∞ (–∫—ç—à) =====
function redrawGrid(){
  gridCv.width=cv.width; gridCv.height=cv.height;
  const g=gridCv.getContext('2d');
  g.clearRect(0,0,gridCv.width,gridCv.height);

  const step=200;          // —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —à–∞–≥
  const angles=[30,90,150];
  for(const ang of angles){
    const r=ang*Math.PI/180, vx=Math.cos(r), vy=Math.sin(r), px=-vy, py=vx;
    const stepScr=step*st.s;
    const need=Math.ceil(Math.max(cv.width,cv.height)/stepScr)+2;
    for(let k=-need;k<=need;k++){
      const bx=px*k*step, by=py*k*step;
      const A=w2s({x:bx - vx*20000, y:by - vy*20000});
      const B=w2s({x:bx + vx*20000, y:by + vy*20000});
      const major=(k%3===0);
      g.globalAlpha = major? 0.30 : 0.16;
      g.strokeStyle = major? '#c3c7d1' : '#e6eaf2';
      g.lineWidth   = major? 1.4 : 1.0;
      g.beginPath(); g.moveTo(A.x,A.y); g.lineTo(B.x,B.y); g.stroke();
    }
  }
  g.globalAlpha=1; gridDirty=false;
}

// ===== –§–æ—Ç–æ (–∫–∞–º–µ—Ä–∞/–≥–∞–ª–µ—Ä–µ—è) =====
function downscaleImage(img){
  const maxSide=Math.max(img.width,img.height);
  if(maxSide<=MAX_IMG_SIDE) return img;
  const scale=MAX_IMG_SIDE/maxSide, w=Math.round(img.width*scale), h=Math.round(img.height*scale);
  const off=document.createElement('canvas'); off.width=w; off.height=h;
  const ox=off.getContext('2d'); ox.imageSmoothingEnabled=true; ox.imageSmoothingQuality='high';
  ox.drawImage(img,0,0,w,h);
  const scaled=new Image(); scaled.src=off.toDataURL('image/jpeg',0.9); return scaled;
}
function loadFromFile(file){
  if(!file){ toast('–§–æ—Ç–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ'); return; }
  const url=URL.createObjectURL(file); const img=new Image();
  img.onload=()=>{
    URL.revokeObjectURL(url);
    const scaled=downscaleImage(img);
    if(scaled===img) applyImage(img); else scaled.onload=()=>applyImage(scaled);
  };
  img.src=url;
}
function applyImage(img){
  st.photo.img=img; st.photo.w=img.width; st.photo.h=img.height;
  // –ø–æ–¥–≥–æ–Ω –ø–æ–¥ —ç–∫—Ä–∞–Ω
  const sx=(cv.width /img.width )*0.9;
  const sy=(cv.height/img.height)*0.9;
  st.s = Math.max(0.2, Math.min(sx,sy)); // –º–∞—Å—à—Ç–∞–± –º–∏—Ä–∞
  st.cx=cv.width/2; st.cy=cv.height/2;
  gridDirty=true; scheduleDraw(); toast('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
}

// ===== –†–∏—Å–æ–≤–∞–Ω–∏–µ –≤–µ–Ω—Ç–∏–ª—è –≤ –≠–ö–†–ê–ù–ù–´–• –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö =====
function drawValveScreen(A,B){
  ctx.save();
  ctx.lineCap='round';
  ctx.strokeStyle='#7b2cff';
  ctx.lineWidth=VALVE_THICK_PX;
  ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();

  const ang=Math.atan2(B.y-A.y, B.x-A.x);
  const mid={x:(A.x+B.x)/2, y:(A.y+B.y)/2};
  ctx.translate(mid.x, mid.y); ctx.rotate(ang);

  const w=12, h=8; // ¬´–±–∞–±–æ—á–∫–∞¬ª
  ctx.fillStyle='#7b2cff'; ctx.strokeStyle='#4a21a8'; ctx.lineWidth=1.5;
  ctx.beginPath();
  ctx.moveTo(-w*0.5,0);
  ctx.lineTo(0,-h*0.68);
  ctx.lineTo(w*0.5,0);
  ctx.lineTo(0,h*0.68);
  ctx.closePath(); ctx.fill(); ctx.stroke();

  // —Ä—É—á–∫–∞ –≤–≤–µ—Ä—Ö
  ctx.strokeStyle='#111'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(0,-h*0.95); ctx.lineTo(0,-h*1.9); ctx.stroke();
  ctx.restore();
}

// ===== –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ü–µ–Ω—ã =====
let needs=false;
function scheduleDraw(){ if(!needs){ needs=true; requestAnimationFrame(draw);} }
function draw(){
  needs=false;
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,cv.width,cv.height);

  // —Ñ–æ—Ç–æ-–ø–æ–¥–ª–æ–∂–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
  if(st.photo.img){
    ctx.save();
    ctx.globalAlpha = st.photo.alpha;
    ctx.translate(st.cx, st.cy);
    ctx.scale(st.s, st.s);
    ctx.drawImage(st.photo.img, -st.photo.w/2, -st.photo.h/2, st.photo.w, st.photo.h);
    ctx.restore();
  }

  // —Å–µ—Ç–∫–∞
  if(st.grid){
    if(gridDirty) redrawGrid();
    ctx.drawImage(gridCv,0,0);
  }

  // —Ç—Ä—É–±—ã (–≤ –º–∏—Ä–µ ‚Üí –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Ç–æ–ª—â–∏–Ω–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ)
  ctx.save(); ctx.translate(st.cx,st.cy); ctx.scale(st.s,st.s);
  for(const s of st.segs){
    ctx.lineCap='round'; ctx.lineJoin='round';
    ctx.strokeStyle='#5b00bf'; ctx.lineWidth=(st.lineWidth+2)/st.s; ctx.globalAlpha=.7;
    ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
    ctx.strokeStyle='#7b2cff'; ctx.lineWidth=st.lineWidth/st.s; ctx.globalAlpha=1;
    ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
  }
  ctx.restore();

  // –≤–µ–Ω—Ç–∏–ª–∏ (—ç–∫—Ä–∞–Ω–Ω—ã–µ ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ç–æ–ª—â–∏–Ω–∞)
  for(const v of st.valves){ drawValveScreen(w2s(v.a), w2s(v.b)); }

  // –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ª–∏–Ω–∏–∏
  if(st.mode==='line' && st.first && lastPtr){
    const A=w2s(st.first), B=lastPtr;
    ctx.setLineDash([8,8]); ctx.strokeStyle='#16a34a'; ctx.lineWidth=Math.max(3,st.lineWidth-2);
    ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle='#16a34a'; ctx.strokeStyle='#fff'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(A.x,A.y,7,0,Math.PI*2); ctx.fill(); ctx.stroke();
  }
}

// ===== –ñ–µ—Å—Ç—ã (–ø–∞–Ω/–ø–∏–Ω—á/–∫–æ–ª–µ—Å–æ) =====
const pointers=new Map();
let lastPtr=null, panStart=null, pinch=null;

cv.addEventListener('pointerdown', e=>{
  cv.setPointerCapture?.(e.pointerId);
  const p={x:e.clientX*DPR,y:e.clientY*DPR};
  pointers.set(e.pointerId,p); lastPtr=p;

  if(pointers.size===1){
    if(st.mode==='line' && st.first){ /* –∂–¥—ë–º –≤—Ç–æ—Ä—É—é —Ç–æ—á–∫—É */ }
    else if(st.mode==='valve'){ /* —Å—Ç–∞–≤–∏–º –Ω–∞ pointerup */ }
    else { panStart={x:p.x,y:p.y,cx:st.cx,cy:st.cy}; }
  }

  if(pointers.size===2){
    const ids=[...pointers.keys()];
    const a=pointers.get(ids[0]), b=pointers.get(ids[1]);
    pinch={d0:Math.hypot(a.x-b.x,a.y-b.y), c:{x:(a.x+b.x)/2, y:(a.y+b.y)/2}};
  }
}, {passive:true});

cv.addEventListener('pointermove', e=>{
  if(!pointers.has(e.pointerId)) return;
  const cur={x:e.clientX*DPR,y:e.clientY*DPR};
  const prev=pointers.get(e.pointerId); pointers.set(e.pointerId,cur); lastPtr=cur;

  if(pointers.size===1){
    if(st.mode==='line' && st.first){ scheduleDraw(); return; }
    if(panStart){
      st.cx = panStart.cx + (cur.x-panStart.x);
      st.cy = panStart.cy + (cur.y-panStart.y);
      gridDirty=true; scheduleDraw();
    }
  }
  if(pointers.size===2 && pinch){
    const ids=[...pointers.keys()];
    const A=pointers.get(ids[0]), B=pointers.get(ids[1]);
    const d=Math.hypot(A.x-B.x, A.y-B.y);
    if(d>0){
      const f=d/pinch.d0;
      const sx=pinch.c.x, sy=pinch.c.y;
      const w=s2w(sx,sy);
      const nextS=Math.max(0.2, Math.min(8, st.s*f));
      st.cx = sx - w.x*nextS; st.cy = sy - w.y*nextS; st.s = nextS;
      pinch.d0=d; pinch.c={x:(A.x+B.x)/2, y:(A.y+B.y)/2};
      gridDirty=true; scheduleDraw();
    }
  }
}, {passive:true});

function endPtr(e){ pointers.delete(e.pointerId); lastPtr=(pointers.size===1)?[...pointers.values()][0]:null; if(pointers.size<2) pinch=null; }

cv.addEventListener('pointerup', e=>{
  endPtr(e);
  const sx=e.clientX*DPR, sy=e.clientY*DPR;

  if(st.mode==='line'){
    const w=s2w(sx,sy);
    if(!st.first){ st.first=w; toast('–ü–æ—Å—Ç–∞–≤—å –≤—Ç–æ—Ä—É—é —Ç–æ—á–∫—É'); }
    else{
      st.segs.push({a:st.first, b:w}); // –ë–ï–ó —Å–Ω–∞–ø–æ–≤ ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å
      st.first=null; toast('–õ–∏–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞');
    }
    scheduleDraw(); return;
  }

  if(st.mode==='valve'){
    // 1 —Ç–∞–ø: –∫–æ—Ä–æ—Ç–∫–∏–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç –≤ ¬´–º–∏—Ä–µ¬ª, –¥–ª–∏–Ω–∞ —Ñ–∏–∫—Å –≤ —ç–∫—Ä–∞–Ω–µ
    const centerW=s2w(sx,sy);
    const half = (VALVE_LEN_PX/2) / st.s; // —ç–∫—Ä–∞–Ω‚Üí–º–∏—Ä
    const a={x:centerW.x-half, y:centerW.y};
    const b={x:centerW.x+half, y:centerW.y};
    st.valves.push({a,b});
    st.mode='idle'; toast('–í–µ–Ω—Ç–∏–ª—å –¥–æ–±–∞–≤–ª–µ–Ω');
    scheduleDraw(); return;
  }
}, {passive:true});
cv.addEventListener('pointercancel', endPtr, {passive:true});

// –∫–æ–ª–µ—Å–æ (–¥–µ—Å–∫—Ç–æ–ø)
cv.addEventListener('wheel', e=>{
  e.preventDefault();
  const sx=e.clientX*DPR, sy=e.clientY*DPR;
  const f=e.deltaY<0?1.12:0.9;
  const w=s2w(sx,sy);
  const nextS=Math.max(0.2, Math.min(8, st.s*f));
  st.cx = sx - w.x*nextS; st.cy = sy - w.y*nextS; st.s = nextS;
  gridDirty=true; scheduleDraw();
}, {passive:false});

// ===== –ö–Ω–æ–ø–∫–∏ =====
const $=id=>document.getElementById(id);
$('bCamera').onclick = ()=>$('fileCamera').click();
$('bGallery').onclick= ()=>$('fileGallery').click();
$('fileCamera').onchange = e=> loadFromFile(e.target.files?.[0]);
$('fileGallery').onchange= e=> loadFromFile(e.target.files?.[0]);

$('bLine').onclick  = ()=>{ st.mode='line';  st.first=null; toast('–õ–∏–Ω–∏—è: 2 —Ç–∞–ø–∞'); };
$('bValve').onclick = ()=>{ st.mode='valve'; st.first=null; toast('–í–µ–Ω—Ç–∏–ª—å: 1 —Ç–∞–ø'); };
$('bGrid').onclick  = ()=>{ st.grid=!st.grid; scheduleDraw(); };
$('bFit').onclick   = ()=>{ st.s=1; st.cx=cv.width/2; st.cy=cv.height/2; gridDirty=true; scheduleDraw(); };
$('bUndo').onclick  = ()=>{ if(st.first){ st.first=null; } else if(st.valves.length) st.valves.pop(); else if(st.segs.length) st.segs.pop(); scheduleDraw(); };
$('bClear').onclick = ()=>{ st.segs.length=0; st.valves.length=0; st.first=null; scheduleDraw(); };

// ===== –°–ª–∞–π–¥–µ—Ä —Ç–æ–ª—â–∏–Ω—ã =====
const lineWidthEl=document.getElementById('lineWidth');
const lineWidthVal=document.getElementById('lineWidthVal');
const applyLW=()=>{ st.lineWidth=+lineWidthEl.value; lineWidthVal.textContent=String(st.lineWidth); scheduleDraw(); };
lineWidthEl.addEventListener('input', applyLW, {passive:true});
applyLW();

// —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
scheduleDraw();
})();
</script>
</body>
</html>