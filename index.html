<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Isoweb ‚Äî —Ñ–æ—Ç–æ + —Ä–∞–∑–º–µ—Ç–∫–∞ —Ç—Ä—É–±</title>
<style>
  :root { --bg:#0d0d0f; --panel:#1c1f26; --btn:#2b2f39; --txt:#eaecef; --accent:#6b8cff; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif;overflow:hidden}
  #wrap{position:fixed;inset:0;overflow:hidden}
  /* WebGL —Å–ª–æ–π (—Ñ–æ—Ç–æ+—Å–µ—Ç–∫–∞) */
  #gl{position:absolute;inset:0}
  /* 2D-—Å–ª–æ–π –¥–ª—è —Ä–∞–∑–º–µ—Ç–∫–∏ */
  #draw{position:absolute;inset:0;touch-action:none}
  /* –ü–∞–Ω–µ–ª—å */
  #bar{position:absolute;left:12px;top:12px;z-index:10;display:flex;gap:10px;flex-wrap:wrap}
  .btn{background:var(--btn);border:1px solid rgba(255,255,255,.08);border-radius:12px;color:var(--txt);
       padding:10px 14px;font-weight:700}
  .btn.primary{background:linear-gradient(180deg,#7aa2ff,#5a7bff);color:#fff;border:none}
  /* –°—Ç–∞—Ç—É—Å */
  #status{position:absolute;left:10px;bottom:10px;background:#0a0a0c;border:1px solid rgba(255,255,255,.08);
          color:#7cff78;border-radius:10px;padding:6px 10px;font-size:12px;z-index:10}
  /* –¢–æ–Ω–∫–∞—è —Å–µ—Ç–∫–∞ –ø–æ–≤–µ—Ä—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
  #grid2d{pointer-events:none;position:absolute;inset:0;opacity:.25}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="gl"></canvas>
  <canvas id="draw"></canvas>
  <svg id="grid2d"></svg>

  <div id="bar">
    <button class="btn" id="btnPhoto">üì∑ –§–æ—Ç–æ</button>
    <button class="btn" id="btnErasePhoto">üßπ –£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω</button>
    <button class="btn" id="btnCenter">üéØ –¶–µ–Ω—Ç—Ä</button>
    <button class="btn primary" id="btnLine">üìê –õ–∏–Ω–∏—è</button>
    <button class="btn" id="btnUndo">‚Ü©Ô∏è –ù–∞–∑–∞–¥</button>
    <input type="file" id="fileInput" accept="image/*" style="display:none" />
  </div>

  <div id="status">–°—Ç–∞—Ç—É—Å: –∑–∞–≥—Ä—É–∂–∞—é 3D‚Ä¶</div>
</div>

<!-- three.js —Å jsDelivr -->
<script src="https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.1/examples/js/controls/OrbitControls.js"></script>
<script>
(()=>{'use strict';
const DPR=Math.min(2, Math.max(1, devicePixelRatio||1));
const gl=document.getElementById('gl');
const draw=document.getElementById('draw');
const grid2d=document.getElementById('grid2d');
const statusEl=document.getElementById('status');

const setStatus = (t)=> statusEl.textContent = '–°—Ç–∞—Ç—É—Å: ' + t;

/* ===== THREE —Å—Ü–µ–Ω–∞: —Å–µ—Ç–∫–∞ + —Ñ–æ—Ç–æ –∫–∞–∫ –ø–ª–æ—Å–∫–æ—Å—Ç—å ===== */
let scene,camera,renderer,controls,grid3d,axes,photoMesh=null;

function init3D(){
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 2000);
  camera.position.set(0,2.5,7);

  renderer=new THREE.WebGLRenderer({canvas:gl,antialias:true,alpha:false});
  renderer.setPixelRatio(DPR);
  renderer.setSize(innerWidth,innerHeight,false);
  renderer.setClearColor(0x0d0d0f,1);

  controls=new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping=true; controls.dampingFactor=0.08;

  grid3d=new THREE.GridHelper(20, 40, 0x444444, 0x444444);
  scene.add(grid3d);

  axes=new THREE.AxesHelper(3);
  scene.add(axes);

  animate();
  setStatus('3D –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
}
function animate(){ requestAnimationFrame(animate); renderer.render(scene,camera); }
function centerCam(){
  camera.position.set(0,2.5,7);
  controls.target.set(0,0,0);
  controls.update();
}

/* ===== –§–æ—Ç–æ –∫–∞–∫ —Ç–µ–∫—Å—Ç—É—Ä–∞ –Ω–∞ –ø–ª–æ—Å–∫–æ—Å—Ç–∏ ===== */
function placePhoto(dataUrl){
  const loader=new THREE.TextureLoader();
  loader.load(dataUrl,(tex)=>{
    // –ø–æ–¥–≥–æ–Ω—è–µ–º –ø–ª–æ—Å–∫–æ—Å—Ç—å –ø–æ–¥ —ç–∫—Ä–∞–Ω–Ω—ã–π –∞—Å–ø–µ–∫—Ç
    const w=10, h=10; // 10√ó10 —É—Å–ª–æ–≤–Ω–æ ‚Äî –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø—Ä–æ—Å—Ç–æ —Ñ–æ–Ω
    const geo=new THREE.PlaneGeometry(w,h);
    const mat=new THREE.MeshBasicMaterial({map:tex, side:THREE.DoubleSide});
    if(photoMesh){ scene.remove(photoMesh); photoMesh.geometry.dispose(); photoMesh.material.dispose(); }
    photoMesh=new THREE.Mesh(geo,mat);
    photoMesh.position.set(0,0,-0.02); // –Ω–∞ —Ñ–æ–Ω–µ –ø–æ–∑–∞–¥–∏ —Å–µ—Ç–∫–∏
    scene.add(photoMesh);
    setStatus('‚úÖ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
  },()=>{},(err)=>{ setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ'); console.error(err); });
}
function removePhoto(){
  if(photoMesh){
    scene.remove(photoMesh);
    photoMesh.geometry.dispose();
    photoMesh.material.dispose();
    photoMesh=null;
    setStatus('–§–æ–Ω —É–¥–∞–ª—ë–Ω');
  }
}

/* ===== 2D-—Ä–∏—Å–æ–≤–∞–Ω–∏–µ –ø–æ–≤–µ—Ä—Ö (–æ–¥–∏–Ω –æ—Ç—Ä–µ–∑–æ–∫ –∑–∞ —Ü–∏–∫–ª) ===== */
const ctx = draw.getContext('2d');
const segs=[];   // {a:{x,y}, b:{x,y}}
let tool='idle'; // 'idle' | 'awaitFirst' | 'awaitSecond'
let first=null;  // {x,y}
let preview=null;

function fitCanvases(){
  const w=Math.round(innerWidth*DPR), h=Math.round(innerHeight*DPR);
  // WebGL —Ä–∞–∑–º–µ—Ä —É–∂–µ –≤—ã—Å—Ç–∞–≤–∏–ª–∏ –≤ init; –Ω–æ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ –æ–±–Ω–æ–≤–∏–º:
  renderer.setSize(innerWidth, innerHeight, false);
  // 2D
  draw.width=w; draw.height=h;
  draw.style.width=innerWidth+'px'; draw.style.height=innerHeight+'px';
  // SVG-—Å–µ—Ç–∫–∞ (—Ç–æ–Ω–∫–∞—è —ç–∫—Ä–∞–Ω–∏—Ä—É—é—â–∞—è —Å–µ—Ç–∫–∞ –ø–æ —ç–∫—Ä–∞–Ω—É)
  grid2d.setAttribute('width', innerWidth);
  grid2d.setAttribute('height', innerHeight);
  grid2d.innerHTML='';
  const step=40;
  for(let x=0;x<=innerWidth;x+=step){
    const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1',x); ln.setAttribute('y1',0);
    ln.setAttribute('x2',x); ln.setAttribute('y2',innerHeight);
    ln.setAttribute('stroke','#7c7c7c'); ln.setAttribute('stroke-width','1');
    grid2d.appendChild(ln);
  }
  for(let y=0;y<=innerHeight;y+=step){
    const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1',0); ln.setAttribute('y1',y);
    ln.setAttribute('x2',innerWidth); ln.setAttribute('y2',y);
    ln.setAttribute('stroke','#7c7c7c'); ln.setAttribute('stroke-width','1');
    grid2d.appendChild(ln);
  }
  redraw();
}
addEventListener('resize', fitCanvases);

function redraw(){
  // –æ—á–∏—Å—Ç–∫–∞
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,draw.width,draw.height);

  // –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã
  ctx.lineCap='round'; ctx.lineJoin='round';
  for(const s of segs){
    ctx.strokeStyle='#1f6bff';
    ctx.lineWidth=10*DPR;
    ctx.beginPath(); ctx.moveTo(s.a.x, s.a.y); ctx.lineTo(s.b.x, s.b.y); ctx.stroke();
    // —Ç–µ–Ω—å
    ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.lineWidth= (10*DPR)+4;
  }

  // –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
  if(tool==='awaitSecond' && first && preview){
    ctx.strokeStyle='#1f6bff';
    ctx.lineWidth=10*DPR;
    ctx.beginPath(); ctx.moveTo(first.x, first.y); ctx.lineTo(preview.x, preview.y); ctx.stroke();
  }
  // –≤–∏–¥–∏–º–∞—è 1-—è —Ç–æ—á–∫–∞
  if(first){
    ctx.fillStyle='#ff3b30';
    ctx.beginPath(); ctx.arc(first.x, first.y, 6*DPR, 0, Math.PI*2); ctx.fill();
  }
}

// –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —É–∫–∞–∑–∞—Ç–µ–ª—è -> –ø–∏–∫—Å–µ–ª–∏ canvas
function pos(e){
  const r=draw.getBoundingClientRect();
  const sx=(e.clientX - r.left) * (draw.width/r.width);
  const sy=(e.clientY - r.top)  * (draw.height/r.height);
  return {x:sx, y:sy};
}

// –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
draw.addEventListener('pointerdown', (e)=>{
  // –µ—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –ª–∏–Ω–∏–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–¥–∞—ë–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–µ
  if(tool==='idle'){ return; }
  e.preventDefault();
  const p=pos(e);
  if(tool==='awaitFirst'){
    first=p; preview=null; tool='awaitSecond';
    setStatus('1-—è —Ç–æ—á–∫–∞ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ ‚Äî —Ç–∫–Ω–∏ 2-—é');
    redraw(); return;
  }
  if(tool==='awaitSecond'){
    preview=p;
    segs.push({a:first, b:preview});
    first=null; preview=null;
    tool='idle';
    setStatus('–°–µ–≥–º–µ–Ω—Ç –≥–æ—Ç–æ–≤. –ß—Ç–æ–±—ã –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –µ—â—ë ‚Äî —Å–Ω–æ–≤–∞ –Ω–∞–∂–º–∏ ¬´–õ–∏–Ω–∏—è¬ª.');
    redraw(); return;
  }
},{passive:false});

draw.addEventListener('pointermove', (e)=>{
  if(tool!=='awaitSecond' || !first) return;
  preview=pos(e); redraw();
},{passive:true});

/* ===== –ö–Ω–æ–ø–∫–∏ ===== */
const $=id=>document.getElementById(id);

$('btnPhoto').onclick=()=> $('fileInput').click();
$('fileInput').onchange=(ev)=>{
  const file=ev.target.files[0]; if(!file) return;
  const fr=new FileReader();
  fr.onload=(e)=> placePhoto(e.target.result);
  fr.readAsDataURL(file);
};

$('btnErasePhoto').onclick = removePhoto;
$('btnCenter').onclick = centerCam;

$('btnLine').onclick = ()=>{
  tool='awaitFirst'; first=null; preview=null;
  setStatus('–†–µ–∂–∏–º –õ–∏–Ω–∏—è: —Ç–∫–Ω–∏ 1-—é —Ç–æ—á–∫—É');
};

$('btnUndo').onclick = ()=>{
  if(tool==='awaitSecond' && first){ first=null; preview=null; tool='idle'; setStatus('–û—Ç–º–µ–Ω–µ–Ω–æ'); redraw(); return; }
  if(segs.length){ segs.pop(); redraw(); setStatus('–£–¥–∞–ª—ë–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç'); }
};

init3D();
fitCanvases();
})();
</script>
</body>
</html>